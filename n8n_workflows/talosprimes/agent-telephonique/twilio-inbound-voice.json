{
  "name": "twilio-inbound-voice",
  "nodes": [
    {
      "parameters": {
        "path": "twilio-inbound-voice",
        "responseMode": "responseNode",
        "httpMethod": "POST",
        "options": {
          "rawBody": true
        }
      },
      "id": "01. Webhook Twilio",
      "name": "01. Webhook Twilio",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        100,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Parse Twilio webhook payload (form-urlencoded) avec validation anti-injection\nvar data = $input.first().json;\nvar body = data.body || data;\n\n// Regex de validation pour les champs Twilio\nvar CALLSID_RE = /^CA[0-9a-f]{32}$/i;\nvar PHONE_RE = /^\\+?[0-9]{6,15}$/;\n\n// Nettoyer : ne garder que les caractères attendus\nfunction sanitizePhone(p) { return String(p || '').replace(/[^+0-9]/g, '').substring(0, 16); }\nfunction sanitizeCallSid(s) { return String(s || '').replace(/[^a-zA-Z0-9]/g, '').substring(0, 34); }\nfunction sanitizeText(t) { return String(t || '').replace(/'/g, \"''\").substring(0, 2000); }\n\nvar callSid = sanitizeCallSid(body.CallSid);\nvar from = sanitizePhone(body.From);\nvar to = sanitizePhone(body.To);\nvar callStatus = String(body.CallStatus || '').replace(/[^a-z-]/gi, '').substring(0, 30);\nvar speechResult = sanitizeText(body.SpeechResult);\nvar digits = String(body.Digits || '').replace(/[^0-9*#]/g, '').substring(0, 20);\nvar isCallback = !!speechResult || !!digits;\n\nreturn [{json: {\n  callSid,\n  from,\n  to,\n  callStatus,\n  speechResult,\n  digits,\n  isCallback\n}}];"
      },
      "id": "02. Parser Twilio",
      "name": "02. Parser Twilio",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        300,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": ""
          },
          "conditions": [
            {
              "id": "7e6c6ac2-d2e7-43a0-a1d5-258f94c0310c",
              "leftValue": "={{ $json.isCallback }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "03. Is Callback?",
      "name": "03. Is Callback?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        500,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Premier appel : message d\\u0027accueil + Gather\nvar callSid = $('02. Parser Twilio').first().json.callSid;\nvar from = $('02. Parser Twilio').first().json.from;\n\nvar twiml = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Response>\n  <Say voice=\"Polly.Lea-Neural\" language=\"fr-FR\">TalosPrimes, bonjour ! Comment puis-je vous aider ?</Say>\n  <Gather input=\"speech\" language=\"fr-FR\" speechTimeout=\"3\" timeout=\"15\" action=\"https://n8n.talosprimes.com/webhook/twilio-inbound-voice\" method=\"POST\"/>\n  <Say voice=\"Polly.Lea-Neural\" language=\"fr-FR\">Je n\\u0027ai pas entendu votre réponse de réponse. Au revoir !</Say>\n</Response>`;\n\nreturn [{ json: { twiml, callSid, from } }];"
      },
      "id": "04. Welcome TwiML",
      "name": "04. Welcome TwiML",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        700,
        450
      ]
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $json.twiml }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "text/xml; charset=utf-8"
              }
            ]
          }
        }
      },
      "id": "05. Respond Welcome",
      "name": "05. Respond Welcome",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        900,
        450
      ]
    },
    {
      "parameters": {
        "jsCode": "// Callback avec SpeechResult\nvar prev = $('02. Parser Twilio').first().json;\nvar speechResult = prev.speechResult;\nvar callSid = prev.callSid;\nvar from = prev.from;\n\nif (!speechResult || speechResult.trim() === '') {\n  return [{json: { callSid, from, speechResult: '', hasText: false }}];\n}\n\nreturn [{json: { callSid, from, speechResult: speechResult.trim(), hasText: true }}];"
      },
      "id": "06. Extract Speech",
      "name": "06. Extract Speech",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        700,
        200
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": ""
          },
          "conditions": [
            {
              "id": "e98da725-c807-4c0c-9c14-f309f75f7221",
              "leftValue": "={{ $json.hasText }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "07. Has Text?",
      "name": "07. Has Text?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        900,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "// Pas de texte détecté, on relance l ecoute\nvar twiml = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Response>\n  <Say voice=\"Polly.Lea-Neural\" language=\"fr-FR\">Excusez-moi, Je n\\u0027ai pas bien compris. Pouvez-vous répéter ?</Say>\n  <Gather input=\"speech\" language=\"fr-FR\" speechTimeout=\"3\" timeout=\"15\" action=\"https://n8n.talosprimes.com/webhook/twilio-inbound-voice\" method=\"POST\"/>\n  <Say voice=\"Polly.Lea-Neural\" language=\"fr-FR\">Au revoir.</Say>\n</Response>`;\n\nreturn [{ json: { twiml } }];"
      },
      "id": "08. No Text TwiML",
      "name": "08. No Text TwiML",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1100,
        100
      ]
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $json.twiml }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "text/xml; charset=utf-8"
              }
            ]
          }
        }
      },
      "id": "09. Respond No Text",
      "name": "09. Respond No Text",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1300,
        100
      ]
    },
    {
      "parameters": {
        "jsCode": "// Mode admin désactivé — tout en mode standard\nvar speechResult = $('06. Extract Speech').first().json.speechResult;\nvar callSid = $('06. Extract Speech').first().json.callSid;\nvar from = $('06. Extract Speech').first().json.from;\n\nreturn [{ json: {\n  callSid,\n  from,\n  speechResult,\n  isAdminPhrase: false,\n  isAdminByPhone: false,\n  mode: 'standard'\n} }];"
      },
      "id": "10. Detect Admin",
      "name": "10. Detect Admin",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1100,
        250
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ \"SELECT tc.tenant_id, cf.id, cf.nom, cf.prenom, cf.email, cf.telephone, cf.raison_sociale FROM twilio_configs tc LEFT JOIN client_finals cf ON cf.telephone LIKE '%' || RIGHT('\" + $('02. Parser Twilio').first().json.from + \"', 9) || '%' WHERE tc.phone_number LIKE '%' || RIGHT('\" + $('02. Parser Twilio').first().json.to + \"', 9) || '%' LIMIT 1\" }}",
        "options": {
          "alwaysOutputData": true
        }
      },
      "id": "11. Get Session",
      "name": "11. Get Session",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "credentials": {
        "postgres": {
          "name": "Supabase Postgres",
          "id": "OGqj65ZoFRileCck"
        }
      },
      "position": [
        1300,
        250
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ \"SELECT categorie, titre, contenu, mots_cles FROM agent_knowledge_entries WHERE tenant_id = '\" + ($('11. Get Session').first().json.tenant_id || '') + \"' AND actif = true ORDER BY categorie ASC, ordre ASC, created_at DESC\" }}",
        "options": {
          "alwaysOutputData": true
        }
      },
      "id": "11b. Load Knowledge",
      "name": "11b. Load Knowledge",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "credentials": {
        "postgres": {
          "name": "Supabase Postgres",
          "id": "OGqj65ZoFRileCck"
        }
      },
      "position": [
        1350,
        330
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// Construire le prompt avec FAQ + historique + tools — ZERO FALLBACK\nvar prev = $('10. Detect Admin').first().json;\nvar session = $('11. Get Session').first().json;\nif (!session || !session.tenant_id) throw new Error('Get Session: tenant_id manquant. Verifier que le numero Twilio est bien configure.');\nvar speechResult = prev.speechResult;\nvar callSid = prev.callSid;\nvar from = prev.from;\nvar clientName = session.nom || '';\nvar clientPrenom = session.prenom || '';\nvar clientEmail = session.email || '';\nvar clientId = session.id || '';\nvar tenantId = session.tenant_id;\n\n// Info client\nvar clientInfo = '';\nif (clientName) {\n  clientInfo = 'CLIENT IDENTIFIE: ' + clientPrenom + ' ' + clientName;\n  if (clientEmail) clientInfo += ' (email: ' + clientEmail + ')';\n  clientInfo += '. ID: ' + clientId;\n  clientInfo += '\\nCe client est deja dans notre base. Tu peux le saluer par son prenom.';\n} else {\n  clientInfo = 'APPELANT NON IDENTIFIE dans notre base. Numero: ' + from;\n  clientInfo += '\\nC est probablement un prospect. Commence par te presenter puis demande comment tu peux aider.';\n}\n\n// Historique de conversation — pas de try/catch, pas de fallback\nvar conversationHistory = '';\nvar historyItems = $('20. Load History').all();\nvar exchanges = [];\nfor (var i = 0; i < historyItems.length; i++) {\n  var item = historyItems[i];\n  var notes = '';\n  if (item && item.json && item.json.notes) {\n    notes = String(item.json.notes);\n  } else if (item && item.notes) {\n    notes = String(item.notes);\n  }\n  if (!notes) continue;\n  var qMatch = notes.match(/Q: (.+?) - R: /);\n  var rMatch = notes.match(/R: (.+)$/);\n  if (qMatch && rMatch) {\n    exchanges.push('Appelant: ' + qMatch[1] + '\\nLea: ' + rMatch[1]);\n  }\n}\nif (exchanges.length > 0) {\n  conversationHistory = '\\n--- HISTORIQUE DE LA CONVERSATION ---\\n' + exchanges.join('\\n') + '\\n--- FIN HISTORIQUE ---\\n';\n}\n\n// FAQ depuis la base de connaissances — pas de try/catch, pas de fallback\nvar faqContext = '';\nvar knowledgeItems = $('11b. Load Knowledge').all();\nif (!knowledgeItems || knowledgeItems.length === 0) throw new Error('Load Knowledge: aucune donnee retournee. Verifier la requete SQL et la table agent_knowledge_entries pour tenant ' + tenantId);\nvar byCategorie = {};\nvar hasRealData = false;\nfor (var i = 0; i < knowledgeItems.length; i++) {\n  var row = knowledgeItems[i];\n  var data = (row && row.json) ? row.json : row;\n  if (!data || !data.contenu) continue;\n  hasRealData = true;\n  var cat = data.categorie || 'autre';\n  if (!byCategorie[cat]) byCategorie[cat] = [];\n  byCategorie[cat].push(data);\n}\nif (!hasRealData) throw new Error('Load Knowledge: les items existent mais aucun ne contient de champ contenu. Verifier la structure des donnees pour tenant ' + tenantId);\nvar catLabels = {\n  'info_entreprise': 'INFORMATIONS ENTREPRISE',\n  'services': 'MODULES ET SERVICES',\n  'tarifs': 'TARIFICATION',\n  'faq': 'FAQ',\n  'politiques': 'POLITIQUES',\n  'actions': 'ACTIONS POSSIBLES',\n  'autre': 'AUTRE'\n};\nvar sections = [];\nvar catOrder = ['info_entreprise', 'services', 'tarifs', 'faq', 'politiques', 'actions', 'autre'];\nfor (var j = 0; j < catOrder.length; j++) {\n  var c = catOrder[j];\n  if (byCategorie[c] && byCategorie[c].length > 0) {\n    var lines = [];\n    for (var k = 0; k < byCategorie[c].length; k++) {\n      var entry = byCategorie[c][k];\n      lines.push('- ' + (entry.titre || '') + ': ' + (entry.contenu || ''));\n    }\n    sections.push(catLabels[c] + ':\\n' + lines.join('\\n'));\n  }\n}\nfaqContext = sections.join('\\n\\n');\nif (!faqContext) throw new Error('Load Knowledge: faqContext vide apres construction. Donnees presentes mais aucune section generee pour tenant ' + tenantId);\n\n// Construire le prompt systeme — PROMPT AVANCE\nvar systemPrompt = ''\n+ '=== IDENTITE ===\\n'\n+ 'Tu es Lea, assistante virtuelle de TalosPrimes, la plateforme tout-en-un de gestion pour les entreprises.\\n'\n+ 'Tu es chaleureuse, professionnelle, efficace. Tu parles comme une vraie personne au telephone.\\n'\n+ 'Tu vouvoies TOUJOURS.\\n\\n'\n\n+ '=== CONTEXTE APPEL ===\\n'\n+ clientInfo + '\\n'\n+ conversationHistory + '\\n'\n\n+ '=== BASE DE CONNAISSANCES ===\\n'\n+ faqContext + '\\n\\n'\n\n+ '=== TES CAPACITES (OUTILS) ===\\n'\n+ 'Tu disposes de VRAIS outils pour agir directement. Utilise-les des que pertinent:\\n'\n+ '- create_lead: Enregistrer un nouveau prospect (nom + telephone minimum)\\n'\n+ '- search_client: Chercher un client existant par nom ou telephone\\n'\n+ '- create_client: Creer un compte client complet (email obligatoire)\\n'\n+ '- create_invoice: Creer une facture/devis pour un client\\n'\n+ '- create_bon_commande: Creer un bon de commande\\n'\n+ '- list_recent_leads: Consulter les derniers prospects\\n'\n+ '- list_clients: Consulter la liste des clients\\n'\n+ '- list_invoices: Consulter les factures\\n'\n+ '- update_lead: Modifier un prospect (statut, notes, etc.)\\n'\n+ '- update_client: Modifier un client\\n'\n+ '- update_invoice_status: Changer le statut d une facture\\n'\n+ '- schedule_callback: Planifier un rappel immediat — utilise quand le client dit \"rappelez-moi\", \"je suis occupe\", \"je ne peux pas parler\"\\n\\n'\n\n+ '=== PARCOURS PROSPECT (nouveau appelant) ===\\n'\n+ '1. ACCUEIL: \"Bonjour, ici Lea de TalosPrimes, comment puis-je vous aider ?\"\\n'\n+ '2. ECOUTE: Laisse l appelant expliquer son besoin. Ne l interromps pas.\\n'\n+ '3. QUALIFICATION: Pose UNE question a la fois pour comprendre:\\n'\n+ '   - Quel est son secteur d activite ?\\n'\n+ '   - Combien de personnes dans l equipe ?\\n'\n+ '   - Quels sont ses besoins principaux (facturation, comptabilite, gestion equipe, etc.) ?\\n'\n+ '4. PRESENTATION: Presente les modules adaptes a son besoin (PAS tous les modules)\\n'\n+ '5. COLLECTE: Demande ses coordonnees pour le recontacter:\\n'\n+ '   - \"Puis-je avoir votre nom ?\" → attendre reponse\\n'\n+ '   - \"Et votre prenom ?\" → attendre reponse\\n'\n+ '   - \"Avez-vous une adresse email ?\" → attendre reponse\\n'\n+ '   - Le telephone est deja connu (numero d appel)\\n'\n+ '6. ENREGISTREMENT: Utilise create_lead avec toutes les infos collectees + notes sur le besoin\\n'\n+ '7. CONCLUSION: \"Merci [prenom], je vous ai enregistre. Notre equipe vous recontactera sous 24h pour vous presenter la solution en detail.\"\\n\\n'\n\n+ '=== PARCOURS CLIENT EXISTANT ===\\n'\n+ '1. ACCUEIL: \"Bonjour [prenom], comment puis-je vous aider aujourd hui ?\"\\n'\n+ '2. ECOUTE du besoin\\n'\n+ '3. ACTION selon le besoin:\\n'\n+ '   - Question simple → Reponds avec la base de connaissances\\n'\n+ '   - Demande de devis → Collecte les details et utilise create_invoice\\n'\n+ '   - Probleme technique → Note le probleme, dis que le support le recontactera\\n'\n+ '   - Modification compte → Utilise update_client\\n'\n+ '   - Consultation factures → Utilise list_invoices\\n\\n'\n\n+ '=== CREATION DE DEVIS ===\\n'\n+ 'Quand un client ou prospect demande un devis:\\n'\n+ '1. Demande: \"Pour quel type de prestation souhaitez-vous un devis ?\"\\n'\n+ '2. Demande: \"Quel est le montant hors taxes souhaite ?\" (ou aide a estimer)\\n'\n+ '3. Confirme: \"Donc un devis de [montant] euros HT pour [description], c est bien ca ?\"\\n'\n+ '4. Si confirme → utilise create_invoice avec les details\\n'\n+ '5. Annonce: \"Votre devis est cree, vous le recevrez par email.\"\\n\\n'\n\n+ '=== REGLES ABSOLUES ===\\n'\n+ '1. Maximum 3 phrases par reponse, courtes et naturelles\\n'\n+ '2. JAMAIS de listes, de formatage, de markdown — tu PARLES\\n'\n+ '3. UNE seule question a la fois, attends la reponse\\n'\n+ '4. Ne repete JAMAIS la meme question\\n'\n+ '5. JAMAIS dire \"contactez un administrateur\" ou \"je ne peux pas\" — TU ES le point de contact\\n'\n+ '6. Si tu ne sais pas → \"Je note votre demande, un collegue specialise vous recontactera sous 24h\"\\n'\n+ '7. Utilise les outils PROACTIVEMENT — ne demande pas la permission pour creer un lead ou chercher un client\\n'\n+ '8. Quand tu as assez d infos pour un lead → cree-le IMMEDIATEMENT, ne demande pas \"voulez-vous que je vous enregistre\"\\n'\n+ '9. Adapte ton discours: si prospect → vends la solution. Si client → resous son probleme.\\n'\n+ '10. Finis TOUJOURS par une action concrete: lead cree, devis envoye, rappel planifie, etc.\\n';\n\n// Tools disponibles — TOUS les outils que le node 21 peut traiter\nvar tools = [\n  {\n    type: \"function\",\n    function: {\n      name: \"create_lead\",\n      description: \"Enregistrer un nouveau prospect dans le CRM. Utilise cet outil des que tu as le nom et le telephone d un prospect interesse.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          nom: { type: \"string\", description: \"Nom de famille du prospect\" },\n          prenom: { type: \"string\", description: \"Prenom du prospect\" },\n          email: { type: \"string\", description: \"Adresse email si fournie\" },\n          telephone: { type: \"string\", description: \"Numero de telephone (utilise le numero d appel si pas specifie)\" },\n          notes: { type: \"string\", description: \"Resume du besoin exprime par le prospect\" }\n        },\n        required: [\"nom\", \"telephone\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"search_client\",\n      description: \"Rechercher un client existant par nom, prenom, telephone ou email. Utilise en debut de conversation pour verifier si l appelant est deja client.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          query: { type: \"string\", description: \"Nom, prenom, telephone ou email a rechercher\" }\n        },\n        required: [\"query\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"create_client\",\n      description: \"Creer un compte client complet dans la plateforme. Pour les prospects qui deviennent clients apres validation.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          nom: { type: \"string\", description: \"Nom de famille\" },\n          prenom: { type: \"string\", description: \"Prenom\" },\n          email: { type: \"string\", description: \"Email obligatoire pour le compte client\" },\n          telephone: { type: \"string\", description: \"Telephone\" },\n          type: { type: \"string\", enum: [\"b2b\", \"b2c\"], description: \"Type de client: b2b (entreprise) ou b2c (particulier)\" },\n          raison_sociale: { type: \"string\", description: \"Nom de l entreprise (si b2b)\" }\n        },\n        required: [\"email\", \"nom\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"create_invoice\",\n      description: \"Creer une facture ou un devis pour un client existant. Demande le montant HT et la description au client.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          client_name_or_phone: { type: \"string\", description: \"Nom ou telephone du client\" },\n          montant_ht: { type: \"number\", description: \"Montant hors taxes en euros\" },\n          tva_taux: { type: \"number\", description: \"Taux de TVA en pourcentage (defaut: 20)\" },\n          description: { type: \"string\", description: \"Description de la prestation\" }\n        },\n        required: [\"client_name_or_phone\", \"montant_ht\", \"description\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"create_bon_commande\",\n      description: \"Creer un bon de commande pour un client.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          client_name_or_phone: { type: \"string\", description: \"Nom ou telephone du client\" },\n          montant_ht: { type: \"number\", description: \"Montant hors taxes\" },\n          tva_taux: { type: \"number\", description: \"Taux de TVA (defaut: 20)\" },\n          description: { type: \"string\", description: \"Description de la commande\" }\n        },\n        required: [\"client_name_or_phone\", \"montant_ht\", \"description\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"list_recent_leads\",\n      description: \"Consulter les derniers prospects enregistres.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          limit: { type: \"number\", description: \"Nombre de resultats (max 20)\" },\n          statut: { type: \"string\", enum: [\"nouveau\", \"contacte\", \"converti\", \"abandonne\"], description: \"Filtrer par statut\" }\n        }\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"list_clients\",\n      description: \"Consulter la liste des clients.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          limit: { type: \"number\", description: \"Nombre de resultats (max 50)\" },\n          statut: { type: \"string\", enum: [\"actif\", \"inactif\", \"suspendu\"], description: \"Filtrer par statut\" },\n          type: { type: \"string\", enum: [\"b2b\", \"b2c\"], description: \"Filtrer par type\" }\n        }\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"list_invoices\",\n      description: \"Consulter les factures existantes.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          limit: { type: \"number\", description: \"Nombre de resultats (max 50)\" },\n          statut: { type: \"string\", enum: [\"brouillon\", \"envoyee\", \"payee\", \"en_retard\", \"annulee\"], description: \"Filtrer par statut\" }\n        }\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"update_lead\",\n      description: \"Modifier les informations d un prospect existant.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          lead_id_or_phone: { type: \"string\", description: \"ID ou telephone du prospect\" },\n          statut: { type: \"string\", enum: [\"nouveau\", \"contacte\", \"converti\", \"abandonne\"] },\n          notes: { type: \"string\", description: \"Notes a ajouter\" },\n          nom: { type: \"string\" },\n          email: { type: \"string\" }\n        },\n        required: [\"lead_id_or_phone\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"update_client\",\n      description: \"Modifier les informations d un client.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          client_id_or_name: { type: \"string\", description: \"ID ou nom du client\" },\n          nom: { type: \"string\" },\n          email: { type: \"string\" },\n          telephone: { type: \"string\" },\n          statut: { type: \"string\", enum: [\"actif\", \"inactif\", \"suspendu\"] }\n        },\n        required: [\"client_id_or_name\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"update_invoice_status\",\n      description: \"Changer le statut d une facture.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          invoice_id_or_number: { type: \"string\", description: \"ID ou numero de facture\" },\n          statut: { type: \"string\", enum: [\"brouillon\", \"envoyee\", \"payee\", \"en_retard\", \"annulee\"] }\n        },\n        required: [\"invoice_id_or_number\", \"statut\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"schedule_callback\",\n      description: \"Planifier un rappel immediat pour le client. Utilise quand le client dit 'rappelez-moi', 'je suis occupe', 'je ne peux pas parler maintenant', 'je voudrais etre rappele'.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          telephone: { type: \"string\", description: \"Numero a rappeler (utilise le numero d appel si non specifie)\" },\n          raison: { type: \"string\", description: \"Resume de la raison du rappel et du contexte de conversation\" }\n        },\n        required: [\"raison\"]\n      }\n    }\n  }\n];\n\nreturn [{ json: {\n  systemPrompt: systemPrompt,\n  tools: JSON.stringify(tools),\n  speechResult: speechResult,\n  callSid: callSid,\n  from: from,\n  isAdmin: false,\n  clientName: clientName,\n  clientEmail: clientEmail,\n  clientId: clientId,\n  tenantId: tenantId\n} }];"
      },
      "id": "12. Build Prompt",
      "name": "12. Build Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1500,
        250
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ model: 'gpt-4o-mini', messages: [{role:'system',content:$json.systemPrompt},{role:'user',content:$json.speechResult}], tools: JSON.parse($json.tools), max_tokens: 250, temperature: 0.5 }) }}"
      },
      "id": "13. OpenAI Chat",
      "name": "13. OpenAI Chat",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "credentials": {
        "openAiApi": {
          "name": "OpenAi account",
          "id": "nSSLzITn7UjPcRBc"
        }
      },
      "position": [
        1700,
        250
      ]
    },
    {
      "parameters": {
        "jsCode": "// Construire TwiML à partir de la réponse IA (directe ou après tool call)\nvar input = $input.first().json;\nif (!input) throw new Error('Build TwiML: aucune donnee en entree. Le node precedent n a rien retourne.');\n\nvar aiReply = input.aiReply;\nif (!aiReply) throw new Error('Build TwiML: aiReply manquant. La reponse OpenAI n a pas ete transmise.');\n\n// Nettoyer pour TTS\naiReply = aiReply\n  .replace(/\\*\\*/g, '')\n  .replace(/\\*/g, '')\n  .replace(/#{1,6}\\s/g, '')\n  .replace(/[\\[\\]]/g, '')\n  .replace(/\\\\n/g, ' ')\n  .replace(/&/g, '&amp;')\n  .replace(/</g, '&lt;')\n  .replace(/>/g, '&gt;')\n  .replace(/\"/g, '&quot;')\n  .trim();\n\n// Détecter intentions\nvar speech = (input.speechResult || '').toLowerCase();\nvar isGoodbye = speech.includes('au revoir') || speech.includes('merci au revoir') ||\n                  speech.includes('bonne journée') || speech.includes('à bientôt') ||\n                  speech.includes(\"c est tout\") || speech.includes('terminé');\n\nvar isProspect = speech.includes('intéress') || speech.includes('tarif') || speech.includes('prix') ||\n                   speech.includes('abonnement') || speech.includes('essai') || speech.includes('demo') ||\n                   speech.includes('souscrire') || speech.includes('inscription') || speech.includes('devis') ||\n                   (input.toolUsed === 'create_lead');\n\nvar needsEscalation = speech.includes('bug') || speech.includes('erreur') || speech.includes('bloqué') ||\n                        speech.includes('marche pas') || speech.includes('fonctionne pas') ||\n                        speech.includes('données perdues') || speech.includes('impossible') ||\n                        speech.includes('urgent') || speech.includes('grave');\n\nvar twiml = '';\nif (isGoodbye) {\n  twiml = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Response>\n  <Say voice=\"Polly.Lea-Neural\" language=\"fr-FR\">${aiReply}</Say>\n  <Hangup/>\n</Response>`;\n} else {\n  twiml = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Response>\n  <Say voice=\"Polly.Lea-Neural\" language=\"fr-FR\">${aiReply}</Say>\n  <Gather input=\"speech\" language=\"fr-FR\" speechTimeout=\"3\" timeout=\"15\" action=\"https://n8n.talosprimes.com/webhook/twilio-inbound-voice\" method=\"POST\"/>\n  <Say voice=\"Polly.Lea-Neural\" language=\"fr-FR\">Merci d\\u0027avoir appelé TalosPrimes. Bonne journée !</Say>\n</Response>`;\n}\n\nreturn [{ json: {\n  twiml,\n  callSid: input.callSid,\n  from: input.from,\n  speechResult: input.speechResult,\n  aiReply: aiReply.substring(0, 500),\n  isAdmin: input.isAdmin,\n  isGoodbye,\n  isProspect,\n  needsEscalation,\n  clientName: input.clientName || '',\n  toolUsed: input.toolUsed || '',\n  tenantId: input.tenantId || ''\n} }];"
      },
      "id": "14. Build TwiML Response",
      "name": "14. Build TwiML Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3100,
        350
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ (function() { var d = $('14. Build TwiML Response').first().json; if (!d.tenantId) throw new Error('Log Call: tenantId manquant'); var safe = function(s) { return String(s || '').replace(/'/g, \"''\").substring(0, 500); }; var notes = safe('CallSid:' + d.callSid + (d.isProspect ? ' [PROSPECT]' : '') + (d.needsEscalation ? ' [ESCALADE]' : '') + ' - Q: ' + (d.speechResult || '') + ' - R: ' + (d.aiReply || '')); var urgency = d.needsEscalation ? 'URGENT' : 'STANDARD'; var sentiment = d.isProspect ? 'POSITIF' : 'NEUTRE'; var action = d.isProspect ? 'DEVIS' : (d.needsEscalation ? 'TRANSFERT' : 'INFO'); return \"INSERT INTO call_logs (id, tenant_id, call_sid, caller_phone, direction, status, notes, urgency_level, sentiment, action_taken, niche, created_at, updated_at) VALUES (gen_random_uuid(), '\" + d.tenantId + \"', '\" + safe(d.callSid) + \"', '\" + safe(d.from) + \"', 'entrant', 'completed', '\" + notes + \"', '\" + urgency + \"', '\" + sentiment + \"', '\" + action + \"', 'talosprimes', NOW(), NOW()) RETURNING id\"; })() }}",
        "options": {
          "alwaysOutputData": true
        }
      },
      "id": "15. Log Call",
      "name": "15. Log Call",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "credentials": {
        "postgres": {
          "name": "Supabase Postgres",
          "id": "OGqj65ZoFRileCck"
        }
      },
      "position": [
        3300,
        450
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $('14. Build TwiML Response').first().json.twiml }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "text/xml; charset=utf-8"
              }
            ]
          }
        }
      },
      "id": "16. Respond TwiML",
      "name": "16. Respond TwiML",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        3300,
        300
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ (function() { var d = $('14. Build TwiML Response').first().json; if (!d.tenantId) throw new Error('Create Lead: tenantId manquant'); var safe = function(s) { return String(s || '').replace(/'/g, \"''\").substring(0, 500); }; var nom = safe(d.clientName || 'Inconnu'); var email = 'appel_' + Date.now() + '@placeholder.local'; return \"INSERT INTO leads (id, tenant_id, nom, prenom, email, telephone, source, statut, notes, created_at, updated_at) SELECT gen_random_uuid(), '\" + d.tenantId + \"', '\" + nom + \"', '', '\" + email + \"', '\" + safe(d.from) + \"', 'telephone', 'nouveau', '\" + safe('Prospect detecte par agent vocal - Demande: ' + (d.speechResult || '').substring(0, 300)) + \"', NOW(), NOW() WHERE NOT EXISTS (SELECT 1 FROM leads WHERE telephone LIKE '%' || RIGHT('\" + safe(d.from) + \"', 9) || '%' AND statut != 'abandonne') RETURNING id\"; })() }}",
        "options": {
          "alwaysOutputData": true
        }
      },
      "id": "17. Create Lead",
      "name": "17. Create Lead",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "credentials": {
        "postgres": {
          "name": "Supabase Postgres",
          "id": "OGqj65ZoFRileCck"
        }
      },
      "position": [
        3500,
        500
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ (function() { var d = $('14. Build TwiML Response').first().json; if (!d.tenantId) throw new Error('Notify Admin: tenantId manquant'); var safe = function(s) { return String(s || '').replace(/'/g, \"''\").substring(0, 500); }; var type = d.isProspect ? 'lead' : 'alerte'; var titre = d.isProspect ? 'Nouveau prospect telephonique' : 'Escalade agent vocal'; var msg = safe((d.isProspect ? 'Prospect' : 'Escalade') + ' - Tel: ' + d.from + ' - ' + (d.speechResult || '')); return \"INSERT INTO notifications (id, tenant_id, type, titre, message, lu, created_at) VALUES (gen_random_uuid(), '\" + d.tenantId + \"', '\" + type + \"', '\" + titre + \"', '\" + msg + \"', false, NOW()) RETURNING id\"; })() }}",
        "options": {
          "alwaysOutputData": true
        }
      },
      "id": "18. Notify Admin",
      "name": "18. Notify Admin",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "credentials": {
        "postgres": {
          "name": "Supabase Postgres",
          "id": "OGqj65ZoFRileCck"
        }
      },
      "position": [
        3500,
        700
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": ""
          },
          "conditions": [
            {
              "id": "6e0850b0-34ba-45a4-bcfe-eb4782a997bb",
              "leftValue": "={{ $json.isProspect || $json.needsEscalation }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "19. Need Action?",
      "name": "19. Need Action?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        3300,
        600
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ \"SELECT notes FROM call_logs WHERE notes LIKE '%CallSid:' || '\" + $('02. Parser Twilio').first().json.callSid + \"' || '%' ORDER BY created_at ASC LIMIT 10\" }}",
        "options": {
          "alwaysOutputData": true
        }
      },
      "id": "20. Load History",
      "name": "20. Load History",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "credentials": {
        "postgres": {
          "name": "Supabase Postgres",
          "id": "OGqj65ZoFRileCck"
        }
      },
      "position": [
        1400,
        400
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// Parse la réponse OpenAI avec requêtes SQL paramétrisées\nvar openaiResponse = $input.first().json;\nvar prev = $('12. Build Prompt').first().json;\nif (!prev || !prev.systemPrompt) throw new Error('Build Prompt: donnees manquantes. Le node 12 n a pas retourne de systemPrompt.');\nvar message = openaiResponse.choices?.[0]?.message;\nvar finishReason = openaiResponse.choices?.[0]?.finish_reason;\n\n// === FONCTIONS DE VALIDATION ===\nvar UUID_RE = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;\nvar PHONE_RE = /^\\+?[0-9]{6,15}$/;\nvar EMAIL_RE = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n\nfunction sanitizePhone(p) { return String(p || '').replace(/[^+0-9]/g, '').substring(0, 16); }\nfunction validateNum(n, min, max) { var v = parseFloat(n); return (Number.isFinite(v) && v >= min && v <= max) ? v : 0; }\nfunction safe(s, maxLen) { return String(s || '').substring(0, maxLen || 500); }\n\nif (finishReason === 'tool_calls' && message?.tool_calls?.length > 0) {\n  var toolCall = message.tool_calls[0];\n  var toolName = toolCall.function.name;\n  var toolArgs = JSON.parse(toolCall.function.arguments || '{}');\n  var toolCallId = toolCall.id;\n  var tenantId = prev.tenantId || '';\n\n  var ALLOWED_TOOLS = ['create_lead', 'search_client', 'create_client', 'create_invoice', 'create_bon_commande', 'list_recent_leads', 'update_lead', 'delete_lead', 'update_client', 'delete_client', 'list_clients', 'list_invoices', 'update_invoice_status', 'delete_invoice', 'schedule_callback'];\n  if (!ALLOWED_TOOLS.includes(toolName)) throw new Error('Tool non autorisé: ' + toolName);\n\n  var sqlQuery = '';\n  var sqlParams = [];\n\n  if (toolName === 'create_lead') {\n    var nom = safe(toolArgs.nom, 100);\n    var prenom = safe(toolArgs.prenom, 100);\n    var email = toolArgs.email && EMAIL_RE.test(toolArgs.email) ? safe(toolArgs.email, 255) : '';\n    var tel = sanitizePhone(toolArgs.telephone || prev.from);\n    var notes = safe(toolArgs.notes, 500);\n    if (!tel) throw new Error('Téléphone requis pour create_lead');\n    sqlQuery = `INSERT INTO leads (id, tenant_id, nom, prenom, email, telephone, source, statut, notes, created_at, updated_at)\n      SELECT gen_random_uuid(), COALESCE(NULLIF($1, '')::uuid, (SELECT id FROM tenants LIMIT 1)), $2, $3, $4, $5, 'telephone_ia', 'nouveau', $6, NOW(), NOW()\n      WHERE NOT EXISTS (SELECT 1 FROM leads WHERE telephone LIKE '%' || RIGHT($5, 9) || '%' AND statut != 'abandonne')\n      RETURNING id, nom, prenom, telephone`;\n    sqlParams = [tenantId, nom, prenom, email, tel, notes];\n  } else if (toolName === 'search_client') {\n    var q = safe(toolArgs.query, 100);\n    if (!q) throw new Error('Query requis pour search_client');\n    sqlQuery = `SELECT id, nom, prenom, email, telephone, raison_sociale, type, statut FROM client_finals WHERE nom ILIKE '%' || $1 || '%' OR prenom ILIKE '%' || $1 || '%' OR telephone LIKE '%' || $1 || '%' OR email ILIKE '%' || $1 || '%' LIMIT 5`;\n    sqlParams = [q];\n  } else if (toolName === 'create_client') {\n    var email = toolArgs.email && EMAIL_RE.test(toolArgs.email) ? safe(toolArgs.email, 255) : '';\n    if (!email) throw new Error('Email valide requis pour create_client');\n    var type = ['b2b', 'b2c'].includes(toolArgs.type) ? toolArgs.type : 'b2c';\n    sqlQuery = `INSERT INTO client_finals (id, tenant_id, type, nom, prenom, email, telephone, raison_sociale, statut, created_at, updated_at)\n      VALUES (gen_random_uuid(), COALESCE(NULLIF($7, '')::uuid, (SELECT id FROM tenants LIMIT 1)), $1, $2, $3, $4, $5, $6, 'actif', NOW(), NOW())\n      RETURNING id, nom, prenom, email`;\n    sqlParams = [type, safe(toolArgs.nom, 100), safe(toolArgs.prenom, 100), email, sanitizePhone(toolArgs.telephone), safe(toolArgs.raison_sociale, 255), tenantId];\n  } else if (toolName === 'create_invoice') {\n    var ht = validateNum(toolArgs.montant_ht, 0, 999999);\n    var tva = validateNum(toolArgs.tva_taux || 20, 0, 100);\n    var ttc = ht * (1 + tva / 100);\n    var clientQ = safe(toolArgs.client_name_or_phone, 100);\n    if (!clientQ || ht <= 0) throw new Error('Client et montant requis pour create_invoice');\n    var numFacture = 'FA-' + Date.now();\n    sqlQuery = `INSERT INTO invoices (id, tenant_id, type, client_final_id, numero_facture, date_facture, date_echeance, montant_ht, montant_ttc, tva_taux, description, statut, created_at, updated_at)\n      SELECT gen_random_uuid(), COALESCE(NULLIF($7, '')::uuid, (SELECT id FROM tenants LIMIT 1)), 'facture_client_final',\n        (SELECT id FROM client_finals WHERE nom ILIKE '%' || $1 || '%' OR telephone LIKE '%' || $1 || '%' LIMIT 1),\n        $2, NOW(), NOW() + INTERVAL '30 days', $3, $4, $5, $6, 'brouillon', NOW(), NOW()\n      RETURNING id, numero_facture, montant_ht, montant_ttc, statut`;\n    sqlParams = [clientQ, numFacture, ht, parseFloat(ttc.toFixed(2)), tva, safe(toolArgs.description, 500), tenantId];\n  } else if (toolName === 'create_bon_commande') {\n    var ht = validateNum(toolArgs.montant_ht, 0, 999999);\n    var tva = validateNum(toolArgs.tva_taux || 20, 0, 100);\n    var ttc = ht * (1 + tva / 100);\n    var clientQ = safe(toolArgs.client_name_or_phone, 100);\n    if (!clientQ || ht <= 0) throw new Error('Client et montant requis pour create_bon_commande');\n    var numBdc = 'BDC-' + Date.now();\n    sqlQuery = `INSERT INTO bons_commande (id, tenant_id, client_final_id, numero_bdc, date_bdc, montant_ht, montant_ttc, tva_taux, description, statut, created_at, updated_at)\n      SELECT gen_random_uuid(), COALESCE(NULLIF($7, '')::uuid, (SELECT id FROM tenants LIMIT 1)),\n        (SELECT id FROM client_finals WHERE nom ILIKE '%' || $1 || '%' OR telephone LIKE '%' || $1 || '%' LIMIT 1),\n        $2, NOW(), $3, $4, $5, $6, 'brouillon', NOW(), NOW()\n      RETURNING id, numero_bdc, montant_ht, montant_ttc, statut`;\n    sqlParams = [clientQ, numBdc, ht, parseFloat(ttc.toFixed(2)), tva, safe(toolArgs.description, 500), tenantId];\n  } else if (toolName === 'list_recent_leads') {\n    var limit = Math.min(Math.max(parseInt(toolArgs.limit) || 5, 1), 20);\n    var statut = ['nouveau', 'contacte', 'converti', 'abandonne'].includes(toolArgs.statut) ? toolArgs.statut : null;\n    if (statut) {\n      sqlQuery = `SELECT id, nom, prenom, telephone, email, statut, source, created_at FROM leads WHERE statut = $1 ORDER BY created_at DESC LIMIT $2`;\n      sqlParams = [statut, limit];\n    } else {\n      sqlQuery = `SELECT id, nom, prenom, telephone, email, statut, source, created_at FROM leads ORDER BY created_at DESC LIMIT $1`;\n      sqlParams = [limit];\n    }\n  } else if (toolName === 'update_lead') {\n    var q = safe(toolArgs.lead_id_or_phone, 100);\n    if (!q) throw new Error('ID ou téléphone requis pour update_lead');\n    var sets = [];\n    var params = [q];\n    var idx = 2;\n    if (toolArgs.statut && ['nouveau', 'contacte', 'converti', 'abandonne'].includes(toolArgs.statut)) { sets.push(`statut = $${idx}`); params.push(toolArgs.statut); idx++; }\n    if (toolArgs.notes) { sets.push(`notes = $${idx}`); params.push(safe(toolArgs.notes, 500)); idx++; }\n    if (toolArgs.nom) { sets.push(`nom = $${idx}`); params.push(safe(toolArgs.nom, 100)); idx++; }\n    if (toolArgs.email && EMAIL_RE.test(toolArgs.email)) { sets.push(`email = $${idx}`); params.push(safe(toolArgs.email, 255)); idx++; }\n    if (sets.length === 0) throw new Error('Aucune modification spécifiée');\n    sets.push('updated_at = NOW()');\n    sqlQuery = `UPDATE leads SET ${sets.join(', ')} WHERE (id::text = $1 OR telephone LIKE '%' || RIGHT($1, 9) || '%') RETURNING id, nom, prenom, telephone, statut`;\n    sqlParams = params;\n  } else if (toolName === 'delete_lead') {\n    var q = safe(toolArgs.lead_id_or_phone, 100);\n    if (!q) throw new Error('ID ou téléphone requis pour delete_lead');\n    sqlQuery = `DELETE FROM leads WHERE (id::text = $1 OR telephone LIKE '%' || RIGHT($1, 9) || '%') RETURNING id, nom, prenom, telephone`;\n    sqlParams = [q];\n  } else if (toolName === 'update_client') {\n    var q = safe(toolArgs.client_id_or_name, 100);\n    if (!q) throw new Error('ID ou nom requis pour update_client');\n    var sets = [];\n    var params = [q];\n    var idx = 2;\n    if (toolArgs.nom) { sets.push(`nom = $${idx}`); params.push(safe(toolArgs.nom, 100)); idx++; }\n    if (toolArgs.email && EMAIL_RE.test(toolArgs.email)) { sets.push(`email = $${idx}`); params.push(safe(toolArgs.email, 255)); idx++; }\n    if (toolArgs.telephone) { sets.push(`telephone = $${idx}`); params.push(sanitizePhone(toolArgs.telephone)); idx++; }\n    if (toolArgs.statut && ['actif', 'inactif', 'suspendu'].includes(toolArgs.statut)) { sets.push(`statut = $${idx}`); params.push(toolArgs.statut); idx++; }\n    if (sets.length === 0) throw new Error('Aucune modification spécifiée');\n    sets.push('updated_at = NOW()');\n    sqlQuery = `UPDATE client_finals SET ${sets.join(', ')} WHERE (id::text = $1 OR nom ILIKE '%' || $1 || '%' OR telephone LIKE '%' || RIGHT($1, 9) || '%') RETURNING id, nom, prenom, email, telephone, statut`;\n    sqlParams = params;\n  } else if (toolName === 'delete_client') {\n    var q = safe(toolArgs.client_id_or_name, 100);\n    if (!q) throw new Error('ID ou nom requis pour delete_client');\n    sqlQuery = `DELETE FROM client_finals WHERE (id::text = $1 OR nom ILIKE '%' || $1 || '%') RETURNING id, nom, prenom, email`;\n    sqlParams = [q];\n  } else if (toolName === 'list_clients') {\n    var limit = Math.min(Math.max(parseInt(toolArgs.limit) || 10, 1), 50);\n    var statut = ['actif', 'inactif', 'suspendu'].includes(toolArgs.statut) ? toolArgs.statut : null;\n    var type = ['b2b', 'b2c'].includes(toolArgs.type) ? toolArgs.type : null;\n    if (statut && type) {\n      sqlQuery = `SELECT id, nom, prenom, email, telephone, type, statut, raison_sociale, created_at FROM client_finals WHERE statut = $1 AND type = $2 ORDER BY created_at DESC LIMIT $3`;\n      sqlParams = [statut, type, limit];\n    } else if (statut) {\n      sqlQuery = `SELECT id, nom, prenom, email, telephone, type, statut, raison_sociale, created_at FROM client_finals WHERE statut = $1 ORDER BY created_at DESC LIMIT $2`;\n      sqlParams = [statut, limit];\n    } else if (type) {\n      sqlQuery = `SELECT id, nom, prenom, email, telephone, type, statut, raison_sociale, created_at FROM client_finals WHERE type = $1 ORDER BY created_at DESC LIMIT $2`;\n      sqlParams = [type, limit];\n    } else {\n      sqlQuery = `SELECT id, nom, prenom, email, telephone, type, statut, raison_sociale, created_at FROM client_finals ORDER BY created_at DESC LIMIT $1`;\n      sqlParams = [limit];\n    }\n  } else if (toolName === 'list_invoices') {\n    var limit = Math.min(Math.max(parseInt(toolArgs.limit) || 10, 1), 50);\n    var statut = ['brouillon', 'envoyee', 'payee', 'en_retard', 'annulee'].includes(toolArgs.statut) ? toolArgs.statut : null;\n    if (statut) {\n      sqlQuery = `SELECT i.id, i.numero_facture, i.statut, i.montant_ht, i.montant_ttc, i.date_facture, i.date_echeance, cf.nom as client_nom, cf.prenom as client_prenom FROM invoices i LEFT JOIN client_finals cf ON i.client_final_id = cf.id WHERE i.statut = $1 ORDER BY i.created_at DESC LIMIT $2`;\n      sqlParams = [statut, limit];\n    } else {\n      sqlQuery = `SELECT i.id, i.numero_facture, i.statut, i.montant_ht, i.montant_ttc, i.date_facture, i.date_echeance, cf.nom as client_nom, cf.prenom as client_prenom FROM invoices i LEFT JOIN client_finals cf ON i.client_final_id = cf.id ORDER BY i.created_at DESC LIMIT $1`;\n      sqlParams = [limit];\n    }\n  } else if (toolName === 'update_invoice_status') {\n    var q = safe(toolArgs.invoice_id_or_number, 100);\n    var statut = toolArgs.statut;\n    if (!q || !['brouillon', 'envoyee', 'payee', 'en_retard', 'annulee'].includes(statut)) throw new Error('ID/numéro et statut valide requis');\n    sqlQuery = `UPDATE invoices SET statut = $1, updated_at = NOW() WHERE (id::text = $2 OR numero_facture = $2) RETURNING id, numero_facture, statut, montant_ttc`;\n    sqlParams = [statut, q];\n  } else if (toolName === 'delete_invoice') {\n    var q = safe(toolArgs.invoice_id_or_number, 100);\n    if (!q) throw new Error('ID ou numéro requis pour delete_invoice');\n    sqlQuery = `DELETE FROM invoices WHERE (id::text = $1 OR numero_facture = $1) AND statut = 'brouillon' RETURNING id, numero_facture, montant_ttc`;\n    sqlParams = [q];\n  } else if (toolName === 'schedule_callback') {\n    var callbackTel = sanitizePhone(toolArgs.telephone || prev.from);\n    var callbackRaison = safe(toolArgs.raison, 500);\n    sqlQuery = `SELECT $1 as telephone, $2 as raison, 'callback_scheduled' as status`;\n    sqlParams = [callbackTel, callbackRaison];\n  }\n\n  return [{ json: {\n    hasToolCall: true,\n    toolCallId,\n    toolName,\n    toolArgs: JSON.stringify(toolArgs),\n    sqlQuery,\n    sqlParams,\n    messages: JSON.stringify([\n      {role: 'system', content: prev.systemPrompt},\n      {role: 'user', content: prev.speechResult},\n      message\n    ]),\n    tools: prev.tools,\n    callSid: prev.callSid,\n    from: prev.from,\n    speechResult: prev.speechResult,\n    isAdmin: prev.isAdmin,\n    clientName: prev.clientName || '',\n    clientEmail: prev.clientEmail || '',\n    tenantId: prev.tenantId || ''\n  } }];\n} else {\n  var aiReply = message?.content;\n  if (!aiReply) throw new Error('OpenAI Chat: pas de contenu dans la reponse directe. choices[0].message.content est vide.');\n\n  return [{ json: {\n    hasToolCall: false,\n    aiReply,\n    callSid: prev.callSid,\n    from: prev.from,\n    speechResult: prev.speechResult,\n    isAdmin: prev.isAdmin,\n    clientName: prev.clientName || '',\n    clientEmail: prev.clientEmail || '',\n    tenantId: prev.tenantId || ''\n  } }];\n}"
      },
      "id": "21. Parse Response",
      "name": "21. Parse Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1900,
        250
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": ""
          },
          "conditions": [
            {
              "id": "f420da73-33d1-4132-b70f-cdb037d1913d",
              "leftValue": "={{ $json.hasToolCall }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "22. Has Tool Call?",
      "name": "22. Has Tool Call?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        2100,
        250
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.sqlQuery }}",
        "options": {
          "alwaysOutputData": true
        }
      },
      "id": "23. Execute Tool SQL",
      "name": "23. Execute Tool SQL",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "credentials": {
        "postgres": {
          "name": "Supabase Postgres",
          "id": "OGqj65ZoFRileCck"
        }
      },
      "position": [
        2300,
        150
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// Construire le body pour le 2e appel OpenAI avec le résultat du tool\nvar prev = $('21. Parse Response').first().json;\nvar toolResult = $input.first().json;\nvar messages = JSON.parse(prev.messages);\nvar tools = JSON.parse(prev.tools);\n\n// Ajouter le résultat du tool aux messages\nmessages.push({\n  role: 'tool',\n  tool_call_id: prev.toolCallId,\n  content: JSON.stringify(toolResult)\n});\n\nreturn [{ json: {\n  jsonBody: JSON.stringify({\n    model: 'gpt-4o-mini',\n    messages,\n    max_tokens: 200,\n    temperature: 0.5\n  }),\n  callSid: prev.callSid,\n  from: prev.from,\n  speechResult: prev.speechResult,\n  isAdmin: prev.isAdmin,\n  clientName: prev.clientName || '',\n  clientEmail: prev.clientEmail || '',\n  toolUsed: prev.toolName,\n  tenantId: prev.tenantId || ''\n} }];"
      },
      "id": "24. Build Tool Body",
      "name": "24. Build Tool Body",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2500,
        150
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.jsonBody }}"
      },
      "id": "25. OpenAI Tool Result",
      "name": "25. OpenAI Tool Result",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "credentials": {
        "openAiApi": {
          "name": "OpenAi account",
          "id": "nSSLzITn7UjPcRBc"
        }
      },
      "position": [
        2700,
        150
      ]
    },
    {
      "parameters": {
        "jsCode": "// Extraire la réponse finale après tool call\nvar openaiResponse = $input.first().json;\nvar prev = $('24. Build Tool Body').first().json;\nif (!prev) throw new Error('Build Tool Body: donnees manquantes. Le node 24 n a pas retourne de json.');\n\nvar aiReply = openaiResponse.choices?.[0]?.message?.content;\nif (!aiReply) throw new Error('OpenAI Tool Result: pas de contenu dans la reponse. choices[0].message.content est vide.');\n\nreturn [{ json: {\n  aiReply,\n  callSid: prev.callSid,\n  from: prev.from,\n  speechResult: prev.speechResult,\n  isAdmin: prev.isAdmin,\n  clientName: prev.clientName || '',\n  clientEmail: prev.clientEmail || '',\n  toolUsed: prev.toolUsed || '',\n  tenantId: prev.tenantId || ''\n} }];"
      },
      "id": "26. Extract Final Reply",
      "name": "26. Extract Final Reply",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2900,
        150
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": ""
          },
          "conditions": [
            {
              "id": "cb-check-001",
              "leftValue": "={{ $json.toolUsed }}",
              "rightValue": "schedule_callback",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "27. Need Callback?",
      "name": "27. Need Callback?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        3300,
        800
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://n8n.talosprimes.com/webhook/twilio-outbound-call",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ tenantId: $('14. Build TwiML Response').first().json.tenantId, to: $('14. Build TwiML Response').first().json.from, reason: 'rappel' }) }}",
        "options": {
          "timeout": 10000
        }
      },
      "id": "28. Trigger Outbound Call",
      "name": "28. Trigger Outbound Call",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3500,
        800
      ]
    }
  ],
  "connections": {
    "01. Webhook Twilio": {
      "main": [
        [
          {
            "node": "02. Parser Twilio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "02. Parser Twilio": {
      "main": [
        [
          {
            "node": "03. Is Callback?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "03. Is Callback?": {
      "main": [
        [
          {
            "node": "06. Extract Speech",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "04. Welcome TwiML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "04. Welcome TwiML": {
      "main": [
        [
          {
            "node": "05. Respond Welcome",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "06. Extract Speech": {
      "main": [
        [
          {
            "node": "07. Has Text?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "07. Has Text?": {
      "main": [
        [
          {
            "node": "10. Detect Admin",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "08. No Text TwiML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "08. No Text TwiML": {
      "main": [
        [
          {
            "node": "09. Respond No Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "10. Detect Admin": {
      "main": [
        [
          {
            "node": "11. Get Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "11. Get Session": {
      "main": [
        [
          {
            "node": "11b. Load Knowledge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "20. Load History": {
      "main": [
        [
          {
            "node": "12. Build Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "12. Build Prompt": {
      "main": [
        [
          {
            "node": "13. OpenAI Chat",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "13. OpenAI Chat": {
      "main": [
        [
          {
            "node": "21. Parse Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "14. Build TwiML Response": {
      "main": [
        [
          {
            "node": "15. Log Call",
            "type": "main",
            "index": 0
          },
          {
            "node": "16. Respond TwiML",
            "type": "main",
            "index": 0
          },
          {
            "node": "19. Need Action?",
            "type": "main",
            "index": 0
          },
          {
            "node": "27. Need Callback?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "27. Need Callback?": {
      "main": [
        [
          {
            "node": "28. Trigger Outbound Call",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "19. Need Action?": {
      "main": [
        [
          {
            "node": "17. Create Lead",
            "type": "main",
            "index": 0
          },
          {
            "node": "18. Notify Admin",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "21. Parse Response": {
      "main": [
        [
          {
            "node": "22. Has Tool Call?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "22. Has Tool Call?": {
      "main": [
        [
          {
            "node": "23. Execute Tool SQL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "14. Build TwiML Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "23. Execute Tool SQL": {
      "main": [
        [
          {
            "node": "24. Build Tool Body",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "24. Build Tool Body": {
      "main": [
        [
          {
            "node": "25. OpenAI Tool Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "25. OpenAI Tool Result": {
      "main": [
        [
          {
            "node": "26. Extract Final Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "26. Extract Final Reply": {
      "main": [
        [
          {
            "node": "14. Build TwiML Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "11b. Load Knowledge": {
      "main": [
        [
          {
            "node": "20. Load History",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "active": true
}