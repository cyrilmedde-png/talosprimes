{
  "name": "twilio-config-update",
  "nodes": [
    {
      "parameters": {
        "path": "twilio-config-update",
        "responseMode": "responseNode",
        "httpMethod": "POST"
      },
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 250]
    },
    {
      "parameters": {
        "jsCode": "var body = $input.first().json.body || $input.first().json;\nvar tenantId = body.tenantId;\nif (!tenantId) {\n  throw new Error('Missing required field: tenantId');\n}\n\n// Mapping camelCase frontend → snake_case DB\nvar fieldMap = {\n  agentName: 'agent_name',\n  companyName: 'company_name',\n  niche: 'niche',\n  businessHours: 'business_hours',\n  systemPromptAddon: 'system_prompt_addon',\n  knowledgeBase: 'knowledge_base',\n  dispatchDelay: 'dispatch_delay',\n  basePrice: 'base_price',\n  humanContact: 'human_contact',\n  active: 'active'\n};\n\n// Extraire les données depuis body ou body.data\nvar data = body.data || body;\nvar setClauses = [];\n\nfor (var camelKey in fieldMap) {\n  if (data[camelKey] !== undefined) {\n    var dbCol = fieldMap[camelKey];\n    var val = data[camelKey];\n    if (typeof val === 'boolean') {\n      setClauses.push(dbCol + ' = ' + val);\n    } else if (typeof val === 'number') {\n      setClauses.push(dbCol + ' = ' + val);\n    } else {\n      // String — échapper les apostrophes\n      var escaped = String(val).replace(/'/g, \"''\");\n      setClauses.push(dbCol + \" = '\" + escaped + \"'\");\n    }\n  }\n}\n\nif (setClauses.length === 0) {\n  throw new Error('Aucun champ à mettre à jour');\n}\n\nsetClauses.push('updated_at = NOW()');\n\nvar query = 'UPDATE twilio_configs SET ' + setClauses.join(', ') + \" WHERE tenant_id = '\" + tenantId + \"' RETURNING *\";\n\nreturn [{ json: { tenantId, query } }];"
      },
      "name": "Build Update",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 250]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.query }}"
      },
      "name": "Postgres Update",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [650, 250],
      "credentials": {
        "postgres": {
          "name": "Supabase Postgres",
          "id": "OGqj65ZoFRileCck"
        }
      },
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "var results = $input.all();\nif (!results || results.length === 0 || !results[0].json.id) {\n  throw new Error('ERREUR: UPDATE n\\'a retourné aucun résultat — tenant_id introuvable');\n}\nvar row = results[0].json;\nreturn [{ json: {\n  id: row.id,\n  phoneNumber: row.phone_number,\n  agentName: row.agent_name,\n  companyName: row.company_name,\n  niche: row.niche,\n  businessHours: row.business_hours,\n  systemPromptAddon: row.system_prompt_addon,\n  knowledgeBase: row.knowledge_base,\n  dispatchDelay: row.dispatch_delay,\n  basePrice: row.base_price,\n  humanContact: row.human_contact,\n  active: row.active,\n  webhookUrl: row.webhook_url,\n  createdAt: row.created_at,\n  updatedAt: row.updated_at\n} }];"
      },
      "name": "Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 250]
    },
    {
      "parameters": {
        "responseBody": "={{ $json }}"
      },
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1050, 250]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [[{ "node": "Build Update", "type": "main", "index": 0 }]]
    },
    "Build Update": {
      "main": [[{ "node": "Postgres Update", "type": "main", "index": 0 }]]
    },
    "Postgres Update": {
      "main": [[{ "node": "Format Response", "type": "main", "index": 0 }]]
    },
    "Format Response": {
      "main": [[{ "node": "Respond", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "active": true
}
