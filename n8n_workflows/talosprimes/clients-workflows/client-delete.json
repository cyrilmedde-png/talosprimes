{
  "name": "client-delete",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "client_delete",
        "responseMode": "responseNode"
      },
      "id": "01. Webhook",
      "name": "01. Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [100, 200]
    },
    {
      "parameters": {
        "jsCode": "var raw = $input.first().json;\nvar body = raw.body || raw;\nvar data = body.data || body;\nvar tenantId = body.tenantId || raw.tenantId || '';\nvar id = data.id || body.id || '';\nif (!id) throw new Error('ID du client requis');\nif (!tenantId) throw new Error('Tenant ID requis');\nreturn [{ json: { id: String(id), tenantId: String(tenantId) } }];"
      },
      "id": "02. Parser",
      "name": "02. Parser",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [300, 200]
    },
    {
      "parameters": {
        "jsCode": "var id = $json.id;\nvar tenantId = $json.tenantId;\nfunction esc(v) { return v == null ? 'NULL' : \"'\" + String(v).replace(/'/g, \"''\") + \"'\"; }\n\nvar safeId = esc(id);\nvar safeTenant = esc(tenantId);\n\n// Une seule requête WITH (CTE) au lieu de BEGIN/COMMIT multi-statements\n// Le node Postgres v2 ne supporte pas les transactions multi-statements\nvar query = 'WITH del_devis_lines AS ('\n  + '  DELETE FROM devis_lines WHERE devis_id IN (SELECT id FROM devis WHERE client_final_id = ' + safeId + '::uuid AND tenant_id = ' + safeTenant + '::uuid)'\n  + '), del_devis AS ('\n  + '  DELETE FROM devis WHERE client_final_id = ' + safeId + '::uuid AND tenant_id = ' + safeTenant + '::uuid'\n  + '), del_bdc_lines AS ('\n  + '  DELETE FROM bon_commande_lines WHERE bon_commande_id IN (SELECT id FROM bons_commande WHERE client_final_id = ' + safeId + '::uuid AND tenant_id = ' + safeTenant + '::uuid)'\n  + '), del_bdc AS ('\n  + '  DELETE FROM bons_commande WHERE client_final_id = ' + safeId + '::uuid AND tenant_id = ' + safeTenant + '::uuid'\n  + '), del_inv_lines AS ('\n  + '  DELETE FROM invoice_lines WHERE invoice_id IN (SELECT id FROM invoices WHERE client_final_id = ' + safeId + '::uuid AND tenant_id = ' + safeTenant + '::uuid)'\n  + '), del_inv AS ('\n  + '  DELETE FROM invoices WHERE client_final_id = ' + safeId + '::uuid AND tenant_id = ' + safeTenant + '::uuid'\n  + ') '\n  + 'DELETE FROM client_finals WHERE id = ' + safeId + '::uuid AND tenant_id = ' + safeTenant + '::uuid RETURNING id, nom, prenom, email';\n\nreturn [{ json: { query: query, id: id, tenantId: tenantId } }];"
      },
      "id": "03. Build SQL",
      "name": "03. Build SQL",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [500, 200]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.query }}"
      },
      "id": "04. Execute Delete",
      "name": "04. Execute Delete",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "credentials": {
        "postgres": {
          "name": "Supabase Postgres",
          "id": "OGqj65ZoFRileCck"
        }
      },
      "position": [700, 200],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "var items = $input.all();\nvar deleted = items.filter(function(i) { return i.json && i.json.id; });\nif (deleted.length === 0) {\n  return [{ json: { success: true, message: 'Client supprimé (ou déjà supprimé)' } }];\n}\nvar d = deleted[0].json;\nreturn [{ json: { success: true, message: 'Client supprimé', id: d.id, nom: d.nom, prenom: d.prenom, email: d.email } }];"
      },
      "id": "05. Format Response",
      "name": "05. Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 200]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}"
      },
      "id": "06. Respond",
      "name": "06. Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1100, 200]
    }
  ],
  "connections": {
    "01. Webhook": {
      "main": [[{ "node": "02. Parser", "type": "main", "index": 0 }]]
    },
    "02. Parser": {
      "main": [[{ "node": "03. Build SQL", "type": "main", "index": 0 }]]
    },
    "03. Build SQL": {
      "main": [[{ "node": "04. Execute Delete", "type": "main", "index": 0 }]]
    },
    "04. Execute Delete": {
      "main": [[{ "node": "05. Format Response", "type": "main", "index": 0 }]]
    },
    "05. Format Response": {
      "main": [[{ "node": "06. Respond", "type": "main", "index": 0 }]]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  }
}