{
  "name": "Onboarding Client - Créer espace et abonnement",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "client-onboarding",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-onboarding",
      "name": "01. Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 400],
      "webhookId": "client-onboarding"
    },
    {
      "parameters": {
        "jsCode": "var raw = $input.item.json;\nvar payload = raw.body || raw.json || raw;\nvar tenantId = payload.tenantId || payload.data?.tenantId;\nvar clientData = payload.data?.client || payload.client || payload.data || {};\nvar clientId = clientData.id || clientData.clientId;\nvar planFromPayload = payload.data?.plan || payload.plan || {};\nvar avecStripe = payload.data?.avecStripe || payload.avecStripe || false;\nvar subscriptionId = payload.data?.subscriptionId || payload.subscriptionId || null;\n\nif (!tenantId) throw new Error('tenantId manquant');\nif (!clientId) throw new Error('clientId manquant');\nif (!subscriptionId) throw new Error('subscriptionId manquant — l\\'abonnement doit être créé par le backend avant d\\'appeler ce workflow');\n\nvar plan = {\n  nomPlan: planFromPayload.nomPlan || 'Plan Starter',\n  montantMensuel: planFromPayload.montantMensuel || 29.99,\n  modulesInclus: planFromPayload.modulesInclus || ['facturation', 'comptabilite', 'agent_ia'],\n  dureeMois: planFromPayload.dureeMois || 1\n};\n\nvar chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';\nvar password = '';\nfor (var i = 0; i < 12; i++) password += chars.charAt(Math.floor(Math.random() * chars.length));\n\nreturn [{\n  json: {\n    tenantId: String(tenantId),\n    clientId: String(clientId),\n    subscriptionId: String(subscriptionId),\n    clientData: clientData,\n    plan: plan,\n    avecStripe: avecStripe,\n    plainPassword: password,\n    unitAmount: Math.round(plan.montantMensuel * 100),\n    customerName: String(clientData.nom || clientData.raisonSociale || clientData.email || '')\n  }\n}];"
      },
      "id": "parse-validate",
      "name": "02. Parser + Valider",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 400]
    },
    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "leftValue": "" },
          "conditions": [
            {
              "id": "check-stripe",
              "leftValue": "={{ String($json.avecStripe || '') }}",
              "rightValue": "true",
              "operator": { "type": "string", "operation": "equals" }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-stripe",
      "name": "03. IF Stripe ?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [680, 400]
    },
    {
      "parameters": {
        "resource": "customer",
        "operation": "create",
        "name": "={{ $('02. Parser + Valider').item.json.customerName }}",
        "email": "={{ $('02. Parser + Valider').item.json.clientData.email }}",
        "additionalFields": {
          "metadata": {
            "metadataProperties": [
              { "key": "clientId", "value": "={{ $('02. Parser + Valider').item.json.clientId }}" },
              { "key": "tenantId", "value": "={{ $('02. Parser + Valider').item.json.tenantId }}" }
            ]
          }
        }
      },
      "id": "stripe-customer",
      "name": "04. Stripe - Créer Customer",
      "type": "n8n-nodes-base.stripe",
      "typeVersion": 1,
      "position": [900, 300],
      "credentials": {
        "stripeApi": { "id": "hTgbVXtv3dG8wSJ4", "name": "Stripe API" }
      }
    },
    {
      "parameters": {
        "url": "https://api.stripe.com/v1/checkout/sessions",
        "method": "POST",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Content-Type", "value": "application/x-www-form-urlencoded" },
            { "name": "Authorization", "value": "={{ 'Bearer ' + $env.STRIPE_SECRET_KEY }}" }
          ]
        },
        "sendBody": true,
        "specifyBody": "keypair",
        "bodyParameters": {
          "parameters": [
            { "name": "customer", "value": "={{ $json.id }}" },
            { "name": "mode", "value": "subscription" },
            { "name": "line_items[0][price_data][currency]", "value": "eur" },
            { "name": "line_items[0][price_data][unit_amount]", "value": "={{ $('02. Parser + Valider').item.json.unitAmount }}" },
            { "name": "line_items[0][price_data][recurring][interval]", "value": "month" },
            { "name": "line_items[0][price_data][product_data][name]", "value": "={{ $('02. Parser + Valider').item.json.plan.nomPlan }}" },
            { "name": "line_items[0][quantity]", "value": "1" },
            { "name": "success_url", "value": "={{ 'https://talosprimes.com/clients?checkout=success&clientId=' + $('02. Parser + Valider').item.json.clientId + '&session_id={CHECKOUT_SESSION_ID}' }}" },
            { "name": "cancel_url", "value": "={{ 'https://talosprimes.com/clients?checkout=cancelled&clientId=' + $('02. Parser + Valider').item.json.clientId }}" },
            { "name": "metadata[clientId]", "value": "={{ $('02. Parser + Valider').item.json.clientId }}" },
            { "name": "metadata[tenantId]", "value": "={{ $('02. Parser + Valider').item.json.tenantId }}" },
            { "name": "metadata[planName]", "value": "={{ $('02. Parser + Valider').item.json.plan.nomPlan }}" },
            { "name": "metadata[subscriptionId]", "value": "={{ $('02. Parser + Valider').item.json.subscriptionId }}" },
            { "name": "subscription_data[metadata][clientId]", "value": "={{ $('02. Parser + Valider').item.json.clientId }}" },
            { "name": "subscription_data[metadata][tenantId]", "value": "={{ $('02. Parser + Valider').item.json.tenantId }}" },
            { "name": "subscription_data[metadata][subscriptionId]", "value": "={{ $('02. Parser + Valider').item.json.subscriptionId }}" },
            { "name": "payment_method_types[]", "value": "card" }
          ]
        },
        "options": {}
      },
      "id": "stripe-checkout",
      "name": "05. Stripe - Checkout Session",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "jsCode": "var data = $('02. Parser + Valider').first().json;\nvar checkoutSession = $('05. Stripe - Checkout Session').first().json;\nvar customerId = $('04. Stripe - Créer Customer').first().json.id;\n\nreturn [{\n  json: {\n    ...data,\n    idClientStripe: customerId,\n    idSessionCheckoutStripe: checkoutSession.id,\n    checkoutUrl: checkoutSession.url,\n    statutAbonnement: 'en_attente_paiement'\n  }\n}];"
      },
      "id": "merge-stripe",
      "name": "06. Combiner données Stripe",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "jsCode": "var data = $('02. Parser + Valider').first().json;\n\nreturn [{\n  json: {\n    ...data,\n    idClientStripe: null,\n    idSessionCheckoutStripe: null,\n    checkoutUrl: null,\n    statutAbonnement: 'actif'\n  }\n}];"
      },
      "id": "no-stripe",
      "name": "06b. Sans Stripe (actif direct)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 500]
    },
    {
      "parameters": {
        "jsCode": "var d = $input.first().json;\n\nfunction esc(v) { return v == null ? 'NULL' : \"'\" + String(v).replace(/'/g, \"''\") + \"'\"; }\n\n// L'abonnement a déjà été créé par le backend (clients.routes.ts).\n// Ici on UPDATE avec les infos Stripe (customerId, sessionId, password temporaire).\nvar query = 'UPDATE client_subscriptions SET '\n  + 'statut = ' + esc(d.statutAbonnement) + ', '\n  + 'id_client_stripe = ' + (d.idClientStripe ? esc(d.idClientStripe) : 'NULL') + ', '\n  + 'id_abonnement_stripe = ' + (d.idSessionCheckoutStripe ? esc(d.idSessionCheckoutStripe) : 'NULL') + ', '\n  + 'temporary_password = ' + esc(d.plainPassword) + ', '\n  + 'updated_at = NOW() '\n  + 'WHERE id = ' + esc(d.subscriptionId) + '::uuid '\n  + 'RETURNING *';\n\nreturn [{ json: { query: query, allData: d } }];"
      },
      "id": "build-sql-sub",
      "name": "07. Build SQL abonnement (UPDATE)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 500]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.query }}",
        "options": { "queryBatching": "independently" }
      },
      "id": "insert-sub",
      "name": "08. UPDATE abonnement",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1560, 500],
      "credentials": {
        "postgres": { "id": "OGqj65ZoFRileCck", "name": "Supabase Postgres" }
      },
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "var d = $('07. Build SQL abonnement (UPDATE)').first().json.allData;\nvar isStripe = d.checkoutUrl ? true : false;\n\nvar response = {\n  success: true,\n  message: isStripe\n    ? 'Onboarding initié — redirection vers le paiement Stripe'\n    : 'Onboarding terminé — espace client actif',\n  client: d.clientData,\n  subscription: { statut: d.statutAbonnement, plan: d.plan.nomPlan, montant: d.plan.montantMensuel },\n  stripeData: isStripe ? {\n    customerId: d.idClientStripe,\n    checkoutUrl: d.checkoutUrl,\n    requiresPayment: true\n  } : null,\n  checkoutUrl: d.checkoutUrl || null\n};\n\nreturn [{ json: response }];"
      },
      "id": "format-response",
      "name": "09. Formater réponse",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1780, 500]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "respond-webhook",
      "name": "10. Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2000, 400]
    },
    {
      "parameters": {
        "jsCode": "var d = $('07. Build SQL abonnement (UPDATE)').first().json.allData;\nvar cd = d.clientData || {};\nvar clientName = cd.prenom || cd.nom || cd.raisonSociale || 'le client';\nvar stripeInfo = d.checkoutUrl ? ' (Stripe - en attente de paiement)' : ' (sans Stripe - actif)';\n\nfunction esc(v) { return String(v || '').replace(/'/g, \"''\"); }\n\nvar query = \"INSERT INTO notifications (id, tenant_id, titre, message, type, lu, created_at) VALUES (gen_random_uuid(), '\" + esc(d.tenantId) + \"', 'Nouvel onboarding\" + esc(stripeInfo) + \"', 'Espace client créé pour \" + esc(clientName) + \". Plan: \" + esc(d.plan.nomPlan) + \" (\" + d.plan.montantMensuel + \" EUR/mois)\" + esc(stripeInfo) + \"', 'info', false, NOW())\";\n\nreturn [{ json: { query: query } }];"
      },
      "id": "build-notif",
      "name": "11. Build notification",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2000, 600]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.query }}",
        "options": { "queryBatching": "independently" }
      },
      "id": "insert-notif",
      "name": "12. INSERT notification",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [2220, 600],
      "credentials": {
        "postgres": { "id": "OGqj65ZoFRileCck", "name": "Supabase Postgres" }
      },
      "alwaysOutputData": true
    }
  ],
  "connections": {
    "01. Webhook": {
      "main": [[{ "node": "02. Parser + Valider", "type": "main", "index": 0 }]]
    },
    "02. Parser + Valider": {
      "main": [[{ "node": "03. IF Stripe ?", "type": "main", "index": 0 }]]
    },
    "03. IF Stripe ?": {
      "main": [
        [{ "node": "04. Stripe - Créer Customer", "type": "main", "index": 0 }],
        [{ "node": "06b. Sans Stripe (actif direct)", "type": "main", "index": 0 }]
      ]
    },
    "04. Stripe - Créer Customer": {
      "main": [[{ "node": "05. Stripe - Checkout Session", "type": "main", "index": 0 }]]
    },
    "05. Stripe - Checkout Session": {
      "main": [[{ "node": "06. Combiner données Stripe", "type": "main", "index": 0 }]]
    },
    "06. Combiner données Stripe": {
      "main": [[{ "node": "07. Build SQL abonnement (UPDATE)", "type": "main", "index": 0 }]]
    },
    "06b. Sans Stripe (actif direct)": {
      "main": [[{ "node": "07. Build SQL abonnement (UPDATE)", "type": "main", "index": 0 }]]
    },
    "07. Build SQL abonnement (UPDATE)": {
      "main": [[{ "node": "08. UPDATE abonnement", "type": "main", "index": 0 }]]
    },
    "08. UPDATE abonnement": {
      "main": [[{ "node": "09. Formater réponse", "type": "main", "index": 0 }]]
    },
    "09. Formater réponse": {
      "main": [
        [
          { "node": "10. Respond", "type": "main", "index": 0 },
          { "node": "11. Build notification", "type": "main", "index": 0 }
        ]
      ]
    },
    "11. Build notification": {
      "main": [[{ "node": "12. INSERT notification", "type": "main", "index": 0 }]]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null
}