{
  "name": "client-create-from-lead",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "client_create_from_lead",
        "responseMode": "responseNode"
      },
      "id": "01. Webhook",
      "name": "01. Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        100,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "var raw = $input.first().json;\nvar body = raw.body || raw;\nvar data = body.data || body;\nvar tenantId = body.tenantId || raw.tenantId || '';\nvar leadId = data.leadId || data.id || body.leadId || '';\nif (!leadId) throw new Error('ID du lead requis');\nif (!tenantId) throw new Error('Tenant ID requis');\nreturn [{ json: { tenantId: String(tenantId), leadId: String(leadId) } }];"
      },
      "id": "02. Parser",
      "name": "02. Parser",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        300,
        200
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ \"SELECT id, tenant_id, nom, prenom, email, telephone, statut FROM leads WHERE id = '\" + $json.leadId + \"'::uuid AND tenant_id = '\" + $json.tenantId + \"'::uuid\" }}"
      },
      "id": "03. Get Lead",
      "name": "03. Get Lead",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "credentials": {
        "postgres": {
          "name": "Supabase Postgres",
          "id": "OGqj65ZoFRileCck"
        }
      },
      "position": [
        500,
        200
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "var lead = $('03. Get Lead').first().json;\nvar parser = $('02. Parser').first().json;\nif (!lead || !lead.id) throw new Error('Lead introuvable');\nif (!lead.email) throw new Error('Email du lead introuvable');\n\nfunction esc(v) { return v == null ? 'NULL' : \"'\" + String(v).replace(/'/g, \"''\") + \"'\"; }\n\nvar insertQuery = 'INSERT INTO client_finals (id, tenant_id, type, nom, prenom, email, telephone, adresse, statut, created_at, updated_at) VALUES (gen_random_uuid(), ' + esc(parser.tenantId) + '::uuid, ' + esc('b2c') + ', ' + esc(lead.nom) + ', ' + esc(lead.prenom) + ', ' + esc(lead.email) + ', ' + esc(lead.telephone) + ', NULL, ' + esc('actif') + ', NOW(), NOW()) ON CONFLICT (tenant_id, email) DO UPDATE SET nom = EXCLUDED.nom, prenom = EXCLUDED.prenom, telephone = EXCLUDED.telephone, updated_at = NOW() RETURNING *';\n\nvar updateLeadQuery = \"UPDATE leads SET statut = 'converti', updated_at = NOW() WHERE id = \" + esc(lead.id) + \"::uuid AND tenant_id = \" + esc(parser.tenantId) + \"::uuid\";\n\nreturn [{ json: { insertQuery: insertQuery, updateLeadQuery: updateLeadQuery, leadId: lead.id } }];"
      },
      "id": "04. Build SQL",
      "name": "04. Build SQL",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        700,
        200
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.insertQuery }}"
      },
      "id": "05. Create Client",
      "name": "05. Create Client",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "credentials": {
        "postgres": {
          "name": "Supabase Postgres",
          "id": "OGqj65ZoFRileCck"
        }
      },
      "position": [
        900,
        200
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $('04. Build SQL').first().json.updateLeadQuery }}"
      },
      "id": "06. Update Lead Status",
      "name": "06. Update Lead Status",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "credentials": {
        "postgres": {
          "name": "Supabase Postgres",
          "id": "OGqj65ZoFRileCck"
        }
      },
      "position": [
        1100,
        200
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "var client = $('05. Create Client').first().json;\nreturn [{ json: { success: true, message: 'Client créé depuis le lead', client: client } }];"
      },
      "id": "07. Format Response",
      "name": "07. Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1300,
        200
      ]
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems"
      },
      "id": "08. Respond",
      "name": "08. Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1500,
        200
      ]
    }
  ],
  "connections": {
    "01. Webhook": {
      "main": [
        [
          {
            "node": "02. Parser",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "02. Parser": {
      "main": [
        [
          {
            "node": "03. Get Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "03. Get Lead": {
      "main": [
        [
          {
            "node": "04. Build SQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "04. Build SQL": {
      "main": [
        [
          {
            "node": "05. Create Client",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "05. Create Client": {
      "main": [
        [
          {
            "node": "06. Update Lead Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "06. Update Lead Status": {
      "main": [
        [
          {
            "node": "07. Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "07. Format Response": {
      "main": [
        [
          {
            "node": "08. Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  }
}