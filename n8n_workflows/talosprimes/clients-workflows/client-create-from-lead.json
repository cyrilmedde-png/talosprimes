{
  "name": "Clients - Create from Lead (client_create_from_lead) → Get Lead → Create Client → Respond",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "client-create-from-lead",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "Webhook_CreateFromLead",
      "name": "Webhook - client_create_from_lead",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        300,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Parser le payload du webhook\nconst raw = $input.first().json;\nconst payload = (raw && raw.data && typeof raw.data === \"object\") ? { ...raw.data, tenantId: raw.data.tenantId || raw.tenantId } : raw;\n\n// Extraire le tenantId depuis le payload webhook\nconst tenantId = payload?.tenantId || raw?.tenantId || '';\nconst leadId = payload?.leadId || payload?.id ? String(payload.leadId || payload.id) : '';\n\nif (!leadId) throw new Error('ID du lead requis');\nif (!tenantId) throw new Error('Tenant ID requis');\n\nreturn [{ json: { tenantId, leadId } }];\n"
      },
      "id": "Code_Parse",
      "name": "Parser payload",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        540,
        300
      ]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://api.talosprimes.com/api/leads/{{$json.leadId}}",
        "options": {
          "timeout": 15000,
          "response": {
            "response": {
              "fullResponse": false
            }
          }
        }
      },
      "id": "HTTP_GetLead",
      "name": "API TalosPrimes - Get Lead",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        780,
        300
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "REPLACE_WITH_CREDENTIAL_ID",
          "name": "TalosPrimes API Auth"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Préparer les données du client depuis le lead\nconst response = $input.first().json;\nconst _body = (response && response.data && typeof response.data === \"object\") ? { ...response.data, tenantId: response.data.tenantId || response.tenantId } : response;\nconst leadData = _body.data?.lead || _body.data || response;\n\n// Récupérer le tenantId depuis le nœud précédent\nconst parsedData = $('Parser payload').first().json;\nconst tenantId = parsedData.tenantId || '';\n\nconst leadId = leadData.id || leadData.leadId || parsedData.leadId;\nconst nom = leadData.nom || '';\nconst prenom = leadData.prenom || '';\nconst email = leadData.email || '';\nconst telephone = leadData.telephone || '';\n\nif (!leadId) throw new Error('ID du lead introuvable');\nif (!email) throw new Error('Email du lead introuvable');\nif (!nom || !prenom) throw new Error('Nom et prénom du lead requis');\nif (!tenantId) throw new Error('Tenant ID requis');\n\n// Déterminer le type de client (B2C par défaut pour les leads individuels)\nconst type = 'b2c';\n\nreturn [{ json: { tenantId, leadId, type, nom, prenom, email, telephone } }];\n"
      },
      "id": "Code_Prepare",
      "name": "Préparer données client",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1020,
        300
      ]
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "=https://api.talosprimes.com/api/leads/{{$json.leadId}}/statut",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { statut: 'converti' } }}",
        "options": {
          "timeout": 15000
        }
      },
      "id": "HTTP_UpdateLeadStatus",
      "name": "API TalosPrimes - Update Lead Status",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        1260,
        300
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "REPLACE_WITH_CREDENTIAL_ID",
          "name": "TalosPrimes API Auth"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.talosprimes.com/api/clients",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { tenantId: $('Préparer données client').first().json.tenantId, type: $('Préparer données client').first().json.type, nom: $('Préparer données client').first().json.nom, prenom: $('Préparer données client').first().json.prenom, email: $('Préparer données client').first().json.email, telephone: $('Préparer données client').first().json.telephone } }}",
        "options": {
          "timeout": 15000
        }
      },
      "id": "HTTP_CreateClient",
      "name": "API TalosPrimes - Create Client",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        1500,
        300
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "REPLACE_WITH_CREDENTIAL_ID",
          "name": "TalosPrimes API Auth"
        }
      }
    },
    {
      "parameters": {
        "responseBody": "={{ { success: true, message: 'Client créé avec succès depuis le lead', data: $json } }}",
        "responseCode": 200,
        "options": {}
      },
      "id": "Respond_CreateFromLead",
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1740,
        300
      ]
    }
  ],
  "connections": {
    "Webhook - client_create_from_lead": {
      "main": [
        [
          {
            "node": "Parser payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parser payload": {
      "main": [
        [
          {
            "node": "API TalosPrimes - Get Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API TalosPrimes - Get Lead": {
      "main": [
        [
          {
            "node": "Préparer données client",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Préparer données client": {
      "main": [
        [
          {
            "node": "API TalosPrimes - Update Lead Status",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "API TalosPrimes - Create Client",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API TalosPrimes - Update Lead Status": {
      "main": []
    },
    "API TalosPrimes - Create Client": {
      "main": [
        [
          {
            "node": "Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "v1"
}