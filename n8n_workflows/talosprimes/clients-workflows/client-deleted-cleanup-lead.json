{
  "name": "client-deleted-cleanup-lead",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "client-deleted-cleanup-lead",
        "responseMode": "responseNode"
      },
      "id": "01. Webhook",
      "name": "01. Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        100,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "var raw = $input.first().json;\nvar body = raw.body || raw;\nvar data = body.data || body;\nvar email = String(data.email || body.email || raw.email || '').trim().toLowerCase();\nvar tenantId = body.tenantId || raw.tenantId || '';\nif (!email) return [{ json: { email: '', tenantId: tenantId, skip: true } }];\nif (!tenantId) throw new Error('Tenant ID requis');\nreturn [{ json: { email: email, tenantId: String(tenantId), skip: false } }];"
      },
      "id": "02. Parser",
      "name": "02. Parser",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        300,
        200
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": ""
          },
          "conditions": [
            {
              "id": "8d7adf11-9abc-4e9e-a302-83a5e71efb88",
              "leftValue": "={{ $json.skip }}",
              "rightValue": "false",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "03. Skip ?",
      "name": "03. Skip ?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        500,
        200
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ \"SELECT id, tenant_id, nom, prenom, email, statut FROM leads WHERE email = '\" + $('02. Parser').first().json.email.replace(/'/g, \"''\") + \"' AND tenant_id = '\" + $('02. Parser').first().json.tenantId + \"'::uuid AND statut = 'converti' LIMIT 1\" }}"
      },
      "id": "04. Find Lead",
      "name": "04. Find Lead",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "credentials": {
        "postgres": {
          "name": "Supabase Postgres",
          "id": "OGqj65ZoFRileCck"
        }
      },
      "position": [
        700,
        200
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "var lead = $('04. Find Lead').first().json;\nif (!lead || !lead.id) {\n  return [{ json: { found: false, query: 'SELECT 1' } }];\n}\nfunction esc(v) { return v == null ? 'NULL' : \"'\" + String(v).replace(/'/g, \"''\") + \"'\"; }\nvar query = \"UPDATE leads SET statut = 'abandonne', updated_at = NOW() WHERE id = \" + esc(lead.id) + \"::uuid AND tenant_id = \" + esc($('02. Parser').first().json.tenantId) + \"::uuid RETURNING id, nom, prenom, email, statut\";\nreturn [{ json: { found: true, leadId: lead.id, query: query } }];"
      },
      "id": "05. Build Update SQL",
      "name": "05. Build Update SQL",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        900,
        200
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.query }}"
      },
      "id": "06. Update Lead",
      "name": "06. Update Lead",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "credentials": {
        "postgres": {
          "name": "Supabase Postgres",
          "id": "OGqj65ZoFRileCck"
        }
      },
      "position": [
        1100,
        200
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "var buildSql = $('05. Build Update SQL').first().json;\nif (!buildSql.found) {\n  return [{ json: { success: true, message: 'Aucun lead converti trouvé pour cet email' } }];\n}\nvar updated = $('06. Update Lead').first().json;\nreturn [{ json: { success: true, message: 'Lead passé en abandonné', leadId: buildSql.leadId, lead: updated } }];"
      },
      "id": "07. Format Response",
      "name": "07. Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1300,
        200
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}"
      },
      "id": "08. Respond",
      "name": "08. Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1500,
        200
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={ \"success\": true, \"message\": \"Skip - pas d'email client\" }"
      },
      "id": "09. Respond Skip",
      "name": "09. Respond Skip",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        700,
        100
      ]
    }
  ],
  "connections": {
    "01. Webhook": {
      "main": [
        [
          {
            "node": "02. Parser",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "02. Parser": {
      "main": [
        [
          {
            "node": "03. Skip ?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "03. Skip ?": {
      "main": [
        [
          {
            "node": "04. Find Lead",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "09. Respond Skip",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "04. Find Lead": {
      "main": [
        [
          {
            "node": "05. Build Update SQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "05. Build Update SQL": {
      "main": [
        [
          {
            "node": "06. Update Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "06. Update Lead": {
      "main": [
        [
          {
            "node": "07. Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "07. Format Response": {
      "main": [
        [
          {
            "node": "08. Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  }
}
