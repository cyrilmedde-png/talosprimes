{
  "name": "Abonnements - Annulation",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "subscription-cancelled",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-cancel",
      "name": "01. Webhook - Annulation",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        240,
        400
      ],
      "webhookId": "subscription-cancelled"
    },
    {
      "parameters": {
        "jsCode": "// Parser le payload du webhook\nvar raw = $input.item.json;\nvar payload = raw?.body || raw?.json || raw;\nvar data = payload?.data || payload;\n\n// Extraire subscriptionId\nvar subscriptionId = data?.subscriptionId || data?.id || '';\nvar tenantId = payload?.tenantId || data?.tenantId || '';\nvar reason = data?.reason || 'Non spécifié';\nvar cancelAtPeriodEnd = data?.cancelAtPeriodEnd || false; // Annuler immédiatement ou à la fin de la période\nvar cancelledBy = data?.cancelledBy || 'system'; // Qui a annulé\nvar cancelledByEmail = data?.cancelledByEmail || null; // Email de qui a annulé\n\nif (!subscriptionId) {\n  throw new Error('ID de l\\'abonnement requis');\n}\n\nif (!tenantId) {\n  throw new Error('Tenant ID requis');\n}\n\nreturn {\n  json: {\n    subscriptionId,\n    tenantId,\n    reason,\n    cancelAtPeriodEnd,\n    cancelDate: new Date().toISOString(),\n    cancelledBy,\n    cancelledByEmail\n  }\n};"
      },
      "id": "parse-payload",
      "name": "02. Parser payload",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        460,
        400
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ \"SELECT \n  cs.*,\n  cf.email,\n  cf.nom,\n  cf.prenom,\n  cf.raison_sociale\nFROM client_subscriptions cs\nJOIN client_finals cf ON cs.client_final_id = cf.id\nWHERE cs.id = '\" + $json.subscriptionId + \"'::uuid;\" }}",
        "alwaysOutputData": true,
        "options": {
          "queryBatching": "independently"
        }
      },
      "id": "get-subscription",
      "name": "03. Récupérer abonnement",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        680,
        400
      ],
      "credentials": {
        "postgres": {
          "name": "Supabase Postgres",
          "id": "OGqj65ZoFRileCck"
        }
      },
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json[0]?.id }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "validate-subscription",
      "name": "04. Validation",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        900,
        400
      ]
    },
    {
      "parameters": {
        "jsCode": "// Préparer notification admin pour abonnement non trouvé\nvar parseData = $('02. Parser payload').first().json;\nvar timestamp = new Date().toISOString();\n\nreturn {\n  json: {\n    type: 'subscription_not_found',\n    tenantId: parseData.tenantId,\n    subscriptionId: parseData.subscriptionId,\n    timestamp,\n    reason: parseData.reason,\n    cancelledBy: parseData.cancelledBy,\n    cancelledByEmail: parseData.cancelledByEmail,\n    message: `Tentative d'annulation d'un abonnement inexistant: ${parseData.subscriptionId}`\n  }\n};"
      },
      "id": "prepare-admin-notification-error",
      "name": "05a. Préparer notification admin (erreur)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        900,
        600
      ]
    },
    {
      "parameters": {
        "jsCode": "var d = $input.item.json;\nvar query = `INSERT INTO notifications (id, tenant_id, titre, message, type, lu, created_at) VALUES (gen_random_uuid(), '${d.tenantId}', '${d.message}', $3, $4, false, NOW())`;\nreturn [{json:{query}}];"
      },
      "id": "construct-admin-notif",
      "name": "05b. Construire notif erreur",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1120,
        600
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $('05b. Construire notif erreur').first().json.query }}",
        "alwaysOutputData": true,
        "options": {
          "queryBatching": "independently"
        }
      },
      "id": "insert-admin-notif",
      "name": "05c. INSERT notification erreur",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        1340,
        600
      ],
      "credentials": {
        "postgres": {
          "name": "Supabase Postgres",
          "id": "OGqj65ZoFRileCck"
        }
      },
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// Préparer les données pour l'annulation\nvar subscriptionData = $input.item.json[0];\nvar parseData = $('02. Parser payload').first().json;\n\nreturn {\n  json: {\n    subscription: subscriptionData,\n    tenantId: parseData.tenantId,\n    reason: parseData.reason,\n    cancelAtPeriodEnd: parseData.cancelAtPeriodEnd,\n    clientEmail: subscriptionData.email,\n    clientName: subscriptionData.nom || subscriptionData.prenom || subscriptionData.raison_sociale || 'Client',\n    idAbonnementStripe: subscriptionData.id_abonnement_stripe,\n    cancelledBy: parseData.cancelledBy,\n    cancelledByEmail: parseData.cancelledByEmail,\n    cancelDate: parseData.cancelDate\n  }\n};"
      },
      "id": "prepare-cancel",
      "name": "06. Préparer annulation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1120,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.idAbonnementStripe }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "if-stripe",
      "name": "07. IF - Stripe configuré ?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1340,
        300
      ]
    },
    {
      "parameters": {
        "url": "=https://api.stripe.com/v1/subscriptions/{{ $json.idAbonnementStripe }}",
        "method": "DELETE",
        "authentication": "predefinedCredentialType",
        "options": {},
        "genericAuthType": "stripeApi"
      },
      "id": "stripe-cancel-subscription",
      "name": "08. Stripe - Annuler abonnement",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1560,
        200
      ],
      "credentials": {
        "stripeApi": {
          "id": "hTgbVXtv3dG8wSJ4",
          "name": "Stripe API"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.status }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "validate-stripe",
      "name": "08a. Valider réponse Stripe",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1780,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "// Confirmer l'annulation Stripe\nvar stripeResponse = $input.item.json;\nvar prepareData = $('06. Préparer annulation').first().json;\n\nreturn {\n  json: {\n    ...prepareData,\n    stripeCancelled: true,\n    stripeStatus: stripeResponse.status\n  }\n};"
      },
      "id": "confirm-stripe",
      "name": "08b. Confirmer Stripe",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2000,
        100
      ]
    },
    {
      "parameters": {
        "jsCode": "var d = $input.item.json;\nvar query = `INSERT INTO notifications (id, tenant_id, titre, message, type, lu, created_at) VALUES (gen_random_uuid(), '${d.tenantId}', '${d.message}', $3, $4, false, NOW())`;\nreturn [{json:{query}}];"
      },
      "id": "construct-stripe-notif",
      "name": "08d. Construire notif Stripe err",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2220,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Préparer notification d'erreur Stripe\nvar stripeError = $input.item.json;\nvar prepareData = $('06. Préparer annulation').first().json;\nvar timestamp = new Date().toISOString();\n\nreturn {\n  json: {\n    type: 'stripe_cancellation_failed',\n    tenantId: prepareData.tenantId,\n    subscriptionId: prepareData.subscription.id,\n    stripeId: prepareData.idAbonnementStripe,\n    timestamp,\n    error: stripeError.message || 'Erreur inconnue Stripe',\n    reason: prepareData.reason,\n    cancelledBy: prepareData.cancelledBy,\n    cancelledByEmail: prepareData.cancelledByEmail,\n    message: `Échec de l'annulation Stripe: ${stripeError.message || 'Erreur inconnue'}`\n  }\n};"
      },
      "id": "prepare-stripe-error-notification",
      "name": "08c. Préparer notification erreur Stripe",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2000,
        300
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $('08d. Construire notif Stripe err').first().json.query }}",
        "alwaysOutputData": true,
        "options": {
          "queryBatching": "independently"
        }
      },
      "id": "insert-stripe-notif",
      "name": "08e-pg. INSERT notification Stripe err",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        2440,
        300
      ],
      "credentials": {
        "postgres": {
          "name": "Supabase Postgres",
          "id": "OGqj65ZoFRileCck"
        }
      },
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {  success: false, error: 'Stripe cancellation failed: ' + ($input.item.json?.message || 'Unknown error')  } }}",
        "options": {}
      },
      "id": "respond-stripe-error",
      "name": "08f. Répondre erreur Stripe",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        2660,
        300
      ]
    },
    {
      "parameters": {
        "mode": "append",
        "options": {}
      },
      "id": "merge-stripe",
      "name": "09. Merge - Stripe et sans Stripe",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [
        2220,
        100
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ \"UPDATE client_subscriptions\nSET \n  statut = 'annule',\n  updated_at = NOW()\nWHERE id = '\" + $json.subscription.id + \"'::uuid\nRETURNING *;\" }}",
        "alwaysOutputData": true,
        "options": {
          "queryBatching": "independently"
        }
      },
      "id": "update-subscription",
      "name": "10. Annuler abonnement",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        2440,
        100
      ],
      "credentials": {
        "postgres": {
          "name": "Supabase Postgres",
          "id": "OGqj65ZoFRileCck"
        }
      },
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// Préparer l'email de confirmation d'annulation\nvar data = $('09. Merge - Stripe et sans Stripe').first().json;\nvar subscriptionUpdated = $input.item.json[0];\n\nvar clientName = data.clientName || 'Client';\nvar clientEmail = data.clientEmail;\nvar planName = data.subscription.nom_plan;\nvar reason = data.reason;\n\nvar htmlTemplate = `<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n    .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n    .header { background: #dc3545; color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }\n    .content { background: #f9f9f9; padding: 30px; border-radius: 0 0 10px 10px; }\n    .info-box { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; border-left: 4px solid #dc3545; }\n    .footer { text-align: center; margin-top: 30px; color: #666; font-size: 12px; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <h1>Abonnement annulé</h1>\n    </div>\n    <div class=\"content`>\n      <p>Bonjour ${clientName},</p>\n      <p>Nous vous confirmons l'annulation de votre abonnement TalosPrimes.</p>\n      <div class=`info-box`>\n        <h3>Détails de l'annulation :</h3>\n        <p><strong>Plan :</strong> ${planName}</p>\n        <p><strong>Date d'annulation :</strong> ${new Date().toLocaleDateString('fr-FR')}</p>\n        <p><strong>Raison :</strong> ${reason}</p>\n      </div>\n      <p>Nous sommes désolés de vous voir partir. Si vous changez d'avis, vous pouvez réactiver votre abonnement à tout moment.</p>\n      <p>Cordialement,<br>L'équipe TalosPrimes</p>\n    </div>\n    <div class=`footer\">\n      <p>Cet email a été envoyé automatiquement.</p>\n    </div>\n  </div>\n</body>\n</html>`;\n\nreturn {\n  json: {\n    toEmail: clientEmail,\n    subject: `Confirmation d'annulation de votre abonnement ${planName}`,\n    htmlBody: htmlTemplate\n  }\n};"
      },
      "id": "prepare-email",
      "name": "11. Préparer email",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2880,
        100
      ]
    },
    {
      "parameters": {
        "fromEmail": "noreply@talosprimes.com",
        "toEmail": "={{ $json.toEmail }}",
        "subject": "={{ $json.subject }}",
        "emailFormat": "html",
        "html": "={{ $json.htmlBody }}"
      },
      "id": "send-email",
      "name": "12. Envoyer email",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        3100,
        100
      ],
      "credentials": {
        "smtp": {
          "id": "hepAQJGA9ubd1NF4",
          "name": "SMTP TalosPrimes"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Préparer notification TalosPrimes API après succès email\nvar mergeData = $('09. Merge - Stripe et sans Stripe').first().json;\nvar emailResponse = $input.item.json;\nvar timestamp = new Date().toISOString();\n\nreturn {\n  json: {\n    type: 'subscription_cancelled',\n    tenantId: mergeData.tenantId,\n    subscriptionId: mergeData.subscription.id,\n    clientId: mergeData.subscription.client_final_id,\n    clientEmail: mergeData.clientEmail,\n    planName: mergeData.subscription.nom_plan,\n    timestamp,\n    reason: mergeData.reason,\n    cancelAtPeriodEnd: mergeData.cancelAtPeriodEnd,\n    stripeCancelled: mergeData.stripeCancelled || false,\n    stripeStatus: mergeData.stripeStatus || null,\n    auditTrail: {\n      cancelledBy: mergeData.cancelledBy,\n      cancelledByEmail: mergeData.cancelledByEmail,\n      cancelDate: mergeData.cancelDate,\n      emailSent: true,\n      emailId: emailResponse.id || null\n    },\n    message: `Abonnement ${mergeData.subscription.nom_plan} annulé pour ${mergeData.clientEmail}`\n  }\n};"
      },
      "id": "prepare-notification",
      "name": "13. Préparer notification TalosPrimes",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3320,
        100
      ]
    },
    {
      "parameters": {
        "jsCode": "var d = $input.item.json;\nvar query = `INSERT INTO notifications (id, tenant_id, titre, message, type, lu, created_at) VALUES (gen_random_uuid(), '${d.tenantId}', '${d.message}', $3, $4, false, NOW())`;\nreturn [{json:{query}}];"
      },
      "id": "construct-success-notif",
      "name": "14. Construire notif succès",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3540,
        100
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $('14. Construire notif succès').first().json.query }}",
        "alwaysOutputData": true,
        "options": {
          "queryBatching": "independently"
        }
      },
      "id": "insert-success-notif",
      "name": "14b. INSERT notification",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        3760,
        100
      ],
      "credentials": {
        "postgres": {
          "name": "Supabase Postgres",
          "id": "OGqj65ZoFRileCck"
        }
      },
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { success: true, message: 'Abonnement annulé avec succès', data: { subscription: $node['10. Annuler abonnement'].json[0] } } }}",
        "options": {}
      },
      "id": "respond-success",
      "name": "15. Répondre succès",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        3980,
        100
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {  success: false, error: 'Abonnement non trouvé'  } }}",
        "options": {}
      },
      "id": "respond-error",
      "name": "16. Répondre erreur (non trouvé)",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1560,
        600
      ]
    }
  ],
  "connections": {
    "01. Webhook - Annulation": {
      "main": [
        [
          {
            "node": "02. Parser payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "02. Parser payload": {
      "main": [
        [
          {
            "node": "03. Récupérer abonnement",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "03. Récupérer abonnement": {
      "main": [
        [
          {
            "node": "04. Validation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "04. Validation": {
      "main": [
        [
          {
            "node": "06. Préparer annulation",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "05a. Préparer notification admin (erreur)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "05a. Préparer notification admin (erreur)": {
      "main": [
        [
          {
            "node": "05b. Construire notif erreur",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "05b. Construire notif erreur": {
      "main": [
        [
          {
            "node": "05c. INSERT notification erreur",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "05c. INSERT notification erreur": {
      "main": [
        [
          {
            "node": "16. Répondre erreur (non trouvé)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "06. Préparer annulation": {
      "main": [
        [
          {
            "node": "07. IF - Stripe configuré ?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "07. IF - Stripe configuré ?": {
      "main": [
        [
          {
            "node": "08. Stripe - Annuler abonnement",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "09. Merge - Stripe et sans Stripe",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "08. Stripe - Annuler abonnement": {
      "main": [
        [
          {
            "node": "08a. Valider réponse Stripe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "08a. Valider réponse Stripe": {
      "main": [
        [
          {
            "node": "08b. Confirmer Stripe",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "08c. Préparer notification erreur Stripe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "08b. Confirmer Stripe": {
      "main": [
        [
          {
            "node": "09. Merge - Stripe et sans Stripe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "08c. Préparer notification erreur Stripe": {
      "main": [
        [
          {
            "node": "08d. Construire notif Stripe err",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "08d. Construire notif Stripe err": {
      "main": [
        [
          {
            "node": "08e-pg. INSERT notification Stripe err",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "08e-pg. INSERT notification Stripe err": {
      "main": [
        [
          {
            "node": "08f. Répondre erreur Stripe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "09. Merge - Stripe et sans Stripe": {
      "main": [
        [
          {
            "node": "10. Annuler abonnement",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "10. Annuler abonnement": {
      "main": [
        [
          {
            "node": "11. Préparer email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "11. Préparer email": {
      "main": [
        [
          {
            "node": "12. Envoyer email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "12. Envoyer email": {
      "main": [
        [
          {
            "node": "13. Préparer notification TalosPrimes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "13. Préparer notification TalosPrimes": {
      "main": [
        [
          {
            "node": "14. Construire notif succès",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "14. Construire notif succès": {
      "main": [
        [
          {
            "node": "14b. INSERT notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "14b. INSERT notification": {
      "main": [
        [
          {
            "node": "15. Répondre succès",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "_comment": "Updated 2026-02-21. Converted: Postgres credential OGqj65ZoFRileCck, HTTP notifications→direct Postgres INSERT, emailFormat fix. Tested OK."
}