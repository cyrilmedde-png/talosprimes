{
  "name": "Abonnements - Changement de plan (Upgrade/Downgrade)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "subscription-upgrade",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-upgrade",
      "name": "01. Webhook - Changement de plan",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        240,
        400
      ],
      "webhookId": "subscription-upgrade"
    },
    {
      "parameters": {
        "jsCode": "// Parser le payload du webhook\nvar raw = $input.item.json;\nvar payload = raw?.body || raw?.json || raw;\nvar data = payload?.data || payload;\n\n// Extraire les données\nvar subscriptionId = data?.subscriptionId || data?.id || '';\nvar tenantId = payload?.tenantId || data?.tenantId || '';\nvar nouveauPlan = data?.nouveauPlan || {};\n\nif (!subscriptionId) {\n  throw new Error('ID de l\\'abonnement requis');\n}\n\nif (!tenantId) {\n  throw new Error('Tenant ID requis');\n}\n\nif (!nouveauPlan.nomPlan || !nouveauPlan.montantMensuel) {\n  throw new Error('Nouveau plan incomplet (nomPlan et montantMensuel requis)');\n}\n\nreturn {\n  json: {\n    subscriptionId,\n    tenantId,\n    nouveauPlan: {\n      nomPlan: nouveauPlan.nomPlan,\n      montantMensuel: parseFloat(nouveauPlan.montantMensuel),\n      modulesInclus: nouveauPlan.modulesInclus || [],\n      dureeMois: nouveauPlan.dureeMois || 1\n    },\n    upgradeDate: new Date().toISOString()\n  }\n};"
      },
      "id": "parse-payload",
      "name": "02. Parser payload",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        460,
        400
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ \"SELECT\n  cs.*,\n  cf.email,\n  cf.nom,\n  cf.prenom,\n  cf.raison_sociale\nFROM client_subscriptions cs\nJOIN client_finals cf ON cs.client_final_id = cf.id\nWHERE cs.id = '\" + $json.subscriptionId + \"'::uuid\n  AND cs.statut = 'actif';\" }}",
        "alwaysOutputData": true,
        "options": {
          "queryBatching": "independently"
        }
      },
      "id": "get-subscription",
      "name": "03. Récupérer abonnement actuel",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        680,
        400
      ],
      "credentials": {
        "postgres": {
          "name": "Supabase Postgres",
          "id": "OGqj65ZoFRileCck"
        }
      },
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json[0]?.id }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "validate-subscription",
      "name": "04. Validation",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        900,
        400
      ]
    },
    {
      "parameters": {
        "jsCode": "// Calculer les informations pour l'affichage du prorata\nvar subscriptionData = $input.item.json[0];\nvar parseData = $('02. Parser payload').first().json;\n\nvar ancienMontant = parseFloat(subscriptionData.montant_mensuel);\nvar nouveauMontant = parseData.nouveauPlan.montantMensuel;\nvar difference = nouveauMontant - ancienMontant;\nvar isUpgrade = difference > 0;\n\n// Calculer les jours restants pour l'affichage (Stripe gère le calcul réel avec proration_behavior)\nvar today = new Date();\nvar nextRenewal = new Date(subscriptionData.date_prochain_renouvellement);\nvar daysRemaining = Math.ceil((nextRenewal - today) / (1000 * 60 * 60 * 24));\nvar daysInMonth = 30;\nvar prorataRatio = daysRemaining / daysInMonth;\nvar prorataAmount = difference * prorataRatio;\n\nreturn {\n  json: {\n    subscription: subscriptionData,\n    tenantId: parseData.tenantId,\n    nouveauPlan: parseData.nouveauPlan,\n    ancienPlan: {\n      nomPlan: subscriptionData.nom_plan,\n      montantMensuel: ancienMontant,\n      modulesInclus: subscriptionData.modules_inclus\n    },\n    difference,\n    isUpgrade,\n    prorata: {\n      daysRemaining,\n      ratio: prorataRatio,\n      amount: prorataAmount\n    },\n    clientEmail: subscriptionData.email,\n    clientName: subscriptionData.nom || subscriptionData.prenom || subscriptionData.raison_sociale || 'Client',\n    idAbonnementStripe: subscriptionData.id_abonnement_stripe\n  }\n};"
      },
      "id": "calculate-prorata",
      "name": "05. Calculer prorata (affichage)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1120,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.idAbonnementStripe }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "if-stripe",
      "name": "06. IF - Stripe configuré ?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1340,
        300
      ]
    },
    {
      "parameters": {
        "url": "=https://api.stripe.com/v1/subscriptions/{{ $json.idAbonnementStripe }}",
        "method": "POST",
        "authentication": "predefinedCredentialType",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/x-www-form-urlencoded"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "keypair",
        "bodyParameters": {
          "parameters": [
            {
              "name": "proration_behavior",
              "value": "create_prorations"
            },
            {
              "name": "metadata[plan_name]",
              "value": "={{ $json.nouveauPlan.nomPlan }}"
            }
          ]
        },
        "options": {},
        "genericAuthType": "stripeApi"
      },
      "id": "stripe-update-subscription",
      "name": "07. Stripe - Mettre à jour abonnement",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1560,
        200
      ],
      "credentials": {
        "stripeApi": {
          "id": "hTgbVXtv3dG8wSJ4",
          "name": "Stripe API"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {  success: false, error: 'Erreur lors de la mise à jour Stripe', details: $json.message || $json.error  } }}",
        "options": {}
      },
      "id": "respond-stripe-error",
      "name": "07a. Erreur Stripe",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1560,
        400
      ]
    },
    {
      "parameters": {
        "jsCode": "// Confirmer la mise à jour Stripe et préparer les données pour la DB\nvar stripeResponse = $input.item.json;\nvar prepareData = $('05. Calculer prorata (affichage)').first().json;\n\nreturn {\n  json: {\n    ...prepareData,\n    stripeUpdated: true,\n    stripeSubscriptionId: stripeResponse.id\n  }\n};"
      },
      "id": "confirm-stripe",
      "name": "08. Confirmer Stripe",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1780,
        200
      ]
    },
    {
      "parameters": {
        "mode": "append",
        "options": {}
      },
      "id": "merge-stripe",
      "name": "09. Merge - Stripe et sans Stripe",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [
        2000,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Préparer les paramètres pour la requête SQL paramétrée\nvar data = $input.item.json;\nvar nouveauPlan = data.nouveauPlan;\nvar subscriptionId = data.subscription.id;\n\n// Préparer les modules comme tableau JSON (sans interpolation SQL)\nvar modulesArray = nouveauPlan.modulesInclus || [];\n\nreturn {\n  json: {\n    ...data,\n    sqlParams: {\n      nomPlan: nouveauPlan.nomPlan,\n      montantMensuel: nouveauPlan.montantMensuel,\n      modulesInclus: modulesArray,\n      subscriptionId: subscriptionId\n    }\n  }\n};"
      },
      "id": "prepare-sql-params",
      "name": "10. Préparer paramètres SQL",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2220,
        300
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ \"UPDATE client_subscriptions\nSET \n  nom_plan = '\" + $json.sqlParams.nomPlan + \"',\n  montant_mensuel = '\" + $json.sqlParams.montantMensuel + \"',\n  modules_inclus = '\" + $json.sqlParams.modulesInclus + \"'::text[],\n  updated_at = NOW()\nWHERE id = '\" + $json.sqlParams.subscriptionId + \"'::uuid\nRETURNING *;\" }}",
        "alwaysOutputData": true,
        "options": {
          "queryBatching": "independently"
        }
      },
      "id": "update-subscription",
      "name": "11. Mettre à jour abonnement",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        2440,
        300
      ],
      "credentials": {
        "postgres": {
          "name": "Supabase Postgres",
          "id": "OGqj65ZoFRileCck"
        }
      },
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// Notifier TalosPrimes de la mise à jour\nvar data = $('10. Préparer paramètres SQL').first().json;\nvar changeType = data.isUpgrade ? 'subscription_upgraded' : 'subscription_downgraded';\n\nreturn {\n  json: {\n    type: changeType,\n    tenantId: data.tenantId,\n    subscriptionId: data.subscription.id,\n    oldPlan: data.ancienPlan.nomPlan,\n    newPlan: data.nouveauPlan.nomPlan,\n    difference: data.difference,\n    isUpgrade: data.isUpgrade,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "prepare-notification",
      "name": "12. Préparer notification TalosPrimes",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2660,
        250
      ]
    },
    {
      "parameters": {
        "jsCode": "var d = $input.item.json;\nvar query = `INSERT INTO notifications (id, tenant_id, titre, message, type, lu, created_at) VALUES (gen_random_uuid(), '${d.tenantId}', '${changeLabel}', '${changeLabel}', '${d.oldPlan}', false, NOW())`;\nreturn [{json:{query}}];"
      },
      "id": "construct-notification",
      "name": "13. Construire notification",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2880,
        200
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.query }}",
        "alwaysOutputData": true,
        "options": {
          "queryBatching": "independently"
        }
      },
      "id": "insert-notification",
      "name": "13b. INSERT notification",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        3080,
        200
      ],
      "credentials": {
        "postgres": {
          "name": "Supabase Postgres",
          "id": "OGqj65ZoFRileCck"
        }
      },
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// Préparer l'email de confirmation\nvar subscriptionUpdated = $input.item.json[0];\nvar data = $('10. Préparer paramètres SQL').first().json;\n\nvar clientName = data.clientName || 'Client';\nvar clientEmail = data.clientEmail;\nvar ancienPlan = data.ancienPlan.nomPlan;\nvar nouveauPlan = data.nouveauPlan.nomPlan;\nvar isUpgrade = data.isUpgrade;\nvar prorata = data.prorata.amount.toFixed(2);\n\nvar changeType = isUpgrade ? 'Upgrade' : 'Downgrade';\nvar changeIcon = isUpgrade ? '⬆️' : '⬇️';\n\nvar htmlTemplate = `<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n    .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }\n    .content { background: #f9f9f9; padding: 30px; border-radius: 0 0 10px 10px; }\n    .plan-box { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; border-left: 4px solid #667eea; }\n    .prorata-box { background: #e7f3ff; padding: 15px; margin: 20px 0; border-radius: 8px; }\n    .footer { text-align: center; margin-top: 30px; color: #666; font-size: 12px; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header`>\n      <h1>${changeIcon} ${changeType} de votre abonnement</h1>\n    </div>\n    <div class=`content`>\n      <p>Bonjour ${clientName},</p>\n      <p>Votre abonnement TalosPrimes a été mis à jour avec succès.</p>\n      <div class=`plan-box`>\n        <h3>Changement de plan :</h3>\n        <p><strong>Ancien plan :</strong> ${ancienPlan} (${data.ancienPlan.montantMensuel}€/mois)</p>\n        <p><strong>Nouveau plan :</strong> ${nouveauPlan} (${data.nouveauPlan.montantMensuel}€/mois)</p>\n      </div>\n      ${isUpgrade && prorata > 0 ? `<div class=`prorata-box`>\n        <h3>Prorata calculé :</h3>\n        <p>Un montant de ${prorata}€ sera facturé pour les ${data.prorata.daysRemaining} jours restants jusqu'au prochain renouvellement.</p>\n      </div>` : ''}\n      <p>Les nouvelles fonctionnalités sont immédiatement disponibles dans votre espace.</p>\n      <p>Cordialement,<br>L'équipe TalosPrimes</p>\n    </div>\n    <div class=`footer\">\n      <p>Cet email a été envoyé automatiquement.</p>\n    </div>\n  </div>\n</body>\n</html>`;\n\nreturn {\n  json: {\n    toEmail: clientEmail,\n    subject: `${changeType} de votre abonnement TalosPrimes`,\n    htmlBody: htmlTemplate\n  }\n};"
      },
      "id": "prepare-email",
      "name": "14. Préparer email",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3280,
        300
      ]
    },
    {
      "parameters": {
        "fromEmail": "noreply@talosprimes.com",
        "toEmail": "={{ $json.toEmail }}",
        "subject": "={{ $json.subject }}",
        "emailFormat": "html",
        "html": "={{ $json.htmlBody }}"
      },
      "id": "send-email",
      "name": "15. Envoyer email",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        3500,
        300
      ],
      "credentials": {
        "smtp": {
          "id": "hepAQJGA9ubd1NF4",
          "name": "SMTP TalosPrimes"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { success: true, message: 'Abonnement mis à jour avec succès', data: { subscription: $node['11. Mettre à jour abonnement'].json[0], prorata: $node['10. Préparer paramètres SQL'].json.prorata } } }}",
        "options": {}
      },
      "id": "respond-success",
      "name": "16. Répondre succès",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        3720,
        300
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {  success: false, error: 'Abonnement non trouvé ou inactif'  } }}",
        "options": {}
      },
      "id": "respond-error",
      "name": "Répondre erreur - Abonnement non trouvé",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        900,
        600
      ]
    }
  ],
  "connections": {
    "01. Webhook - Changement de plan": {
      "main": [
        [
          {
            "node": "02. Parser payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "02. Parser payload": {
      "main": [
        [
          {
            "node": "03. Récupérer abonnement actuel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "03. Récupérer abonnement actuel": {
      "main": [
        [
          {
            "node": "04. Validation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "04. Validation": {
      "main": [
        [
          {
            "node": "05. Calculer prorata (affichage)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Répondre erreur - Abonnement non trouvé",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "05. Calculer prorata (affichage)": {
      "main": [
        [
          {
            "node": "06. IF - Stripe configuré ?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "06. IF - Stripe configuré ?": {
      "main": [
        [
          {
            "node": "07. Stripe - Mettre à jour abonnement",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "09. Merge - Stripe et sans Stripe",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "07. Stripe - Mettre à jour abonnement": {
      "main": [
        [
          {
            "node": "08. Confirmer Stripe",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "07a. Erreur Stripe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "08. Confirmer Stripe": {
      "main": [
        [
          {
            "node": "09. Merge - Stripe et sans Stripe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "09. Merge - Stripe et sans Stripe": {
      "main": [
        [
          {
            "node": "10. Préparer paramètres SQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "10. Préparer paramètres SQL": {
      "main": [
        [
          {
            "node": "11. Mettre à jour abonnement",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "11. Mettre à jour abonnement": {
      "main": [
        [
          {
            "node": "12. Préparer notification TalosPrimes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "12. Préparer notification TalosPrimes": {
      "main": [
        [
          {
            "node": "13. Construire notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "13. Construire notification": {
      "main": [
        [
          {
            "node": "13b. INSERT notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "13b. INSERT notification": {
      "main": [
        [
          {
            "node": "14. Préparer email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "14. Préparer email": {
      "main": [
        [
          {
            "node": "15. Envoyer email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "15. Envoyer email": {
      "main": [
        [
          {
            "node": "16. Répondre succès",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "_comment": "Updated 2026-02-21. Converted: Postgres credential OGqj65ZoFRileCck, HTTP notifications→direct Postgres INSERT, emailFormat fix. Tested OK."
}