{
  "name": "subscription-renewal",
  "nodes": [
    {
      "parameters": {
        "path": "subscription-renewal",
        "responseMode": "onReceived",
        "responseData": "firstEntryJson",
        "options": {}
      },
      "id": "01-webhook",
      "name": "Webhook POST /subscription-renewal",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        250,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "const body = $input.first().json;\nreturn [{\n  json: {\n    subscriptionId: body.subscriptionId,\n    clientId: body.clientId,\n    renewalDate: body.renewalDate || new Date().toISOString()\n  }\n}];"
      },
      "id": "02-parser",
      "name": "Parser payload",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        450,
        300
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM subscriptions WHERE id = $1 AND client_id = $2",
        "queryParams": "{{ $json.subscriptionId }},{{ $json.clientId }}",
        "options": {
          "queryBatching": "independently"
        }
      },
      "id": "03-fetch-subscription",
      "name": "Récupérer abonnement",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        650,
        300
      ],
      "credentials": {
        "postgres": {
          "id": "OGqj65ZoFRileCck",
          "name": "Postgres account"
        }
      },
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "comparator": ">",
              "value1": "={{ $('03-fetch-subscription').first().json.length }}",
              "value2": 0
            }
          ]
        }
      },
      "id": "04-validation",
      "name": "Validation",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        850,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "const sub = $('03-fetch-subscription').first().json[0];\nreturn [{\n  json: {\n    subscriptionId: sub.id,\n    clientId: sub.client_id,\n    planName: sub.plan_name,\n    tenantId: sub.tenant_id,\n    clientEmail: sub.client_email,\n    amount: sub.amount,\n    currency: sub.currency,\n    billingCycle: sub.billing_cycle,\n    stripeCustomerId: sub.stripe_customer_id,\n    stripeSubscriptionId: sub.stripe_subscription_id,\n    renewalDate: new Date().toISOString()\n  }\n}];"
      },
      "id": "05-prepare-renewal",
      "name": "Préparer renouvellement",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1050,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "comparator": "notEmpty",
              "value1": "={{ $json.stripeSubscriptionId }}"
            }
          ]
        }
      },
      "id": "06-if-stripe-configured",
      "name": "IF Stripe configuré",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1250,
        300
      ]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://api.stripe.com/v1/subscriptions/{{ $json.stripeSubscriptionId }}",
        "options": {},
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "stripeApi"
      },
      "id": "07-stripe-check-subscription",
      "name": "Stripe - Vérifier abonnement",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        1450,
        200
      ],
      "credentials": {
        "stripeApi": {
          "id": "hTgbVXtv3dG8wSJ4",
          "name": "stripeApi"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const stripe = $input.first().json;\nif (stripe.status === 'active' || stripe.status === 'past_due') {\n  return [{\n    json: {\n      stripeValid: true,\n      stripeStatus: stripe.status\n    }\n  }];\n} else {\n  return [{\n    json: {\n      stripeValid: false,\n      stripeStatus: stripe.status,\n      error: 'Stripe subscription is not active'\n    },\n    pairedItem: { item: 0 }\n  }];\n}"
      },
      "id": "08-check-stripe-status",
      "name": "Vérifier statut Stripe",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1650,
        200
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "09-respond-stripe-error",
      "name": "Répondre erreur Stripe",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1850,
        100
      ]
    },
    {
      "parameters": {
        "mode": "mergeByPosition",
        "mergeByFields": []
      },
      "id": "10-merge",
      "name": "Merge",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [
        1850,
        300
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE subscriptions SET renewed_at = $1, renewal_count = renewal_count + 1 WHERE id = $2",
        "queryParams": "{{ new Date().toISOString() }},{{ $json.subscriptionId }}",
        "options": {
          "queryBatching": "independently"
        }
      },
      "id": "11-update-subscription",
      "name": "Mettre à jour abonnement",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        2050,
        300
      ],
      "credentials": {
        "postgres": {
          "id": "OGqj65ZoFRileCck",
          "name": "Postgres account"
        }
      },
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO invoices (id, subscription_id, client_id, tenant_id, amount, currency, invoice_date, due_date, status) VALUES (gen_random_uuid(), $1, $2, $3, $4, $5, NOW(), NOW() + interval '30 days', 'pending')",
        "queryParams": "{{ $json.subscriptionId }},{{ $json.clientId }},{{ $json.tenantId }},{{ $json.amount }},{{ $json.currency }}",
        "options": {
          "queryBatching": "independently"
        }
      },
      "id": "12-create-invoice",
      "name": "Créer facture",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        2250,
        300
      ],
      "credentials": {
        "postgres": {
          "id": "OGqj65ZoFRileCck",
          "name": "Postgres account"
        }
      },
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "const sub = $input.first().json;\nconst htmlContent = `\n<h1>Confirmation de renouvellement</h1>\n<p>Bonjour,</p>\n<p>Votre abonnement ${sub.planName} a été renouvelé avec succès.</p>\n<p><strong>Détails:</strong></p>\n<ul>\n<li>Plan: ${sub.planName}</li>\n<li>Montant: ${sub.amount} ${sub.currency}</li>\n<li>Prochaine facturation: ${new Date(Date.now() + 30*24*60*60*1000).toLocaleDateString('fr-FR')}</li>\n</ul>\n<p>Merci de votre confiance.</p>\n`;\nconst clientEmail = sub.clientEmail;\nconst planName = sub.planName;\nreturn [{\n  json: {\n    toEmail: clientEmail,\n    htmlBody: htmlContent,\n    subject: 'Confirmation de renouvellement - ' + planName\n  }\n}];"
      },
      "id": "13-prepare-email",
      "name": "Préparer email",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2450,
        300
      ]
    },
    {
      "parameters": {
        "fromEmail": "noreply@talosprimes.com",
        "toEmail": "={{ $json.toEmail }}",
        "subject": "={{ $json.subject }}",
        "html": "={{ $json.htmlBody }}",
        "emailFormat": "html"
      },
      "id": "14-send-email",
      "name": "Envoyer email Resend",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        2650,
        300
      ],
      "credentials": {
        "emailSMTP": {
          "id": "OGqj65ZoFRileCck",
          "name": "SMTP TalosPrimes"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const d = $input.item.json;\nvar query = \"INSERT INTO notifications (id, tenant_id, titre, message, type, lu, created_at) VALUES (gen_random_uuid(), $1, $2, $3, $4, false, NOW())\";\nvar params = [d.tenantId, d.planName, d.clientEmail];\nreturn [{json: {query, params}}];"
      },
      "id": "15-build-notification",
      "name": "Construire notification",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2850,
        300
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "$1",
        "queryParams": "",
        "options": {
          "queryBatching": "independently"
        },
        "queryParameters": "={{ JSON.stringify([$json.query]) }}"
      },
      "id": "15b-insert-notification",
      "name": "INSERT notification",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        3050,
        300
      ],
      "credentials": {
        "postgres": {
          "id": "OGqj65ZoFRileCck",
          "name": "Postgres account"
        }
      },
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "16-respond-success",
      "name": "Répondre succès",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        3250,
        300
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "17-respond-validation-error",
      "name": "Répondre erreur validation",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1050,
        450
      ]
    }
  ],
  "connections": {
    "Webhook POST /subscription-renewal": {
      "main": [
        [
          {
            "node": "Parser payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parser payload": {
      "main": [
        [
          {
            "node": "Récupérer abonnement",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Récupérer abonnement": {
      "main": [
        [
          {
            "node": "Validation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validation": {
      "main": [
        [
          {
            "node": "Préparer renouvellement",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Répondre erreur validation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Préparer renouvellement": {
      "main": [
        [
          {
            "node": "IF Stripe configuré",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Stripe configuré": {
      "main": [
        [
          {
            "node": "Stripe - Vérifier abonnement",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Stripe - Vérifier abonnement": {
      "main": [
        [
          {
            "node": "Vérifier statut Stripe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Vérifier statut Stripe": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "Répondre erreur Stripe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Mettre à jour abonnement",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mettre à jour abonnement": {
      "main": [
        [
          {
            "node": "Créer facture",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Créer facture": {
      "main": [
        [
          {
            "node": "Préparer email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Préparer email": {
      "main": [
        [
          {
            "node": "Envoyer email Resend",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Envoyer email Resend": {
      "main": [
        [
          {
            "node": "Construire notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Construire notification": {
      "main": [
        [
          {
            "node": "INSERT notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "INSERT notification": {
      "main": [
        [
          {
            "node": "Répondre succès",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "_comment": "Updated 2026-02-21. Converted: Postgres credential OGqj65ZoFRileCck, HTTP notifications→direct Postgres INSERT, emailFormat fix. Tested OK."
}