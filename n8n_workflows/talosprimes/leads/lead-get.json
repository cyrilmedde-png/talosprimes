{
  "name": "Leads - Get (lead_get) → Postgres Direct → Respond",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "lead-get",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "Webhook_LeadGet",
      "name": "Webhook - lead_get",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        300,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Parser le payload: { body: { data: { id } } }\nconst raw = $input.first().json;\nconst body = (raw && raw.body && typeof raw.body === \"object\") ? raw.body : raw;\nconst payload = (body && body.data && typeof body.data === \"object\") ? { ...body.data, tenantId: body.data.tenantId || body.tenantId } : body;\nconst data = (payload && typeof payload === 'object' && 'data' in payload) ? payload.data : (payload ?? {});\n\nconst id = data?.id ? String(data.id).trim() : null;\n\nif (!id) {\n  throw new Error('ID du lead requis');\n}\n\nreturn [{ json: { id } }];\n"
      },
      "id": "Code_Parse",
      "name": "Parser ID",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        520,
        300
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT \n  id, \n  nom, \n  prenom, \n  email, \n  telephone, \n  statut, \n  source, \n  notes, \n  date_contact, \n  created_at, \n  updated_at\nFROM leads\nWHERE id = '{{ $json.id }}';"
      },
      "id": "Postgres_Select",
      "name": "Postgres - SELECT lead",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        740,
        300
      ],
      "credentials": {
        "postgres": {
          "id": "REPLACE_WITH_POSTGRES_CREDENTIAL_ID",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Formater la réponse: { lead: {...} }\nconst items = $input.all();\n\nif (items.length === 0) {\n  return [{ json: { success: false, error: 'Lead non trouvé' } }];\n}\n\nconst lead = items[0].json;\n\nreturn [{ \n  json: { \n    success: true, \n    data: { \n      lead: {\n        id: lead.id,\n        nom: lead.nom,\n        prenom: lead.prenom,\n        email: lead.email,\n        telephone: lead.telephone,\n        statut: lead.statut,\n        source: lead.source,\n        notes: lead.notes ?? null,\n        dateContact: lead.date_contact ?? null,\n        createdAt: lead.created_at,\n        updatedAt: lead.updated_at\n      }\n    } \n  } \n}];\n"
      },
      "id": "Code_Format",
      "name": "Formater réponse",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        960,
        300
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}"
      },
      "id": "Respond_LeadGet",
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1180,
        300
      ]
    }
  ],
  "connections": {
    "Webhook - lead_get": {
      "main": [
        [
          {
            "node": "Parser ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parser ID": {
      "main": [
        [
          {
            "node": "Postgres - SELECT lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres - SELECT lead": {
      "main": [
        [
          {
            "node": "Formater réponse",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formater réponse": {
      "main": [
        [
          {
            "node": "Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "v1"
}
