{
  "name": "Deploy - Auto Publish All Workflows",
  "nodes": [
    {
      "parameters": {
        "path": "deploy-publish-all",
        "httpMethod": "POST",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "01. Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [200, 300]
    },
    {
      "parameters": {
        "jsCode": "// Lister tous les workflows via l'API REST interne n8n\n// $env est la facon d'acceder aux variables d'environnement dans n8n Code nodes\nconst baseUrl = 'http://localhost:5678';\nconst apiKey = $env.N8N_API_KEY || '';\n\nconst headers = { 'Content-Type': 'application/json' };\nif (apiKey) headers['X-N8N-API-KEY'] = apiKey;\n\nlet allWorkflows = [];\nlet cursor = '';\n\n// Pagination pour recuperer tous les workflows\nfor (let page = 0; page < 20; page++) {\n  let url = `${baseUrl}/api/v1/workflows?limit=250`;\n  if (cursor) url += `&cursor=${cursor}`;\n\n  const resp = await fetch(url, { headers });\n  if (!resp.ok) throw new Error(`API error: ${resp.status} ${resp.statusText}`);\n\n  const data = await resp.json();\n  const wfs = data.data || [];\n  allWorkflows.push(...wfs);\n\n  cursor = data.nextCursor || '';\n  if (!cursor || wfs.length === 0) break;\n}\n\n// Filtrer: seulement les actifs, exclure ce workflow lui-meme\nconst selfName = 'Deploy - Auto Publish All Workflows';\nconst activeWorkflows = allWorkflows.filter(w => w.active && w.name !== selfName);\n\n// Retourner chaque workflow comme un item separe\nreturn activeWorkflows.map(w => ({ json: { id: w.id, name: w.name } }));"
      },
      "id": "list-workflows",
      "name": "02. Lister Workflows (API)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [440, 300]
    },
    {
      "parameters": {
        "resource": "workflow",
        "operation": "deactivate",
        "workflowId": "={{ $json.id }}"
      },
      "id": "deactivate-workflow",
      "name": "03. Deactivate",
      "type": "n8n-nodes-base.n8n",
      "typeVersion": 1,
      "position": [700, 300],
      "credentials": {
        "n8nApi": {
          "id": "REPLACE_N8N_API_CRED_ID",
          "name": "n8n API"
        }
      }
    },
    {
      "parameters": {
        "amount": 0.5,
        "unit": "seconds"
      },
      "id": "wait-node",
      "name": "04. Wait 500ms",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [940, 300]
    },
    {
      "parameters": {
        "resource": "workflow",
        "operation": "activate",
        "workflowId": "={{ $json.id }}"
      },
      "id": "publish-workflow",
      "name": "05. Publish (Activate)",
      "type": "n8n-nodes-base.n8n",
      "typeVersion": 1,
      "position": [1180, 300],
      "credentials": {
        "n8nApi": {
          "id": "REPLACE_N8N_API_CRED_ID",
          "name": "n8n API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst count = items.length;\nreturn [{ json: { success: true, message: `${count} workflows publies avec succes`, count } }];"
      },
      "id": "summary-response",
      "name": "06. Resume",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1420, 300]
    }
  ],
  "connections": {
    "01. Webhook Trigger": {
      "main": [[{ "node": "02. Lister Workflows (API)", "type": "main", "index": 0 }]]
    },
    "02. Lister Workflows (API)": {
      "main": [[{ "node": "03. Deactivate", "type": "main", "index": 0 }]]
    },
    "03. Deactivate": {
      "main": [[{ "node": "04. Wait 500ms", "type": "main", "index": 0 }]]
    },
    "04. Wait 500ms": {
      "main": [[{ "node": "05. Publish (Activate)", "type": "main", "index": 0 }]]
    },
    "05. Publish (Activate)": {
      "main": [[{ "node": "06. Resume", "type": "main", "index": 0 }]]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  }
}
