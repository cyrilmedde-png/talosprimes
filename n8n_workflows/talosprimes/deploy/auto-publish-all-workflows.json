{
  "name": "Deploy - Auto Publish All Workflows",
  "nodes": [
    {
      "parameters": {
        "path": "deploy-publish-all",
        "httpMethod": "POST",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "01. Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [200, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "http://localhost:5678/api/v1/workflows?limit=250",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "list-all-workflows",
      "name": "02. List ALL Workflows",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [440, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "REPLACE_HEADER_AUTH_ID",
          "name": "n8n API Key"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst workflows = response.data || response;\nconst selfName = 'Deploy - Auto Publish All Workflows';\n\n// Filtrer: exclure ce workflow lui-même\nconst filtered = workflows.filter(w => w.name !== selfName);\n\n// Séparer actifs et inactifs\nconst inactive = filtered.filter(w => !w.active);\nconst active = filtered.filter(w => w.active);\n\nreturn [{\n  json: {\n    totalWorkflows: filtered.length,\n    alreadyActive: active.length,\n    toActivate: inactive.length,\n    inactiveIds: inactive.map(w => ({ id: String(w.id), name: w.name }))\n  }\n}];"
      },
      "id": "analyze-status",
      "name": "02b. Analyser Statuts",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\nconst inactiveIds = data.inactiveIds || [];\n\nif (inactiveIds.length === 0) {\n  return [{ json: { id: 'none', name: 'Tous déjà actifs' } }];\n}\n\nreturn inactiveIds.map(w => ({ json: w }));"
      },
      "id": "split-inactive",
      "name": "03. Split Inactifs",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [920, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=http://localhost:5678/api/v1/workflows/{{ $json.id }}/activate",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "activate-workflow",
      "name": "04. POST Activate",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1160, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "REPLACE_HEADER_AUTH_ID",
          "name": "n8n API Key"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// NOTE IMPORTANTE:\n// L'API n8n POST /activate marque le workflow comme actif en DB\n// MAIS n'enregistre PAS les webhooks (bug connu n8n #21614).\n//\n// Pour que les webhooks fonctionnent, il faut REDEMARRER n8n après\n// cette étape. n8n enregistre les webhooks au démarrage.\n//\n// => Le script de déploiement (update-vps.sh) fait 'docker restart n8n' après.\n// => Le backend (publishAllWorkflows) fait aussi docker restart.\n\nconst items = $input.all();\nconst total = items.length;\nconst firstItem = items[0]?.json;\n\n// Si aucun à activer\nif (firstItem?.id === 'none') {\n  return [{ json: {\n    success: true,\n    message: 'Tous les workflows sont déjà actifs. Docker restart nécessaire pour enregistrer les webhooks.',\n    activated: 0,\n    total: 0,\n    needsRestart: true\n  }}];\n}\n\nlet activated = 0;\nlet errors = 0;\nfor (const item of items) {\n  if (item.json.active === true) {\n    activated++;\n  } else if (item.json.statusCode && item.json.statusCode < 300) {\n    activated++;\n  } else {\n    // Vérifier si la réponse indique un succès\n    const resp = item.json;\n    if (resp.id || resp.name) activated++;\n    else errors++;\n  }\n}\n\nreturn [{ json: {\n  success: true,\n  message: `${activated}/${total} workflows activés en DB. IMPORTANT: docker restart n8n nécessaire pour enregistrer les webhooks.`,\n  activated,\n  errors,\n  total,\n  needsRestart: true\n}}];"
      },
      "id": "summary-response",
      "name": "05. Résumé",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1400, 300]
    }
  ],
  "connections": {
    "01. Webhook Trigger": {
      "main": [[{ "node": "02. List ALL Workflows", "type": "main", "index": 0 }]]
    },
    "02. List ALL Workflows": {
      "main": [[{ "node": "02b. Analyser Statuts", "type": "main", "index": 0 }]]
    },
    "02b. Analyser Statuts": {
      "main": [[{ "node": "03. Split Inactifs", "type": "main", "index": 0 }]]
    },
    "03. Split Inactifs": {
      "main": [[{ "node": "04. POST Activate", "type": "main", "index": 0 }]]
    },
    "04. POST Activate": {
      "main": [[{ "node": "05. Résumé", "type": "main", "index": 0 }]]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  }
}
