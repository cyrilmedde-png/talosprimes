{
  "name": "Deploy - Auto Publish All Workflows",
  "nodes": [
    {
      "parameters": {
        "path": "deploy-publish-all",
        "httpMethod": "POST",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "01. Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [200, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "http://localhost:5678/api/v1/workflows?limit=250&active=true",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "list-workflows",
      "name": "02. List Active Workflows",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [440, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "REPLACE_HEADER_AUTH_ID",
          "name": "n8n API Key"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst workflows = response.data || response;\nconst selfName = 'Deploy - Auto Publish All Workflows';\nconst filtered = workflows.filter(w => w.name !== selfName);\n\n// Sub-workflows d'abord\nconst sorted = filtered.sort((a, b) => {\n  const aIsSub = (a.nodes || []).some(n => n.type === 'n8n-nodes-base.executeWorkflowTrigger');\n  const bIsSub = (b.nodes || []).some(n => n.type === 'n8n-nodes-base.executeWorkflowTrigger');\n  if (aIsSub && !bIsSub) return -1;\n  if (!aIsSub && bIsSub) return 1;\n  return 0;\n});\n\nreturn sorted.map(w => ({ json: { id: String(w.id), name: w.name } }));"
      },
      "id": "filter-sort",
      "name": "02b. Trier & Filtrer",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=http://localhost:5678/api/v1/workflows/{{ $json.id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "get-full-workflow",
      "name": "03. GET Full Workflow",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [920, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "REPLACE_HEADER_AUTH_ID",
          "name": "n8n API Key"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Preparer le payload PATCH: contenu complet du workflow + active:false\nconst wf = $input.first().json;\nconst payload = { ...wf };\ndelete payload.id;\ndelete payload.createdAt;\ndelete payload.updatedAt;\npayload.active = false;\nreturn [{ json: { workflowId: wf.id, payload } }];"
      },
      "id": "prep-deactivate",
      "name": "03b. Prep Deactivate",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1140, 300]
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "=http://localhost:5678/rest/workflows/{{ $json.workflowId }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "id": "deactivate-workflow",
      "name": "04. PATCH Deactivate",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1360, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "REPLACE_HEADER_AUTH_ID",
          "name": "n8n API Key"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Preparer le payload PATCH: meme contenu mais active:true\nconst wf = $input.first().json;\nconst payload = { ...wf };\ndelete payload.id;\ndelete payload.createdAt;\ndelete payload.updatedAt;\npayload.active = true;\nreturn [{ json: { workflowId: wf.id, payload } }];"
      },
      "id": "prep-activate",
      "name": "04b. Prep Activate",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1580, 300]
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "=http://localhost:5678/rest/workflows/{{ $json.workflowId }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "id": "activate-workflow",
      "name": "05. PATCH Activate (Publish)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1800, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "REPLACE_HEADER_AUTH_ID",
          "name": "n8n API Key"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst total = items.length;\nlet successes = 0;\nfor (const item of items) {\n  if (item.json.active === true) successes++;\n}\nconst failures = total - successes;\nreturn [{ json: { success: true, message: `${successes}/${total} workflows publies${failures > 0 ? ` (${failures} erreurs)` : ''}`, total, successes, failures } }];"
      },
      "id": "summary-response",
      "name": "06. Resume",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2040, 300]
    }
  ],
  "connections": {
    "01. Webhook Trigger": {
      "main": [[{ "node": "02. List Active Workflows", "type": "main", "index": 0 }]]
    },
    "02. List Active Workflows": {
      "main": [[{ "node": "02b. Trier & Filtrer", "type": "main", "index": 0 }]]
    },
    "02b. Trier & Filtrer": {
      "main": [[{ "node": "03. GET Full Workflow", "type": "main", "index": 0 }]]
    },
    "03. GET Full Workflow": {
      "main": [[{ "node": "03b. Prep Deactivate", "type": "main", "index": 0 }]]
    },
    "03b. Prep Deactivate": {
      "main": [[{ "node": "04. PATCH Deactivate", "type": "main", "index": 0 }]]
    },
    "04. PATCH Deactivate": {
      "main": [[{ "node": "04b. Prep Activate", "type": "main", "index": 0 }]]
    },
    "04b. Prep Activate": {
      "main": [[{ "node": "05. PATCH Activate (Publish)", "type": "main", "index": 0 }]]
    },
    "05. PATCH Activate (Publish)": {
      "main": [[{ "node": "06. Resume", "type": "main", "index": 0 }]]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  }
}
