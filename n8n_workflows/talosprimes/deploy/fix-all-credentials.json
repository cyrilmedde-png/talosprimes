{
  "name": "Deploy - Fix All Credentials",
  "nodes": [
    {
      "parameters": {},
      "id": "manual-trigger",
      "name": "01. Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [200, 300]
    },
    {
      "parameters": {
        "jsCode": "// Mapping HARDCODE de tous les credentials TalosPrimes\n// Source de verite : les vrais IDs dans n8n\nconst credentialMap = {\n  'Supabase Postgres': '6Kosza77d9Ld32mw',\n  'TalosPrimes API Auth': 'AuJmz6W8aeutvysV',\n  'Header Auth': 'FLSZWCszgEFfXDoK',\n  'Stripe': 'hTgbVXtv3dG8wSJ4',\n  'RESEND': 'ZoJkKnTqGisK2Idh',\n  'Twilio': '9dKAFunSg4lJcj77',\n  'n8n API Key': 'soHoxOtlUU9xdHDu',\n  'Telegram': 'JeSjY5sE3QcncJ4u',\n  'OpenAI': 'MmpYHYAt746xfTrB',\n  'Anthropic': 'SB3snedx3T9F5Tuz',\n  'SSH VPS': 'b7jMAjh1KJcIwqdo',\n  'SMTP': 'hepAQJGA9ubd1NF4',\n  'Google Calendar': '1098OxGMJM5eG3PU',\n  'Gmail': 'jzveDrdzJcs9iv7R'\n};\n\nreturn [{ json: { credentialMap, totalCredentials: Object.keys(credentialMap).length } }];"
      },
      "id": "build-cred-map",
      "name": "02. Credential Map (hardcoded)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [440, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "http://localhost:5678/api/v1/workflows?limit=250",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "list-workflows",
      "name": "03. List ALL Workflows",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [700, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "soHoxOtlUU9xdHDu",
          "name": "n8n API Key"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst workflows = response.data || response;\n\nreturn workflows.map(w => ({\n  json: { id: String(w.id), name: w.name }\n}));"
      },
      "id": "split-workflows",
      "name": "04. Split Workflows",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [960, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=http://localhost:5678/api/v1/workflows/{{ $json.id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "get-workflow-detail",
      "name": "05. GET Workflow Detail",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1200, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "soHoxOtlUU9xdHDu",
          "name": "n8n API Key"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "const credMap = $('02. Credential Map (hardcoded)').first().json.credentialMap;\nconst wf = $input.first().json;\nconst wfName = wf.name || 'unknown';\nconst wfId = String(wf.id);\n\nif (!wf.nodes) {\n  return [{ json: { id: wfId, name: wfName, fixed: 0, needsUpdate: false, reason: 'no nodes' } }];\n}\n\nlet fixed = 0;\nlet details = [];\n\nfor (const node of wf.nodes) {\n  if (!node.credentials) continue;\n  for (const [credType, credInfo] of Object.entries(node.credentials)) {\n    if (typeof credInfo !== 'object' || !credInfo) continue;\n    const credName = credInfo.name || '';\n    const currentId = String(credInfo.id || '');\n    \n    if (credName && credMap[credName]) {\n      const expectedId = String(credMap[credName]);\n      if (currentId !== expectedId) {\n        credInfo.id = expectedId;\n        fixed++;\n        details.push(`[${node.name}] ${credName}: ${currentId} -> ${expectedId}`);\n      }\n    }\n  }\n}\n\nconst payload = {\n  name: wf.name,\n  nodes: wf.nodes,\n  connections: wf.connections,\n  settings: wf.settings || {}\n};\n\nreturn [{ json: {\n  id: wfId,\n  name: wfName,\n  fixed,\n  details,\n  needsUpdate: fixed > 0,\n  payload\n} }];"
      },
      "id": "fix-credentials",
      "name": "06. Fix Credentials",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1440, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "cond-needs-update",
              "leftValue": "={{ $json.needsUpdate }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "filter-needs-update",
      "name": "07. Needs Update?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1680, 300]
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "=http://localhost:5678/api/v1/workflows/{{ $json.id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "id": "put-workflow",
      "name": "08. PUT Updated Workflow",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1920, 200],
      "credentials": {
        "httpHeaderAuth": {
          "id": "soHoxOtlUU9xdHDu",
          "name": "n8n API Key"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nreturn items.map(item => ({ json: { ...item.json, putDone: true } }));"
      },
      "id": "after-put",
      "name": "09a. After PUT",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2160, 200]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nreturn [{ json: { skipped: items.length } }];"
      },
      "id": "count-skipped",
      "name": "09b. Count Skipped",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1920, 400]
    },
    {
      "parameters": {
        "jsCode": "let updatedItems = [];\ntry { updatedItems = $('08. PUT Updated Workflow').all(); } catch(e) { /* node not executed = 0 updates */ }\n\nlet skippedItems = [];\ntry { skippedItems = $('09b. Count Skipped').all(); } catch(e) {}\n\nlet updated = updatedItems.length;\nlet skipped = skippedItems.length > 0 ? (skippedItems[0].json.skipped || 0) : 0;\n\nlet fixDetails = [];\ntry {\n  fixDetails = $('06. Fix Credentials').all()\n    .filter(item => item.json.needsUpdate)\n    .map(item => ({\n      name: item.json.name,\n      fixed: item.json.fixed,\n      details: item.json.details\n    }));\n} catch(e) {}\n\nreturn [{ json: {\n  success: true,\n  message: updated > 0 ? `${updated} workflows corrigés, ${skipped} déjà OK` : `Tous les ${skipped} workflows ont déjà les bons credentials !`,\n  updated,\n  skipped,\n  fixDetails\n} }];"
      },
      "id": "final-summary",
      "name": "10. Final Summary",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2400, 300]
    }
  ],
  "connections": {
    "01. Manual Trigger": {
      "main": [[{"node": "02. Credential Map (hardcoded)", "type": "main", "index": 0}]]
    },
    "02. Credential Map (hardcoded)": {
      "main": [[{"node": "03. List ALL Workflows", "type": "main", "index": 0}]]
    },
    "03. List ALL Workflows": {
      "main": [[{"node": "04. Split Workflows", "type": "main", "index": 0}]]
    },
    "04. Split Workflows": {
      "main": [[{"node": "05. GET Workflow Detail", "type": "main", "index": 0}]]
    },
    "05. GET Workflow Detail": {
      "main": [[{"node": "06. Fix Credentials", "type": "main", "index": 0}]]
    },
    "06. Fix Credentials": {
      "main": [[{"node": "07. Needs Update?", "type": "main", "index": 0}]]
    },
    "07. Needs Update?": {
      "main": [
        [{"node": "08. PUT Updated Workflow", "type": "main", "index": 0}],
        [{"node": "09b. Count Skipped", "type": "main", "index": 0}]
      ]
    },
    "08. PUT Updated Workflow": {
      "main": [[{"node": "09a. After PUT", "type": "main", "index": 0}]]
    },
    "09a. After PUT": {
      "main": [[{"node": "10. Final Summary", "type": "main", "index": 0}]]
    },
    "09b. Count Skipped": {
      "main": [[{"node": "10. Final Summary", "type": "main", "index": 0}]]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  }
}
