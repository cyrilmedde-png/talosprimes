{
  "name": "Deploy - Fix All Credentials",
  "nodes": [
    {
      "parameters": {},
      "id": "manual-trigger",
      "name": "01. Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [200, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "http://localhost:5678/api/v1/credentials?limit=100",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "list-credentials",
      "name": "02. GET All Credentials",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [440, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "soHoxOtlUU9xdHDu",
          "name": "n8n API Key"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Construire le mapping name -> id depuis les VRAIS credentials n8n\nconst response = $input.first().json;\nconst credentials = response.data || response;\n\nconst credMap = {};\nfor (const cred of credentials) {\n  if (cred.name && cred.id) {\n    credMap[cred.name] = String(cred.id);\n  }\n}\n\nconsole.log('Credential map from n8n:', JSON.stringify(credMap, null, 2));\n\nreturn [{ json: { credentialMap: credMap, totalCredentials: Object.keys(credMap).length } }];"
      },
      "id": "build-cred-map",
      "name": "03. Build Credential Map",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "http://localhost:5678/api/v1/workflows?limit=250",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "list-workflows",
      "name": "04. List ALL Workflows",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [920, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "soHoxOtlUU9xdHDu",
          "name": "n8n API Key"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst workflows = response.data || response;\n\nreturn workflows.map(w => ({\n  json: { id: String(w.id), name: w.name }\n}));"
      },
      "id": "split-workflows",
      "name": "05. Split Workflows",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1160, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=http://localhost:5678/api/v1/workflows/{{ $json.id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "get-workflow-detail",
      "name": "06. GET Workflow Detail",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1400, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "soHoxOtlUU9xdHDu",
          "name": "n8n API Key"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "const credMap = $('03. Build Credential Map').first().json.credentialMap;\nconst wf = $input.first().json;\nconst wfName = wf.name || 'unknown';\nconst wfId = String(wf.id);\n\nif (!wf.nodes) {\n  return [{ json: { id: wfId, name: wfName, fixed: 0, needsUpdate: false, reason: 'no nodes' } }];\n}\n\nlet fixed = 0;\nlet details = [];\n\nfor (const node of wf.nodes) {\n  if (!node.credentials) continue;\n  for (const [credType, credInfo] of Object.entries(node.credentials)) {\n    if (typeof credInfo !== 'object' || !credInfo) continue;\n    const credName = credInfo.name || '';\n    const currentId = String(credInfo.id || '');\n    \n    if (credName && credMap[credName]) {\n      const expectedId = String(credMap[credName]);\n      if (currentId !== expectedId) {\n        credInfo.id = expectedId;\n        fixed++;\n        details.push(`[${node.name}] ${credName}: ${currentId} -> ${expectedId}`);\n      }\n    }\n  }\n}\n\n// Payload pour PUT\nconst payload = {\n  name: wf.name,\n  nodes: wf.nodes,\n  connections: wf.connections,\n  settings: wf.settings || {}\n};\n\nreturn [{ json: {\n  id: wfId,\n  name: wfName,\n  fixed,\n  details,\n  needsUpdate: fixed > 0,\n  payload\n} }];"
      },
      "id": "fix-credentials",
      "name": "07. Fix Credentials",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1640, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "cond-needs-update",
              "leftValue": "={{ $json.needsUpdate }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "filter-needs-update",
      "name": "08. Needs Update?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1880, 300]
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "=http://localhost:5678/api/v1/workflows/{{ $json.id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "id": "put-workflow",
      "name": "09. PUT Updated Workflow",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2120, 200],
      "credentials": {
        "httpHeaderAuth": {
          "id": "soHoxOtlUU9xdHDu",
          "name": "n8n API Key"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Recuperer les resultats des 2 branches\nconst updatedItems = $('09. PUT Updated Workflow').all();\nconst skippedItems = $('10b. Count Skipped').all();\n\nlet updated = updatedItems.length;\nlet skipped = skippedItems.length > 0 ? (skippedItems[0].json.skipped || 0) : 0;\n\n// Verifier les details des updates\nconst fixDetails = $('07. Fix Credentials').all()\n  .filter(item => item.json.needsUpdate)\n  .map(item => ({\n    name: item.json.name,\n    fixed: item.json.fixed,\n    details: item.json.details\n  }));\n\nreturn [{ json: {\n  success: true,\n  message: `${updated} workflows corrigés, ${skipped} déjà OK`,\n  updated,\n  skipped,\n  fixDetails\n} }];"
      },
      "id": "final-summary",
      "name": "11. Final Summary",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2600, 300]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nreturn [{ json: { skipped: items.length } }];"
      },
      "id": "count-skipped",
      "name": "10b. Count Skipped",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2120, 400]
    },
    {
      "parameters": {
        "jsCode": "// Passer les resultats du PUT\nconst items = $input.all();\nreturn items.map(item => ({ json: { ...item.json, putDone: true } }));"
      },
      "id": "after-put",
      "name": "10a. After PUT",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2360, 200]
    }
  ],
  "connections": {
    "01. Manual Trigger": {
      "main": [[{"node": "02. GET All Credentials", "type": "main", "index": 0}]]
    },
    "02. GET All Credentials": {
      "main": [[{"node": "03. Build Credential Map", "type": "main", "index": 0}]]
    },
    "03. Build Credential Map": {
      "main": [[{"node": "04. List ALL Workflows", "type": "main", "index": 0}]]
    },
    "04. List ALL Workflows": {
      "main": [[{"node": "05. Split Workflows", "type": "main", "index": 0}]]
    },
    "05. Split Workflows": {
      "main": [[{"node": "06. GET Workflow Detail", "type": "main", "index": 0}]]
    },
    "06. GET Workflow Detail": {
      "main": [[{"node": "07. Fix Credentials", "type": "main", "index": 0}]]
    },
    "07. Fix Credentials": {
      "main": [[{"node": "08. Needs Update?", "type": "main", "index": 0}]]
    },
    "08. Needs Update?": {
      "main": [
        [{"node": "09. PUT Updated Workflow", "type": "main", "index": 0}],
        [{"node": "10b. Count Skipped", "type": "main", "index": 0}]
      ]
    },
    "09. PUT Updated Workflow": {
      "main": [[{"node": "10a. After PUT", "type": "main", "index": 0}]]
    },
    "10a. After PUT": {
      "main": [[{"node": "11. Final Summary", "type": "main", "index": 0}]]
    },
    "10b. Count Skipped": {
      "main": [[{"node": "11. Final Summary", "type": "main", "index": 0}]]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  }
}
