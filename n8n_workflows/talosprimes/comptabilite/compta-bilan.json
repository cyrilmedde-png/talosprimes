{
  "name": "compta-bilan",
  "nodes": [
    {
      "parameters": {
        "path": "compta-bilan",
        "responseMode": "responseNode",
        "httpMethod": "POST"
      },
      "id": "01. Webhook",
      "name": "01. Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [100, 200]
    },
    {
      "parameters": {
        "jsCode": "var body = $input.first().json.body || $input.first().json;\nif (!body.tenantId) throw new Error('tenantId is required');\nvar UUID_RE = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\nif (!UUID_RE.test(body.tenantId)) throw new Error('tenantId invalide');\nvar today = new Date().toISOString().split('T')[0];\nreturn [{ json: { tenantId: body.tenantId, dateFrom: body.dateFrom || null, dateTo: body.dateTo || today } }];"
      },
      "id": "02. Parser",
      "name": "02. Parser",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [300, 200]
    },
    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "leftValue": "" },
          "conditions": [
            {
              "id": "bilan-valid-1",
              "leftValue": "={{ $json.tenantId }}",
              "operator": { "type": "string", "operation": "notEmpty" }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "03. Valide ?",
      "name": "03. Valide ?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [500, 200]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={ \"success\": false, \"error\": \"tenantId manquant\" }"
      },
      "id": "04. Respond Error",
      "name": "04. Respond Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [700, 100]
    },
    {
      "parameters": {
        "jsCode": "function esc(v) { return \"'\" + String(v).replace(/'/g, \"''\") + \"'\"; }\nvar p = $('02. Parser').first().json;\nvar dateFilter = p.dateTo ? ' AND e.date_ecriture <= ' + esc(p.dateTo) + '::date' : '';\nvar dateFilterFrom = p.dateFrom ? ' AND e.date_ecriture >= ' + esc(p.dateFrom) + '::date' : '';\n\nvar bilanQuery = 'SELECT le.numero_compte, pc.libelle, pc.classe, COALESCE(SUM(le.debit), 0) - COALESCE(SUM(le.credit), 0) as solde FROM lignes_ecritures le JOIN ecritures_comptables e ON le.ecriture_id = e.id LEFT JOIN plan_comptable pc ON le.numero_compte = pc.numero_compte AND pc.tenant_id = e.tenant_id WHERE e.tenant_id = ' + esc(p.tenantId) + '::uuid AND e.statut = ' + esc('validee') + ' AND pc.classe IN (1,2,3,4,5)' + dateFilter + dateFilterFrom + ' GROUP BY le.numero_compte, pc.libelle, pc.classe HAVING COALESCE(SUM(le.debit), 0) - COALESCE(SUM(le.credit), 0) != 0 ORDER BY le.numero_compte;';\n\nvar resultatQuery = 'SELECT COALESCE(SUM(CASE WHEN pc.classe = 7 THEN le.credit - le.debit ELSE 0 END), 0) - COALESCE(SUM(CASE WHEN pc.classe = 6 THEN le.debit - le.credit ELSE 0 END), 0) as resultat_net FROM lignes_ecritures le JOIN ecritures_comptables e ON le.ecriture_id = e.id LEFT JOIN plan_comptable pc ON le.numero_compte = pc.numero_compte AND pc.tenant_id = e.tenant_id WHERE e.tenant_id = ' + esc(p.tenantId) + '::uuid AND e.statut = ' + esc('validee') + ' AND pc.classe IN (6,7)' + dateFilter + dateFilterFrom + ';';\n\nreturn [{ json: { bilanQuery: bilanQuery, resultatQuery: resultatQuery } }];"
      },
      "id": "05. Build Queries",
      "name": "05. Build Queries",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [700, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.bilanQuery }}"
      },
      "id": "06. Query Bilan Comptes",
      "name": "06. Query Bilan Comptes",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "credentials": {
        "postgres": { "name": "Supabase Postgres", "id": "OGqj65ZoFRileCck" }
      },
      "position": [900, 300],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $('05. Build Queries').first().json.resultatQuery }}"
      },
      "id": "07. Query Resultat",
      "name": "07. Query Resultat",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "credentials": {
        "postgres": { "name": "Supabase Postgres", "id": "OGqj65ZoFRileCck" }
      },
      "position": [1100, 300],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "var items = $('06. Query Bilan Comptes').all().map(function(i) { return i.json; }).filter(function(c) { return c.numero_compte; });\nvar resultatNet = parseFloat($('07. Query Resultat').first().json.resultat_net) || 0;\nvar p = $('02. Parser').first().json;\n\nvar actifImmobilise = [];\nvar actifCirculant = [];\nvar capitauxPropres = [];\nvar dettes = [];\nvar totalActif = 0;\nvar totalPassif = 0;\n\nfor (var i = 0; i < items.length; i++) {\n  var c = items[i];\n  var solde = parseFloat(c.solde) || 0;\n  var entry = { numero: c.numero_compte, libelle: c.libelle || c.numero_compte, montant: Math.round(Math.abs(solde) * 100) / 100 };\n  var classe = parseInt(c.classe);\n\n  if (classe === 2) {\n    actifImmobilise.push(entry);\n    totalActif += Math.abs(solde);\n  } else if (classe === 3 || classe === 5) {\n    actifCirculant.push(entry);\n    totalActif += Math.abs(solde);\n  } else if (classe === 1) {\n    capitauxPropres.push(entry);\n    totalPassif += Math.abs(solde);\n  } else if (classe === 4) {\n    if (solde > 0) {\n      actifCirculant.push(entry);\n      totalActif += solde;\n    } else {\n      dettes.push(entry);\n      totalPassif += Math.abs(solde);\n    }\n  }\n}\n\nif (resultatNet !== 0) {\n  capitauxPropres.push({ numero: resultatNet >= 0 ? '120000' : '129000', libelle: resultatNet >= 0 ? 'Résultat net (bénéfice)' : 'Résultat net (perte)', montant: Math.round(Math.abs(resultatNet) * 100) / 100 });\n  totalPassif += Math.abs(resultatNet);\n}\n\ntotalActif = Math.round(totalActif * 100) / 100;\ntotalPassif = Math.round(totalPassif * 100) / 100;\n\nreturn [{ json: {\n  success: true,\n  actif: { actifImmobilise: actifImmobilise, actifCirculant: actifCirculant, totalActif: totalActif },\n  passif: { capitauxPropres: capitauxPropres, dettes: dettes, totalPassif: totalPassif },\n  equilibre: Math.abs(totalActif - totalPassif) < 0.01,\n  periode: { dateFrom: p.dateFrom || '', dateTo: p.dateTo }\n} }];"
      },
      "id": "08. Format Bilan",
      "name": "08. Format Bilan",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1300, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}"
      },
      "id": "09. Respond",
      "name": "09. Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1500, 300]
    }
  ],
  "connections": {
    "01. Webhook": { "main": [[{ "node": "02. Parser", "type": "main", "index": 0 }]] },
    "02. Parser": { "main": [[{ "node": "03. Valide ?", "type": "main", "index": 0 }]] },
    "03. Valide ?": { "main": [[{ "node": "05. Build Queries", "type": "main", "index": 0 }], [{ "node": "04. Respond Error", "type": "main", "index": 0 }]] },
    "05. Build Queries": { "main": [[{ "node": "06. Query Bilan Comptes", "type": "main", "index": 0 }]] },
    "06. Query Bilan Comptes": { "main": [[{ "node": "07. Query Resultat", "type": "main", "index": 0 }]] },
    "07. Query Resultat": { "main": [[{ "node": "08. Format Bilan", "type": "main", "index": 0 }]] },
    "08. Format Bilan": { "main": [[{ "node": "09. Respond", "type": "main", "index": 0 }]] }
  },
  "settings": { "executionOrder": "v1" },
  "active": true
}
