{
  "name": "compta-ecritures-list",
  "nodes": [
    {
      "parameters": {
        "path": "compta-ecritures-list",
        "responseMode": "responseNode",
        "httpMethod": "POST"
      },
      "id": "01. Webhook",
      "name": "01. Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        100,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "var body = $input.first().json.body || $input.first().json;\nif (!body.tenantId) throw new Error('tenantId is required');\nvar UUID_RE = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\nif (!UUID_RE.test(body.tenantId)) throw new Error('tenantId invalide');\n\nvar page = parseInt(body.page) || 1;\nvar limit = parseInt(body.limit) || 20;\nif (limit > 100) limit = 100;\nif (page < 1) page = 1;\nvar offset = (page - 1) * limit;\n\nvar SAFE_TEXT = /^[\\w\\s\\-àâäéèêëïîôùûüÿçÀÂÄÉÈÊËÏÎÔÙÛÜŸÇ.,;:!?()\\/#&€@+'\\\"°%*]+$/;\nvar journalCode = body.journalCode || null;\nif (journalCode && !SAFE_TEXT.test(journalCode)) journalCode = null;\nvar statut = body.statut || null;\nif (statut && !SAFE_TEXT.test(statut)) statut = null;\nvar search = body.search || null;\nif (search && !SAFE_TEXT.test(search)) search = null;\nvar DATE_RE = /^\\d{4}-\\d{2}-\\d{2}$/;\nvar dateFrom = body.dateFrom || null;\nif (dateFrom && !DATE_RE.test(dateFrom)) dateFrom = null;\nvar dateTo = body.dateTo || null;\nif (dateTo && !DATE_RE.test(dateTo)) dateTo = null;\n\nreturn [{ json: {\n  tenantId: body.tenantId, page: page, limit: limit, offset: offset,\n  journalCode: journalCode,\n  dateFrom: dateFrom,\n  dateTo: dateTo,\n  statut: statut,\n  search: search\n} }];"
      },
      "id": "02. Parser",
      "name": "02. Parser",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        300,
        200
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": ""
          },
          "conditions": [
            {
              "id": "e68a71a1-a75b-4e6f-8e0c-09e17a18b863",
              "leftValue": "={{ $json.tenantId }}",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "03. Valide ?",
      "name": "03. Valide ?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        500,
        200
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={ \"success\": false, \"error\": \"tenantId manquant\" }"
      },
      "id": "04. Respond Error",
      "name": "04. Respond Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        700,
        100
      ]
    },
    {
      "parameters": {
        "jsCode": "function esc(v) { return v == null ? 'NULL' : \"'\" + String(v).replace(/'/g, \"''\") + \"'\"; }\n\nvar p = $('02. Parser').first().json;\nvar where = \"e.tenant_id = \" + esc(p.tenantId) + \"::uuid\";\nif (p.journalCode) where += \" AND e.journal_code = \" + esc(p.journalCode);\nif (p.statut) where += \" AND e.statut = \" + esc(p.statut);\nif (p.dateFrom) where += \" AND e.date_ecriture >= \" + esc(p.dateFrom) + \"::date\";\nif (p.dateTo) where += \" AND e.date_ecriture <= \" + esc(p.dateTo) + \"::date\";\nif (p.search) {\n  var s = esc('%' + p.search + '%');\n  where += \" AND (e.numero_piece ILIKE \" + s + \" OR e.libelle ILIKE \" + s + \" OR e.reference_doc ILIKE \" + s + \")\";\n}\n\nvar countQuery = \"SELECT COUNT(*) as total FROM ecritures_comptables e WHERE \" + where + \";\";\n\nvar listQuery = \"SELECT e.id, e.journal_code, e.numero_piece, e.date_ecriture, e.libelle, e.reference_doc, e.statut, e.source_auto, e.source_id, e.created_at, j.libelle as journal_libelle, COALESCE(SUM(l.debit), 0) as total_debit, COALESCE(SUM(l.credit), 0) as total_credit FROM ecritures_comptables e LEFT JOIN journaux_comptables j ON e.journal_code = j.code AND e.tenant_id = j.tenant_id LEFT JOIN lignes_ecritures l ON l.ecriture_id = e.id WHERE \" + where + \" GROUP BY e.id, e.journal_code, e.numero_piece, e.date_ecriture, e.libelle, e.reference_doc, e.statut, e.source_auto, e.source_id, e.created_at, j.libelle ORDER BY e.date_ecriture DESC, e.numero_piece DESC LIMIT \" + p.limit + \" OFFSET \" + p.offset + \";\";\n\nreturn [{ json: { countQuery: countQuery, listQuery: listQuery, page: p.page, limit: p.limit } }];"
      },
      "id": "05. Build Queries",
      "name": "05. Build Queries",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        700,
        300
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $('05. Build Queries').first().json.countQuery }}"
      },
      "id": "06. Count",
      "name": "06. Count",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "credentials": {
        "postgres": {
          "name": "Supabase Postgres",
          "id": "OGqj65ZoFRileCck"
        }
      },
      "position": [
        900,
        300
      ],
      "alwaysOutputData": true,
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $('05. Build Queries').first().json.listQuery }}"
      },
      "id": "07. List",
      "name": "07. List",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "credentials": {
        "postgres": {
          "name": "Supabase Postgres",
          "id": "OGqj65ZoFRileCck"
        }
      },
      "position": [
        1100,
        300
      ],
      "alwaysOutputData": true,
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "var items = $('07. List').all().map(function(item) { return item.json; }).filter(function(e) { return e.id; });\nvar total = parseInt($('06. Count').first().json.total) || 0;\nvar p = $('05. Build Queries').first().json;\nvar totalPages = Math.ceil(total / p.limit) || 1;\n\nvar ecritures = items.map(function(e) { return ({\n  id: e.id,\n  journalCode: e.journal_code,\n  journalLibelle: e.journal_libelle || null,\n  numeroPiece: e.numero_piece,\n  dateEcriture: e.date_ecriture,\n  libelle: e.libelle,\n  referenceDoc: e.reference_doc || null,\n  statut: e.statut,\n  sourceAuto: e.source_auto || null,\n  sourceId: e.source_id || null,\n  totalDebit: parseFloat(e.total_debit) || 0,\n  totalCredit: parseFloat(e.total_credit) || 0,\n  montantTotal: Math.max(parseFloat(e.total_debit) || 0, parseFloat(e.total_credit) || 0),\n  createdAt: e.created_at\n}); });\n\nreturn [{ json: { success: true, ecritures: ecritures, count: ecritures.length, total: total, page: p.page, limit: p.limit, totalPages: totalPages } }];"
      },
      "id": "08. Format Response",
      "name": "08. Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1300,
        300
      ]
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems"
      },
      "id": "09. Respond",
      "name": "09. Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1500,
        300
      ]
    }
  ],
  "connections": {
    "01. Webhook": {
      "main": [
        [
          {
            "node": "02. Parser",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "02. Parser": {
      "main": [
        [
          {
            "node": "03. Valide ?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "03. Valide ?": {
      "main": [
        [
          {
            "node": "05. Build Queries",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "04. Respond Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "05. Build Queries": {
      "main": [
        [
          {
            "node": "06. Count",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "06. Count": {
      "main": [
        [
          {
            "node": "07. List",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "07. List": {
      "main": [
        [
          {
            "node": "08. Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "08. Format Response": {
      "main": [
        [
          {
            "node": "09. Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "active": true,
  "id": "compta-ecritures-list"
}