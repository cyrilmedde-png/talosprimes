{
  "name": "compta-ecritures-list",
  "nodes": [
    {
      "parameters": {
        "path": "compta-ecritures-list",
        "responseMode": "responseNode",
        "httpMethod": "POST"
      },
      "id": "01. Webhook",
      "name": "01. Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        100,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "var body = $input.first().json.body || $input.first().json;\nif (!body.tenantId) throw new Error('tenantId is required');\nvar page = parseInt(body.page) || 1;\nvar limit = parseInt(body.limit) || 20;\nvar offset = (page - 1) * limit;\nreturn [{ json: {\n  tenantId: body.tenantId, page, limit, offset,\n  journalCode: body.journalCode || null,\n  dateFrom: body.dateFrom || null,\n  dateTo: body.dateTo || null,\n  statut: body.statut || null,\n  typePiece: body.typePiece || null,\n  search: body.search || null\n} }];"
      },
      "id": "02. Parser",
      "name": "02. Parser",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        300,
        200
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.tenantId }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "03. Valide ?",
      "name": "03. Valide ?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        500,
        200
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={ \"success\": false, \"error\": \"tenantId manquant\" }"
      },
      "id": "04. Respond Error",
      "name": "04. Respond Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        700,
        100
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ \"SELECT COUNT(*) as total FROM ecritures_comptables WHERE tenant_id = '\" + $json.tenantId + \"' AND \" + ($json.journalCode ? \"journal_code = '\" + $json.journalCode + \"'\" : \"1=1\") + \" AND \" + ($json.statut ? \"statut = '\" + $json.statut + \"'\" : \"1=1\") + \" AND \" + ($json.typePiece ? \"type_piece = '\" + $json.typePiece + \"'\" : \"1=1\") + \" AND \" + ($json.dateFrom ? \"date_ecriture >= '\" + $json.dateFrom + \"'\" : \"1=1\") + \" AND \" + ($json.dateTo ? \"date_ecriture <= '\" + $json.dateTo + \"'\" : \"1=1\") + \" AND ('\" + $json.search + \"' IS NULL OR (numero_piece ILIKE '%' || '\" + $json.search + \"' || '%' OR libelle ILIKE '%' || '\" + $json.search + \"' || '%' OR reference ILIKE '%' || '\" + $json.search + \"' || '%'))\" }}"
      },
      "id": "05. Count",
      "name": "05. Count",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "credentials": {
        "postgres": {
          "name": "Supabase Postgres",
          "id": "OGqj65ZoFRileCck"
        }
      },
      "position": [
        700,
        300
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ \"SELECT e.id, e.journal_code, e.numero_piece, e.date_ecriture, e.date_echeance, e.libelle, e.reference, e.type_piece, e.entite_type, e.entite_id, e.montant_total, e.statut, e.source, e.created_at, j.libelle as journal_libelle FROM ecritures_comptables e LEFT JOIN journaux_comptables j ON e.journal_code = j.code AND e.tenant_id = j.tenant_id WHERE e.tenant_id = '\" + $('02. Parser').first().json.tenantId + \"' AND \" + ($('02. Parser').first().json.journalCode ? \"e.journal_code = '\" + $('02. Parser').first().json.journalCode + \"'\" : \"1=1\") + \" AND \" + ($('02. Parser').first().json.statut ? \"e.statut = '\" + $('02. Parser').first().json.statut + \"'\" : \"1=1\") + \" AND \" + ($('02. Parser').first().json.typePiece ? \"e.type_piece = '\" + $('02. Parser').first().json.typePiece + \"'\" : \"1=1\") + \" AND \" + ($('02. Parser').first().json.dateFrom ? \"e.date_ecriture >= '\" + $('02. Parser').first().json.dateFrom + \"'\" : \"1=1\") + \" AND \" + ($('02. Parser').first().json.dateTo ? \"e.date_ecriture <= '\" + $('02. Parser').first().json.dateTo + \"'\" : \"1=1\") + \" AND ('\" + $('02. Parser').first().json.search + \"' IS NULL OR (e.numero_piece ILIKE '%' || '\" + $('02. Parser').first().json.search + \"' || '%' OR e.libelle ILIKE '%' || '\" + $('02. Parser').first().json.search + \"' || '%')) ORDER BY e.date_ecriture DESC, e.numero_piece DESC LIMIT \" + $('02. Parser').first().json.limit + \" OFFSET \" + $('02. Parser').first().json.offset }}"
      },
      "id": "06. List",
      "name": "06. List",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "credentials": {
        "postgres": {
          "name": "Supabase Postgres",
          "id": "OGqj65ZoFRileCck"
        }
      },
      "position": [
        900,
        300
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "var items = $('06. List').all().map(function(item) { return item.json; }).filter(function(e) { return e.id; });\nvar total = parseInt($('05. Count').first().json.total) || 0;\nvar p = $('02. Parser').first().json;\nvar totalPages = Math.ceil(total / p.limit) || 1;\n\nvar ecritures = items.map(function(e) { return ({\n  id: e.id,\n  journalCode: e.journal_code,\n  journalLibelle: e.journal_libelle,\n  numeroPiece: e.numero_piece,\n  dateEcriture: e.date_ecriture,\n  dateEcheance: e.date_echeance,\n  libelle: e.libelle,\n  reference: e.reference,\n  typePiece: e.type_piece,\n  entiteType: e.entite_type,\n  entiteId: e.entite_id,\n  montantTotal: parseFloat(e.montant_total) || 0,\n  statut: e.statut,\n  source: e.source,\n  createdAt: e.created_at\n}); });\n\nreturn [{ json: { success: true, ecritures, count: ecritures.length, total, page: p.page, limit: p.limit, totalPages } }];"
      },
      "id": "07. Format Response",
      "name": "07. Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1100,
        300
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}"
      },
      "id": "08. Respond",
      "name": "08. Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1300,
        300
      ]
    }
  ],
  "connections": {
    "01. Webhook": {
      "main": [
        [
          {
            "node": "02. Parser",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "02. Parser": {
      "main": [
        [
          {
            "node": "03. Valide ?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "03. Valide ?": {
      "main": [
        [
          {
            "node": "05. Count",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "04. Respond Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "05. Count": {
      "main": [
        [
          {
            "node": "06. List",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "06. List": {
      "main": [
        [
          {
            "node": "07. Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "07. Format Response": {
      "main": [
        [
          {
            "node": "08. Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "active": true
}