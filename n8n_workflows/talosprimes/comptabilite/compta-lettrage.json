{
  "name": "Compta Lettrage",
  "nodes": [
    {
      "parameters": {
        "path": "compta-lettrage",
        "responseMode": "responseNode",
        "httpMethod": "POST"
      },
      "id": "01. Webhook",
      "name": "01. Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        100,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "var body = $input.first().json.body || $input.first().json;\nvar UUID_RE = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\nif (!body.tenantId || !UUID_RE.test(body.tenantId)) {\n  return [{ json: { valid: false, error: 'tenantId manquant ou invalide' } }];\n}\nvar ligneIds = body.ligneIds || [];\nif (!Array.isArray(ligneIds) || ligneIds.length < 2) {\n  return [{ json: { valid: false, error: 'Au moins 2 ligneIds requis' } }];\n}\nvar allValid = ligneIds.every(function(id) { return UUID_RE.test(id); });\nif (!allValid) {\n  return [{ json: { valid: false, error: 'ligneIds invalides' } }];\n}\nreturn [{ json: { tenantId: body.tenantId, numeroCompte: body.numeroCompte || null, ligneIds: ligneIds, valid: true } }];"
      },
      "id": "02. Parser",
      "name": "02. Parser",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        300,
        200
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": ""
          },
          "conditions": [
            {
              "id": "lett-valid-1",
              "leftValue": "={{ $json.tenantId }}",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "03. IF Valide",
      "name": "03. IF Valide",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        500,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "var err = $json.error || 'Parametres invalides';\nreturn [{ json: { success: false, error: err } }];"
      },
      "id": "03b. Format Error",
      "name": "03b. Format Error",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        600,
        100
      ]
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems"
      },
      "id": "04. Respond Error",
      "name": "04. Respond Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        800,
        100
      ]
    },
    {
      "parameters": {
        "jsCode": "function esc(v) { return \"'\" + String(v).replace(/'/g, \"''\") + \"'\"; }\nvar p = $('02. Parser').first().json;\nvar inClause = p.ligneIds.map(function(id) { return esc(id) + \"::uuid\"; }).join(\",\");\nvar query = \"SELECT id, numero_compte, libelle_ligne, debit, credit, lettrage FROM lignes_ecritures WHERE tenant_id = \" + esc(p.tenantId) + \"::uuid AND id IN (\" + inClause + \") ORDER BY numero_compte ASC\";\nreturn [{ json: { query: query, ligneIds: p.ligneIds, tenantId: p.tenantId } }];"
      },
      "id": "05. Build Queries",
      "name": "05. Build Queries",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        700,
        300
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.query }}"
      },
      "id": "06. Get Lignes",
      "name": "06. Get Lignes",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "credentials": {
        "postgres": {
          "name": "Supabase Postgres",
          "id": "OGqj65ZoFRileCck"
        }
      },
      "position": [
        900,
        300
      ],
      "alwaysOutputData": true,
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "var items = $('06. Get Lignes').all().map(function(i) { return i.json; }).filter(function(r) { return r.id && !r.error; });\nif (items.length < 2) {\n  return [{ json: { letterageCode: '', error: 'Lignes comptables non trouvees (min 2 requises, trouve: ' + items.length + ')' } }];\n}\nvar totalDebits = 0, totalCredits = 0;\nitems.forEach(function(l) { totalDebits += (parseFloat(l.debit) || 0); totalCredits += (parseFloat(l.credit) || 0); });\nvar difference = Math.abs(totalDebits - totalCredits);\nif (difference > 0.05) {\n  return [{ json: { letterageCode: '', error: 'Ecart debit/credit trop important: ' + difference.toFixed(2) } }];\n}\nvar letterageCode = 'LTR_' + Date.now() + '_' + Math.random().toString(36).substring(2, 8).toUpperCase();\nreturn [{ json: { letterageCode: letterageCode, lignes: items, totalDebits: totalDebits, totalCredits: totalCredits, difference: difference } }];"
      },
      "id": "07. Verify Balance",
      "name": "07. Verify Balance",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1100,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": ""
          },
          "conditions": [
            {
              "id": "lett-balance-1",
              "leftValue": "={{ $json.letterageCode }}",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "08. IF Balance OK",
      "name": "08. IF Balance OK",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1300,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "var err = $json.error || 'Verification du lettrage echouee';\nreturn [{ json: { success: false, error: err } }];"
      },
      "id": "08b. Format Balance Error",
      "name": "08b. Format Balance Error",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1400,
        200
      ]
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems"
      },
      "id": "09. Respond Balance Error",
      "name": "09. Respond Balance Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1600,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "function esc(v) { return \"'\" + String(v).replace(/'/g, \"''\") + \"'\"; }\nvar v = $('07. Verify Balance').first().json;\nvar tenantId = $('02. Parser').first().json.tenantId;\nvar now = new Date().toISOString();\nvar inClause = v.lignes.map(function(l) { return esc(l.id) + \"::uuid\"; }).join(\",\");\nvar updateQuery = \"UPDATE lignes_ecritures SET lettrage = \" + esc(v.letterageCode) + \", date_lettrage = \" + esc(now) + \"::timestamp WHERE id IN (\" + inClause + \") AND tenant_id = \" + esc(tenantId) + \"::uuid\";\nreturn [{ json: { updateQuery: updateQuery, letterageCode: v.letterageCode, ligneCount: v.lignes.length, totalDebits: v.totalDebits, totalCredits: v.totalCredits } }];"
      },
      "id": "10. Build Update",
      "name": "10. Build Update",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1500,
        400
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.updateQuery }}"
      },
      "id": "11. Apply Lettrage",
      "name": "11. Apply Lettrage",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "credentials": {
        "postgres": {
          "name": "Supabase Postgres",
          "id": "OGqj65ZoFRileCck"
        }
      },
      "position": [
        1700,
        400
      ],
      "alwaysOutputData": true,
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "var bu = $('10. Build Update').first().json;\nreturn [{ json: { success: true, letterageCode: bu.letterageCode, message: 'Lettrage applique avec succes', ligneCount: bu.ligneCount, totalDebits: bu.totalDebits, totalCredits: bu.totalCredits } }];"
      },
      "id": "12. Format Response",
      "name": "12. Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1900,
        400
      ]
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems"
      },
      "id": "13. Respond",
      "name": "13. Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        2100,
        400
      ]
    }
  ],
  "connections": {
    "01. Webhook": {
      "main": [
        [
          {
            "node": "02. Parser",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "02. Parser": {
      "main": [
        [
          {
            "node": "03. IF Valide",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "03. IF Valide": {
      "main": [
        [
          {
            "node": "05. Build Queries",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "03b. Format Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "03b. Format Error": {
      "main": [
        [
          {
            "node": "04. Respond Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "05. Build Queries": {
      "main": [
        [
          {
            "node": "06. Get Lignes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "06. Get Lignes": {
      "main": [
        [
          {
            "node": "07. Verify Balance",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "07. Verify Balance": {
      "main": [
        [
          {
            "node": "08. IF Balance OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "08. IF Balance OK": {
      "main": [
        [
          {
            "node": "10. Build Update",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "08b. Format Balance Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "08b. Format Balance Error": {
      "main": [
        [
          {
            "node": "09. Respond Balance Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "10. Build Update": {
      "main": [
        [
          {
            "node": "11. Apply Lettrage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "11. Apply Lettrage": {
      "main": [
        [
          {
            "node": "12. Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "12. Format Response": {
      "main": [
        [
          {
            "node": "13. Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "active": true,
  "id": "compta-lettrage"
}