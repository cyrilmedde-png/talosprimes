{
  "name": "Compta Lettrage",
  "nodes": [
    {
      "parameters": {
        "path": "compta-lettrage",
        "httpMethod": "POST",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        250,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "function esc(v) {\n  return \"'\" + String(v).replace(/'/g, \"''\") + \"'\";\n}\n\nvar tenantId = $input.body.tenantId;\nvar numeroCompte = $input.body.numeroCompte;\nvar ligneIds = $input.body.ligneIds || [];\n\n// Validate tenantId format\nvar uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\n\nif (!tenantId || !uuidRegex.test(tenantId)) {\n  return {\n    error: \"Invalid or missing tenantId\",\n    valid: false\n  };\n}\n\n// Validate all ligneIds are UUIDs\nvar allValid = ligneIds.every(function(id) {\n  return uuidRegex.test(id);\n});\n\nif (!allValid) {\n  return {\n    error: \"Invalid ligneIds format\",\n    valid: false\n  };\n}\n\nreturn {\n  tenantId: tenantId,\n  numeroCompte: numeroCompte || null,\n  ligneIds: ligneIds,\n  valid: true\n};"
      },
      "id": "parser",
      "name": "Parser",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        450,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "matchType": "all",
          "conditions": [
            {
              "key": "{{$node.parser.output.json.valid}}",
              "condition": "equals",
              "value": true
            }
          ]
        }
      },
      "id": "if_valide",
      "name": "IF Valide",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        650,
        300
      ]
    },
    {
      "parameters": {
        "respondWithCode": 400,
        "responseBody": "{{{\n  \"error\": $node.parser.output.json.error,\n  \"success\": false\n}}}"
      },
      "id": "respond_error",
      "name": "Respond Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        850,
        150
      ]
    },
    {
      "parameters": {
        "jsCode": "function esc(v) {\n  return \"'\" + String(v).replace(/'/g, \"''\") + \"'\";\n}\n\nvar tenantId = $node.parser.output.json.tenantId;\nvar ligneIds = $node.parser.output.json.ligneIds;\n\nif (!ligneIds || ligneIds.length === 0) {\n  return { error: \"No ligneIds provided\" };\n}\n\n// Build IN clause with proper UUID casting\nvar inClause = ligneIds.map(function(id) {\n  return esc(id) + \"::uuid\";\n}).join(\",\");\n\nvar query = \"SELECT * FROM lignes_ecritures \" +\n  \"WHERE tenant_id = \" + esc(tenantId) + \"::uuid \" +\n  \"AND id IN (\" + inClause + \") \" +\n  \"ORDER BY date_ecriture ASC\";\n\nreturn {\n  query: query,\n  ligneIds: ligneIds,\n  tenantId: tenantId\n};"
      },
      "id": "build_queries",
      "name": "Build Queries",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        850,
        300
      ]
    },
    {
      "parameters": {
        "credential": "OGqj65ZoFRileCck",
        "mode": "rawQuery",
        "query": "{{$node.build_queries.output.json.query}}",
        "options": {
          "alwaysOutputData": true
        }
      },
      "id": "get_lignes",
      "name": "Get Lignes",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        1050,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "var lignes = $node.get_lignes.output.json[0].pairedItem.item || [];\n\nif (!Array.isArray(lignes)) {\n  lignes = $node.get_lignes.output.json[0] ? [$node.get_lignes.output.json[0]] : [];\n}\n\n// Verify we have at least 2 lignes\nif (lignes.length < 2) {\n  return {\n    error: \"At least 2 accounting lines required for lettrage\",\n    valid: false\n  };\n}\n\n// Calculate total debits and credits\nvar totalDebits = lignes.reduce(function(sum, ligne) {\n  return sum + (parseFloat(ligne.debit) || 0);\n}, 0);\n\nvar totalCredits = lignes.reduce(function(sum, ligne) {\n  return sum + (parseFloat(ligne.credit) || 0);\n}, 0);\n\n// Check balance with tolerance of 0.05 EUR\nvar tolerance = 0.05;\nvar difference = Math.abs(totalDebits - totalCredits);\n\nif (difference > tolerance) {\n  return {\n    error: \"Debit and credit balance mismatch. Difference: \" + difference.toFixed(2),\n    valid: false,\n    totalDebits: totalDebits,\n    totalCredits: totalCredits\n  };\n}\n\n// Generate lettrage code with timestamp\nvar now = new Date();\nvar letterageCode = \"LTR_\" + now.getTime() + \"_\" + Math.random().toString(36).substring(7).toUpperCase();\n\nreturn {\n  lignes: lignes,\n  totalDebits: totalDebits,\n  totalCredits: totalCredits,\n  difference: difference,\n  letterageCode: letterageCode,\n  valid: true\n};"
      },
      "id": "verify_balance",
      "name": "Verify Balance",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1250,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "matchType": "all",
          "conditions": [
            {
              "key": "{{$node.verify_balance.output.json.valid}}",
              "condition": "equals",
              "value": true
            }
          ]
        }
      },
      "id": "if_balance_valid",
      "name": "IF Balance Valid",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1450,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "function esc(v) {\n  return \"'\" + String(v).replace(/'/g, \"''\") + \"'\";\n}\n\nvar lignes = $node.verify_balance.output.json.lignes;\nvar letterageCode = $node.verify_balance.output.json.letterageCode;\nvar tenantId = $node.parser.output.json.tenantId;\nvar now = new Date().toISOString();\n\n// Build IN clause for UPDATE statement\nvar ligneIds = lignes.map(function(ligne) {\n  return esc(ligne.id) + \"::uuid\";\n});\nvar inClause = \"(\" + ligneIds.join(\",\") + \")\";\n\nvar updateQuery = \"UPDATE lignes_ecritures \" +\n  \"SET lettrage = \" + esc(letterageCode) + \", \" +\n  \"date_lettrage = \" + esc(now) + \"::timestamp \" +\n  \"WHERE id IN \" + inClause + \" \" +\n  \"AND tenant_id = \" + esc(tenantId) + \"::uuid\";\n\nvar insertQuery = \"INSERT INTO lettrages \" +\n  \"(tenant_id, lettrage_code, date_lettrage, nombre_lignes, montant_total) \" +\n  \"VALUES (\" +\n  esc(tenantId) + \"::uuid, \" +\n  esc(letterageCode) + \", \" +\n  esc(now) + \"::timestamp, \" +\n  lignes.length + \", \" +\n  $node.verify_balance.output.json.totalDebits +\n  \")\";\n\nreturn {\n  updateQuery: updateQuery,\n  insertQuery: insertQuery,\n  letterageCode: letterageCode,\n  ligneCount: lignes.length\n};"
      },
      "id": "build_update",
      "name": "Build Update",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1650,
        300
      ]
    },
    {
      "parameters": {
        "credential": "OGqj65ZoFRileCck",
        "mode": "rawQuery",
        "query": "{{$node.build_update.output.json.updateQuery}}",
        "options": {
          "alwaysOutputData": true
        }
      },
      "id": "apply_lettrage",
      "name": "Apply Lettrage",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        1850,
        300
      ]
    },
    {
      "parameters": {
        "credential": "OGqj65ZoFRileCck",
        "mode": "rawQuery",
        "query": "{{$node.build_update.output.json.insertQuery}}",
        "options": {
          "alwaysOutputData": true
        }
      },
      "id": "insert_lettrage",
      "name": "Insert Lettrage",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        2050,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "return {\n  success: true,\n  letterageCode: $node.build_update.output.json.letterageCode,\n  message: \"Lettrage applied successfully\",\n  ligneCount: $node.build_update.output.json.ligneCount,\n  totalDebits: $node.verify_balance.output.json.totalDebits,\n  totalCredits: $node.verify_balance.output.json.totalCredits\n};"
      },
      "id": "format_response",
      "name": "Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2250,
        300
      ]
    },
    {
      "parameters": {
        "respondWithCode": 200,
        "responseBody": "{{$node.format_response.output.json}}"
      },
      "id": "respond_success",
      "name": "Respond Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        2450,
        300
      ]
    },
    {
      "parameters": {
        "respondWithCode": 422,
        "responseBody": "{{{\n  \"error\": $node.verify_balance.output.json.error,\n  \"success\": false,\n  \"totalDebits\": $node.verify_balance.output.json.totalDebits,\n  \"totalCredits\": $node.verify_balance.output.json.totalCredits\n}}}"
      },
      "id": "respond_balance_error",
      "name": "Respond Balance Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1650,
        150
      ]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Parser",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parser": {
      "main": [
        [
          {
            "node": "IF Valide",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Valide": {
      "main": [
        [
          {
            "node": "Build Queries",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Queries": {
      "main": [
        [
          {
            "node": "Get Lignes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Lignes": {
      "main": [
        [
          {
            "node": "Verify Balance",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verify Balance": {
      "main": [
        [
          {
            "node": "IF Balance Valid",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Balance Valid": {
      "main": [
        [
          {
            "node": "Build Update",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond Balance Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Update": {
      "main": [
        [
          {
            "node": "Apply Lettrage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Apply Lettrage": {
      "main": [
        [
          {
            "node": "Insert Lettrage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert Lettrage": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Response": {
      "main": [
        [
          {
            "node": "Respond Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  }
}