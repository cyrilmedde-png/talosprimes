{
  "name": "compta-plan-comptable-list",
  "nodes": [
    {
      "parameters": {
        "path": "compta-plan-comptable-list",
        "responseMode": "responseNode",
        "httpMethod": "POST"
      },
      "id": "01. Webhook",
      "name": "01. Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        100,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "var body = $input.first().json.body || $input.first().json;\nif (!body.tenantId) throw new Error('tenantId is required');\nvar classe = body.classe ? parseInt(body.classe) : null;\nvar search = body.search || null;\nvar nature = body.nature || null;\nreturn [{ json: { tenantId: body.tenantId, classe, search, nature } }];"
      },
      "id": "02. Parser",
      "name": "02. Parser",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        300,
        200
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": ""
          },
          "conditions": [
            {
              "id": "64d3f3b7-3373-4cd1-a69f-ad313d62c5aa",
              "leftValue": "={{ $json.tenantId }}",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "03. Valide ?",
      "name": "03. Valide ?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        500,
        200
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={ \"success\": false, \"error\": \"tenantId manquant\" }"
      },
      "id": "04. Respond Error",
      "name": "04. Respond Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        700,
        100
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ \"SELECT id, numero_compte, libelle, classe, type, nature, compte_parent, actif, solde_debit, solde_credit FROM plan_comptable WHERE tenant_id = '\" + $json.tenantId + \"' AND actif = true AND \" + ($json.classe ? \"classe = '\" + $json.classe + \"'\" : \"1=1\") + \" AND \" + ($json.nature ? \"nature = '\" + $json.nature + \"'\" : \"1=1\") + \" AND ('\" + $json.search + \"' IS NULL OR (numero_compte ILIKE '%' || '\" + $json.search + \"' || '%' OR libelle ILIKE '%' || '\" + $json.search + \"' || '%')) ORDER BY numero_compte ASC;\" }}"
      },
      "id": "05. Query",
      "name": "05. Query",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "credentials": {
        "postgres": {
          "name": "Supabase Postgres",
          "id": "OGqj65ZoFRileCck"
        }
      },
      "position": [
        700,
        300
      ],
      "alwaysOutputData": true,
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "var items = $('05. Query').all().map(function(item) { return item.json; }).filter(function(c) { return c.id; });\nvar comptes = items.map(function(c) { return ({\n  id: c.id,\n  numeroCompte: c.numero_compte,\n  libelle: c.libelle,\n  classe: c.classe,\n  type: c.type,\n  nature: c.nature,\n  compteParent: c.compte_parent,\n  soldeDebit: parseFloat(c.solde_debit) || 0,\n  soldeCredit: parseFloat(c.solde_credit) || 0,\n  solde: (parseFloat(c.solde_debit) || 0) - (parseFloat(c.solde_credit) || 0)\n}); });\nreturn [{ json: { success: true, comptes, count: comptes.length } }];"
      },
      "id": "06. Format Response",
      "name": "06. Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        900,
        300
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}"
      },
      "id": "07. Respond",
      "name": "07. Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1100,
        300
      ]
    }
  ],
  "connections": {
    "01. Webhook": {
      "main": [
        [
          {
            "node": "02. Parser",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "02. Parser": {
      "main": [
        [
          {
            "node": "03. Valide ?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "03. Valide ?": {
      "main": [
        [
          {
            "node": "05. Query",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "04. Respond Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "05. Query": {
      "main": [
        [
          {
            "node": "06. Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "06. Format Response": {
      "main": [
        [
          {
            "node": "07. Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "active": true,
  "id": "compta-plan-comptable-list"
}