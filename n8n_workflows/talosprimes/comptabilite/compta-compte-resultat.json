{
  "id": "compta-compte-resultat",
  "name": "Compte de Résultat",
  "active": true,
  "nodes": [
    {
      "parameters": {
        "path": "compta-compte-resultat",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        250,
        100
      ],
      "webhookId": "webhook"
    },
    {
      "parameters": {
        "jsCode": "var body = $input.first().json;\nvar tenantId = body.tenantId;\nvar dateFrom = body.dateFrom;\nvar dateTo = body.dateTo;\n\nif (!tenantId || !dateFrom || !dateTo) {\n  throw new Error('Missing required fields: tenantId, dateFrom, dateTo');\n}\n\nreturn {\n  json: {\n    tenantId,\n    dateFrom,\n    dateTo\n  }\n};"
      },
      "id": "parser",
      "name": "Parser",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        450,
        100
      ],
      "executionOrder": "v1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "nodeOutputType": "json"
          },
          "conditions": [
            {
              "key": "tenantId",
              "condition": "exists"
            }
          ]
        }
      },
      "id": "ifValide",
      "name": "IF Valide",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        650,
        100
      ]
    },
    {
      "parameters": {
        "respondWithOptions": {
          "responseType": "json"
        },
        "options": {}
      },
      "id": "respondError",
      "name": "Respond Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        850,
        250
      ]
    },
    {
      "parameters": {
        "jsCode": "var { tenantId, dateFrom, dateTo } = $input.first().json;\n\nfunction esc(value) {\n  if (typeof value === 'string') {\n    return \"'\" + value.replace(/'/g, \"''\") + \"'\";\n  }\n  return value;\n}\n\nvar query = `\nSELECT le.numero_compte, pc.libelle, pc.classe,\n  CASE WHEN pc.classe = 6 THEN COALESCE(SUM(le.debit - le.credit), 0)\n       WHEN pc.classe = 7 THEN COALESCE(SUM(le.credit - le.debit), 0) ELSE 0 END as montant\nFROM lignes_ecritures le\nJOIN ecritures_comptables e ON le.ecriture_id = e.id\nLEFT JOIN plan_comptable pc ON le.numero_compte = pc.numero_compte AND pc.tenant_id = e.tenant_id\nWHERE e.tenant_id = ${esc(tenantId)}::uuid\n  AND e.statut = 'validee'\n  AND pc.classe IN (6, 7)\n  AND e.date >= ${esc(dateFrom)}::date\n  AND e.date <= ${esc(dateTo)}::date\nGROUP BY le.numero_compte, pc.libelle, pc.classe\nHAVING SUM(CASE WHEN pc.classe = 6 THEN le.debit - le.credit WHEN pc.classe = 7 THEN le.credit - le.debit ELSE 0 END) != 0\nORDER BY le.numero_compte\n`;\n\nreturn {\n  json: {\n    query: query.trim(),\n    tenantId,\n    dateFrom,\n    dateTo\n  }\n};"
      },
      "id": "buildQueries",
      "name": "Build Queries",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        850,
        100
      ],
      "executionOrder": "v1"
    },
    {
      "parameters": {
        "nodeCredentialType": "postgres",
        "connectionProperties": {
          "database": {},
          "credentials": {
            "credentialsId": "OGqj65ZoFRileCck"
          }
        },
        "queryType": "raw",
        "query": "={{ $node.buildQueries.json.query }}",
        "options": {
          "alwaysOutputData": true
        }
      },
      "id": "queryCR",
      "name": "Query CR",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        1050,
        100
      ],
      "credentials": {
        "postgres": {
          "id": "OGqj65ZoFRileCck",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "var rows = $input.first().json;\nvar { dateFrom, dateTo } = $node.buildQueries.json;\n\nvar produitsExploitation = [];\nvar produitsFinanciers = [];\nvar produitsExceptionnels = [];\n\nvar chargesExploitation = [];\nvar chargesFinancieres = [];\nvar chargesExceptionnelles = [];\n\nvar totalProduits = 0;\nvar totalCharges = 0;\n\nif (Array.isArray(rows)) {\n  rows.forEach(row => {\n    var { numero_compte, libelle, classe, montant } = row;\n    var poste = {\n      numero: numero_compte,\n      libelle: libelle || 'Sans libellé',\n      montant: parseFloat(montant) || 0\n    };\n\n    if (classe === 7) {\n      totalProduits += poste.montant;\n      var numPrefix = numero_compte.substring(0, 2);\n      if (numPrefix >= '70' && numPrefix <= '75') {\n        produitsExploitation.push(poste);\n      } else if (numPrefix === '76') {\n        produitsFinanciers.push(poste);\n      } else if (numPrefix === '77') {\n        produitsExceptionnels.push(poste);\n      }\n    } else if (classe === 6) {\n      totalCharges += poste.montant;\n      var numPrefix = numero_compte.substring(0, 2);\n      if (numPrefix >= '60' && numPrefix <= '65') {\n        chargesExploitation.push(poste);\n      } else if (numPrefix === '66') {\n        chargesFinancieres.push(poste);\n      } else if (numPrefix === '67') {\n        chargesExceptionnelles.push(poste);\n      }\n    }\n  });\n}\n\nvar resultatExploitation = totalProduits - totalCharges;\nvar resultatFinancier = 0;\nvar resultatExceptionnel = 0;\nvar resultatNet = resultatExploitation + resultatFinancier + resultatExceptionnel;\n\nreturn {\n  json: {\n    success: true,\n    produits: {\n      produitsExploitation,\n      produitsFinanciers,\n      produitsExceptionnels,\n      totalProduits\n    },\n    charges: {\n      chargesExploitation,\n      chargesFinancieres,\n      chargesExceptionnelles,\n      totalCharges\n    },\n    resultatExploitation,\n    resultatFinancier,\n    resultatExceptionnel,\n    resultatNet,\n    periode: {\n      dateFrom,\n      dateTo\n    }\n  }\n};"
      },
      "id": "formatCR",
      "name": "Format CR",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1250,
        100
      ],
      "executionOrder": "v1"
    },
    {
      "parameters": {
        "respondWithOptions": {
          "responseType": "json"
        },
        "options": {}
      },
      "id": "respond",
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1450,
        100
      ]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Parser",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parser": {
      "main": [
        [
          {
            "node": "IF Valide",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Valide": {
      "main": [
        [
          {
            "node": "Build Queries",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Queries": {
      "main": [
        [
          {
            "node": "Query CR",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query CR": {
      "main": [
        [
          {
            "node": "Format CR",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format CR": {
      "main": [
        [
          {
            "node": "Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}