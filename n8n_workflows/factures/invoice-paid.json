{
  "name": "invoice-paid",
  "nodes": [
    {
      "parameters": {
        "path": "invoice-paid",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "01. Webhook",
      "name": "01. Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        250,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Validate required fields from webhook payload\nconst { tenantId, invoiceId, paymentMethod, idExternePaiement, montantRecu } = $input.all().body;\n\nconst errors = [];\n\nif (!tenantId) {\n  errors.push('tenantId is required');\n}\nif (!invoiceId) {\n  errors.push('invoiceId is required');\n}\n\nif (errors.length > 0) {\n  throw new Error('Validation failed: ' + errors.join(', '));\n}\n\nreturn {\n  tenantId,\n  invoiceId,\n  paymentMethod: paymentMethod || null,\n  idExternePaiement: idExternePaiement || null,\n  montantRecu: montantRecu || null\n};"
      },
      "id": "02. Parser payload",
      "name": "02. Parser payload",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        450,
        300
      ],
      "credentials": [],
      "connections": {
        "01. Webhook": [
          [
            0
          ]
        ]
      }
    },
    {
      "parameters": {
        "workbench": {
          "executionMode": "query",
          "queryString": "SELECT i.*, cf.email, cf.nom, cf.prenom FROM invoices i LEFT JOIN client_finals cf ON i.client_final_id = cf.id WHERE i.id=$1 AND i.tenant_id=$2"
        },
        "parameterizedQueries": true,
        "parameters": [
          {
            "name": "$1",
            "value": "={{ $prev.invoiceId }}"
          },
          {
            "name": "$2",
            "value": "={{ $prev.tenantId }}"
          }
        ]
      },
      "id": "03. Récupérer facture",
      "name": "03. Récupérer facture",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        650,
        300
      ],
      "credentials": {
        "postgres": {
          "id": "postgres-credential",
          "name": "Postgres Supabase"
        }
      },
      "connections": {
        "02. Parser payload": [
          [
            0
          ]
        ]
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": [
            {
              "condition": "objectExists",
              "value1": "={{ $prev.output[0] }}",
              "value2": null
            }
          ],
          "combinator": "and"
        }
      },
      "id": "04. Validation facture",
      "name": "04. Validation facture",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        850,
        300
      ],
      "connections": {
        "03. Récupérer facture": [
          [
            0
          ]
        ]
      }
    },
    {
      "parameters": {
        "workbench": {
          "executionMode": "query",
          "queryString": "UPDATE invoices SET statut='payee', id_externe_paiement=$1, updated_at=NOW() WHERE id=$2"
        },
        "parameterizedQueries": true,
        "parameters": [
          {
            "name": "$1",
            "value": "={{ $nodes['02. Parser payload'].output[0].idExternePaiement }}"
          },
          {
            "name": "$2",
            "value": "={{ $nodes['03. Récupérer facture'].output[0].id }}"
          }
        ]
      },
      "id": "05. Mettre à jour facture",
      "name": "05. Mettre à jour facture",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        1050,
        150
      ],
      "credentials": {
        "postgres": {
          "id": "postgres-credential",
          "name": "Postgres Supabase"
        }
      },
      "connections": {
        "04. Validation facture": [
          [
            0
          ]
        ]
      }
    },
    {
      "parameters": {
        "jsCode": "const invoice = $nodes['03. Récupérer facture'].output[0];\nconst { paymentMethod, montantRecu } = $nodes['02. Parser payload'].output[0];\nconst paymentDate = new Date().toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' });\n\nconst htmlContent = `\n<!DOCTYPE html>\n<html lang=\"fr\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>Confirmation de paiement</title>\n  <style>\n    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; }\n    .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n    .header { text-align: center; margin-bottom: 30px; border-bottom: 1px solid #e0e0e0; padding-bottom: 20px; }\n    .checkmark { display: inline-block; width: 50px; height: 50px; background-color: #4caf50; border-radius: 50%; line-height: 50px; text-align: center; color: white; font-size: 30px; margin-bottom: 10px; }\n    .title { color: #2e7d32; font-size: 24px; margin: 15px 0; }\n    .content { margin: 20px 0; }\n    .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }\n    .info-label { color: #666; font-weight: 500; }\n    .info-value { color: #333; font-weight: 600; }\n    .amount { font-size: 20px; color: #2e7d32; font-weight: bold; }\n    .footer { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0; color: #666; font-size: 12px; }\n    .button { display: inline-block; background-color: #2e7d32; color: white; padding: 12px 30px; border-radius: 4px; text-decoration: none; margin-top: 20px; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <div class=\"checkmark\">✓</div>\n      <div class=\"title\">Paiement confirmé</div>\n      <p style=\"margin: 5px 0; color: #666;\">Votre facture a été payée avec succès</p>\n    </div>\n    \n    <div class=\"content\">\n      <h2 style=\"color: #333; font-size: 16px; margin-bottom: 20px;\">Détails de paiement</h2>\n      \n      <div class=\"info-row\">\n        <span class=\"info-label\">Numéro de facture</span>\n        <span class=\"info-value\">${invoice.numero || invoice.id}</span>\n      </div>\n      \n      <div class=\"info-row\">\n        <span class=\"info-label\">Date de paiement</span>\n        <span class=\"info-value\">${paymentDate}</span>\n      </div>\n      \n      <div class=\"info-row\">\n        <span class=\"info-label\">Montant payé (TTC)</span>\n        <span class=\"info-value amount\">${montantRecu ? montantRecu.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' }) : invoice.montant_total?.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' })}</span>\n      </div>\n      \n      ${paymentMethod ? `\n      <div class=\"info-row\">\n        <span class=\"info-label\">Méthode de paiement</span>\n        <span class=\"info-value\">${paymentMethod}</span>\n      </div>\n      ` : ''}\n      \n      <p style=\"margin-top: 30px; text-align: center; font-size: 16px; color: #2e7d32; font-weight: 500;\">\n        Merci pour votre paiement !\n      </p>\n      \n      <p style=\"text-align: center; margin-top: 20px;\">\n        <a href=\"#\" class=\"button\">Télécharger le reçu</a>\n      </p>\n    </div>\n    \n    <div class=\"footer\">\n      <p>TalosPrimes - Gestion de factures</p>\n      <p>© ${new Date().getFullYear()} Tous droits réservés</p>\n    </div>\n  </div>\n</body>\n</html>\n`;\n\nreturn {\n  to: invoice.email,\n  subject: `Paiement confirmé - Facture ${invoice.numero || invoice.id}`,\n  htmlContent,\n  clientName: invoice.nom || invoice.prenom || 'Client'\n};"
      },
      "id": "06. Préparer reçu email",
      "name": "06. Préparer reçu email",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1050,
        350
      ],
      "credentials": [],
      "connections": {
        "05. Mettre à jour facture": [
          [
            0
          ]
        ]
      }
    },
    {
      "parameters": {
        "url": "https://api.resend.com/emails",
        "method": "POST",
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $credentials.headerAuth.api_key }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParametersUi": "keyvalue",
        "bodyParameters": {
          "parameters": [
            {
              "name": "from",
              "value": "noreply@talosprimes.com"
            },
            {
              "name": "to",
              "value": "={{ $prev.to }}"
            },
            {
              "name": "subject",
              "value": "={{ $prev.subject }}"
            },
            {
              "name": "html",
              "value": "={{ $prev.htmlContent }}"
            }
          ]
        }
      },
      "id": "07. Envoyer email Resend",
      "name": "07. Envoyer email Resend",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1250,
        350
      ],
      "credentials": {
        "headerAuth": {
          "id": "resend-api-credential",
          "name": "Resend API"
        }
      },
      "connections": {
        "06. Préparer reçu email": [
          [
            0
          ]
        ]
      }
    },
    {
      "parameters": {
        "url": "https://api.talosprimes.com/api/notifications",
        "method": "POST",
        "headerParameters": {
          "parameters": []
        },
        "sendBody": true,
        "bodyParametersUi": "keyvalue",
        "bodyParameters": {
          "parameters": [
            {
              "name": "type",
              "value": "invoice_paid"
            },
            {
              "name": "tenantId",
              "value": "={{ $nodes['02. Parser payload'].output[0].tenantId }}"
            },
            {
              "name": "invoiceId",
              "value": "={{ $nodes['03. Récupérer facture'].output[0].id }}"
            },
            {
              "name": "status",
              "value": "completed"
            },
            {
              "name": "timestamp",
              "value": "={{ new Date().toISOString() }}"
            }
          ]
        },
        "authentication": "headerAuth"
      },
      "id": "08. Notification TalosPrimes",
      "name": "08. Notification TalosPrimes",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1250,
        150
      ],
      "credentials": {
        "headerAuth": {
          "id": "talosprimes-api-credential",
          "name": "API TalosPrimes - Header Auth"
        }
      },
      "connections": {
        "07. Envoyer email Resend": [
          [
            0
          ]
        ]
      }
    },
    {
      "parameters": {
        "responseData": "={{ { success: true, message: 'Invoice payment confirmed', invoiceId: $nodes['03. Récupérer facture'].output[0].id, invoiceNumber: $nodes['03. Récupérer facture'].output[0].numero || $nodes['03. Récupérer facture'].output[0].id, paymentDate: new Date().toISOString(), amount: $nodes['03. Récupérer facture'].output[0].montant_total } }}"
      },
      "id": "09. Répondre succès",
      "name": "09. Répondre succès",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1450,
        150
      ],
      "connections": {
        "08. Notification TalosPrimes": [
          [
            0
          ]
        ]
      }
    },
    {
      "parameters": {
        "responseData": "={{ { success: false, message: 'Invoice not found or invalid', tenantId: $nodes['02. Parser payload'].output[0].tenantId, invoiceId: $nodes['02. Parser payload'].output[0].invoiceId } }}"
      },
      "id": "Répondre erreur not found",
      "name": "Répondre erreur not found",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1050,
        500
      ],
      "connections": {
        "04. Validation facture": [
          [
            1
          ]
        ]
      }
    }
  ],
  "connections": {},
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "19b46149-5d6d-4d42-b0a2-1a1f3c7f8e2b",
  "meta": {
    "instanceId": "93e8c4f2-7b1c-4d8e-9a2f-1c3e5g7h9j1l"
  },
  "pinData": {}
}
