// Prisma Schema pour TalosPrimes
// Base de données: Supabase PostgreSQL

generator client {
  provider = "prisma-client-js"
}

// Configuration du seed
// npm install -D tsx
// pnpm db:seed

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum TenantStatus {
  actif
  suspendu
  resilie
}

enum UserRole {
  super_admin
  admin
  collaborateur
  lecture_seule
}

enum UserStatus {
  actif
  inactif
}

enum ClientFinalType {
  b2b
  b2c
}

enum ClientFinalStatus {
  actif
  inactif
  suspendu
}

enum SubscriptionStatus {
  actif
  annule
  en_retard
  suspendu
}

enum PaymentStatus {
  ok
  en_retard
  suspendu
}

enum PaymentProvider {
  stripe
  autre
}

enum InvoiceType {
  facture_entreprise
  facture_client_final
  facture_achat
}

enum InvoiceStatus {
  brouillon
  envoyee
  payee
  en_retard
  annulee
}

enum WorkflowStatus {
  actif
  inactif
}

enum EventExecutionStatus {
  succes
  erreur
  en_attente
}

enum LeadStatus {
  nouveau
  contacte
  converti
  abandonne
}

enum CallDirection {
  entrant
  sortant
}

enum UrgencyLevel {
  CRITIQUE
  URGENT
  STANDARD
  INFO
}

enum CallActionTaken {
  RDV
  DISPATCH
  DEVIS
  TRANSFERT
  INFO
}

enum CallSentiment {
  POSITIF
  NEUTRE
  FRUSTRE
  EN_DETRESSE
}

enum QuestionnaireStatus {
  en_cours
  complete
  abandonne
}

enum QuestionnaireChannel {
  telephone
  sms
  web
}

enum ClientSpaceStatus {
  en_creation
  en_attente_validation
  actif
  suspendu
  supprime
}

// ============================================
// ENUMS - COMPTABILITE
// ============================================

enum EcritureStatut {
  brouillon
  validee
  annulee
}

enum JournalType {
  VE   // Ventes
  AC   // Achats
  BQ   // Banque
  OD   // Opérations Diverses
  AN   // A Nouveaux
}

enum CompteNature {
  actif
  passif
  charge
  produit
}

enum CompteType {
  general
  auxiliaire
  analytique
}

enum DeclarationTvaStatut {
  brouillon
  validee
  transmise
}

enum ImmobilisationStatut {
  en_cours
  actif
  cede
  mis_au_rebut
}

enum RapprochementStatut {
  en_cours
  valide
}

enum StatutJuridique {
  SA
  SARL
  SAS
  SASU
  SCI
  SNC
  SCS
  SCA
  EURL
  SCP
  SEL
  SELARL
  SELAS
  SELAFA
  AUTO_ENTREPRENEUR
  EIRL
  ENTREPRISE_INDIVIDUELLE
}

// ============================================
// MODELS
// ============================================

// Entreprise (Tenant) - Client direct de la plateforme
model Tenant {
  id              String          @id @default(uuid()) @db.Uuid
  nomEntreprise   String          @map("nom_entreprise")
  siret           String?         @map("siret")
  siren           String?         @map("siren")
  codeAPE         String?         @map("code_ape")
  codeNAF         String?         @map("code_naf")
  statutJuridique StatutJuridique? @map("statut_juridique")
  adressePostale  String?         @map("adresse_postale") @db.Text
  codePostal      String?         @map("code_postal")
  ville           String?         @map("ville")
  pays            String          @default("FR")
  telephone       String?         @map("telephone")
  emailContact    String          @map("email_contact")
  tvaIntracom     String?         @map("tva_intracom")
  rib             String?         @map("rib") @db.Text
  logoBase64      String?         @map("logo_base64") @db.Text
  devise          String          @default("EUR")
  langue          String          @default("fr")
  metier          String          @map("metier")
  statut          TenantStatus    @default(actif)
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  // Relations
  users              User[]
  subscription       Subscription?
  clients            ClientFinal[]
  invoices           Invoice[]
  articleCodes       ArticleCode[]
  bonsCommande       BonCommande[]
  workflowLinks      WorkflowLink[]
  eventLogs          EventLog[]
  notifications      Notification[]
  agentCalendarEvents AgentCalendarEvent[]
  devis              Devis[]
  agentConfig        TenantAgentConfig?
  avoirs             Avoir[]
  proformas          Proforma[]
  leads              Lead[]
  callLogs           CallLog[]
  twilioConfig       TwilioConfig?
  smsLogs            SmsLog[]
  questionnaires     Questionnaire[]
  // Comptabilité
  exercicesComptables   ExerciceComptable[]
  planComptable         PlanComptable[]
  journauxComptables    JournalComptable[]
  ecrituresComptables   EcritureComptable[]
  lettrages             Lettrage[]
  rapprochementsBancaires RapprochementBancaire[]
  declarationsTva       DeclarationTva[]
  immobilisations       Immobilisation[]
  comptaIaLogs          ComptaIaLog[]
  clientSpaces          ClientSpace[]
  // Gestion d'équipe
  equipeMembers         EquipeMember[]
  equipeAbsences        EquipeAbsence[]
  equipePointages       EquipePointage[]
  // Gestion de projet
  projets               Projet[]
  projetTaches          ProjetTache[]
  // BTP
  btpChantiers          BtpChantier[]
  btpSituations         BtpSituation[]
  // Ressources Humaines
  rhContrats            RhContrat[]
  rhBulletinsPaie       RhBulletinPaie[]
  rhConges              RhConge[]
  rhDocuments           RhDocument[]
  rhEntretiens          RhEntretien[]
  rhFormations          RhFormation[]
  rhInscriptions        RhInscriptionFormation[]
  rhEvaluations         RhEvaluation[]
  agentKnowledgeEntries AgentKnowledgeEntry[]

  @@index([emailContact])
  @@index([statut])
  @@map("tenants")
}

// Utilisateur (attaché à une entreprise)
model User {
  id                String      @id @default(uuid()) @db.Uuid
  tenantId          String      @map("tenant_id") @db.Uuid
  email             String
  passwordHash      String      @map("password_hash")
  mustChangePassword Boolean    @default(false) @map("must_change_password")
  role              UserRole    @default(collaborateur)
  nom               String?     @map("nom")
  prenom            String?     @map("prenom")
  telephone         String?     @map("telephone")
  fonction          String?     @map("fonction")
  salaire           Decimal?    @map("salaire") @db.Decimal(10, 2)
  dateEmbauche      DateTime?   @map("date_embauche") @db.Timestamptz(6)
  lastLoginAt       DateTime?   @map("last_login_at") @db.Timestamptz(6)
  statut            UserStatus  @default(actif)
  createdAt         DateTime    @default(now()) @map("created_at")

  // Relations
  tenant         Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  equipeMembers  EquipeMember[]

  @@unique([tenantId, email])
  @@index([email])
  @@index([tenantId])
  @@index([fonction])
  @@map("users")
}

// Client Final (client de l'entreprise cliente)
model ClientFinal {
  id             String            @id @default(uuid()) @db.Uuid
  tenantId       String            @map("tenant_id") @db.Uuid
  type           ClientFinalType
  raisonSociale  String?           @map("raison_sociale")
  nom            String?           @map("nom")
  prenom         String?           @map("prenom")
  email          String
  telephone      String?           @map("telephone")
  adresse        String?           @map("adresse") @db.Text
  tags           String[]          @default([]) @db.Text
  statut         ClientFinalStatus @default(actif)
  createdAt      DateTime          @default(now()) @map("created_at")
  updatedAt      DateTime          @updatedAt @map("updated_at")

  // Relations
  tenant         Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  subscriptions  ClientSubscription[]
  invoices       Invoice[]
  bonsCommande   BonCommande[]
  devis          Devis[]
  avoirs         Avoir[]
  proformas      Proforma[]
  clientSpaces   ClientSpace[]
  clientModules  ClientModule[]
  projets        Projet[]
  btpChantiers   BtpChantier[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
  @@map("client_finals")
}

// Espace Client (provisionné par n8n + SSH)
model ClientSpace {
  id                String             @id @default(uuid()) @db.Uuid
  tenantId          String             @map("tenant_id") @db.Uuid
  clientFinalId     String             @map("client_final_id") @db.Uuid
  clientTenantId    String?            @map("client_tenant_id") @db.Uuid
  tenantSlug        String             @map("tenant_slug")
  folderPath        String?            @map("folder_path")
  status            ClientSpaceStatus  @default(en_creation)
  modulesActives    String[]           @default([]) @map("modules_actives")
  validatedAt       DateTime?          @map("validated_at")
  validatedByUserId String?            @map("validated_by_user_id") @db.Uuid
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")

  // Relations
  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientFinal ClientFinal @relation(fields: [clientFinalId], references: [id], onDelete: Cascade)

  @@unique([tenantId, clientFinalId])
  @@index([tenantId])
  @@index([status])
  @@map("client_spaces")
}

// Module Métier (catalogue de modules)
model ModuleMetier {
  id                  String   @id @default(uuid()) @db.Uuid
  code                String   @unique
  nomAffiche          String   @map("nom_affiché")
  description         String?  @map("description") @db.Text
  metierCible         String?  @map("metier_cible")
  prixParMois         Decimal  @map("prix_par_mois") @db.Decimal(10, 2)
  prixParUtilisateur  Decimal? @map("prix_par_utilisateur") @db.Decimal(10, 2)
  categorie           String?  @map("categorie")
  icone               String?  @map("icone")
  ordreAffichage      Int      @default(0) @map("ordre_affichage")
  actif               Boolean  @default(true) @map("actif")
  workflowTemplates   String[] @default([]) @map("workflow_templates") @db.Text
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  workflowLinks  WorkflowLink[]
  planModules    PlanModule[]
  clientModules  ClientModule[]

  @@index([code])
  @@index([metierCible])
  @@map("module_metiers")
}

// Plan d'abonnement (formules proposées aux clients finaux)
model Plan {
  id                    String   @id @default(uuid()) @db.Uuid
  code                  String   @unique
  nom                   String
  description           String?  @db.Text
  prixMensuel           Decimal  @map("prix_mensuel") @db.Decimal(10, 2)
  prixAnnuel            Decimal? @map("prix_annuel") @db.Decimal(10, 2)
  stripeProductId       String?  @map("stripe_product_id")
  stripePriceIdMensuel  String?  @map("stripe_price_id_mensuel")
  stripePriceIdAnnuel   String?  @map("stripe_price_id_annuel")
  essaiJours            Int      @default(0) @map("essai_jours")
  ordreAffichage        Int      @default(0) @map("ordre_affichage")
  actif                 Boolean  @default(true) @map("actif")
  couleur               String?  @map("couleur")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // Relations
  planModules         PlanModule[]
  clientSubscriptions ClientSubscription[]

  @@index([code])
  @@index([actif])
  @@map("plans")
}

// Liaison Plan ↔ Module (quels modules sont inclus dans chaque plan)
model PlanModule {
  id           String  @id @default(uuid()) @db.Uuid
  planId       String  @map("plan_id") @db.Uuid
  moduleId     String  @map("module_id") @db.Uuid
  limiteUsage  Int?    @map("limite_usage")
  config       Json?   @map("config") @db.JsonB

  // Relations
  plan   Plan         @relation(fields: [planId], references: [id], onDelete: Cascade)
  module ModuleMetier @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@unique([planId, moduleId])
  @@index([planId])
  @@index([moduleId])
  @@map("plan_modules")
}

// Modules attribués à un client final (résultat de son abonnement)
model ClientModule {
  id             String    @id @default(uuid()) @db.Uuid
  clientFinalId  String    @map("client_final_id") @db.Uuid
  moduleId       String    @map("module_id") @db.Uuid
  actif          Boolean   @default(true) @map("actif")
  limiteUsage    Int?      @map("limite_usage")
  usageActuel    Int       @default(0) @map("usage_actuel")
  config         Json?     @map("config") @db.JsonB
  activatedAt    DateTime  @default(now()) @map("activated_at")
  expiresAt      DateTime? @map("expires_at") @db.Timestamptz(6)

  // Relations
  clientFinal ClientFinal  @relation(fields: [clientFinalId], references: [id], onDelete: Cascade)
  module      ModuleMetier @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@unique([clientFinalId, moduleId])
  @@index([clientFinalId])
  @@index([moduleId])
  @@index([actif])
  @@map("client_modules")
}

// Abonnement Entreprise (ce que l'entreprise paye)
model Subscription {
  id                       String          @id @default(uuid()) @db.Uuid
  tenantId                 String          @unique @map("tenant_id") @db.Uuid
  modulesActives           String[]        @default([]) @map("modules_actives") @db.Text
  montantMensuelActuel     Decimal         @map("montant_mensuel_actuel") @db.Decimal(10, 2)
  dateDebut                DateTime        @map("date_debut") @db.Timestamptz(6)
  dateProchainRenouvellement DateTime      @map("date_prochain_renouvellement") @db.Timestamptz(6)
  fournisseurPaiement      PaymentProvider @map("fournisseur_paiement")
  idAbonnementExterne      String?         @map("id_abonnement_externe")
  statusPaiement           PaymentStatus   @default(ok) @map("status_paiement")
  updatedAt                DateTime        @updatedAt @map("updated_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([statusPaiement])
  @@map("subscriptions")
}

// Abonnement Client Final (ce que les clients finaux payent)
model ClientSubscription {
  id                       String              @id @default(uuid()) @db.Uuid
  clientFinalId            String              @map("client_final_id") @db.Uuid
  planId                   String?             @map("plan_id") @db.Uuid
  planInterneId            String?             @map("plan_interne_id")
  nomPlan                  String              @map("nom_plan")
  dateDebut                DateTime            @map("date_debut") @db.Timestamptz(6)
  dateProchainRenouvellement DateTime          @map("date_prochain_renouvellement") @db.Timestamptz(6)
  montantMensuel           Decimal             @map("montant_mensuel") @db.Decimal(10, 2)
  modulesInclus            String[]            @default([]) @map("modules_inclus") @db.Text
  statut                   SubscriptionStatus  @default(actif)
  idAbonnementStripe       String?             @map("id_abonnement_stripe")
  idClientStripe            String?             @map("id_client_stripe")
  temporaryPassword        String?             @map("temporary_password") // Mot de passe temporaire en clair (supprimé après envoi email)
  updatedAt                DateTime            @updatedAt @map("updated_at")

  // Relations
  clientFinal ClientFinal @relation(fields: [clientFinalId], references: [id], onDelete: Cascade)
  plan        Plan?       @relation(fields: [planId], references: [id], onDelete: SetNull)

  @@index([clientFinalId])
  @@index([planId])
  @@index([statut])
  @@index([dateProchainRenouvellement])
  @@map("client_subscriptions")
}

// Facture
model Invoice {
  id                String        @id @default(uuid()) @db.Uuid
  type              InvoiceType
  tenantId          String        @map("tenant_id") @db.Uuid
  clientFinalId     String?       @map("client_final_id") @db.Uuid
  numeroFacture     String        @unique @map("numero_facture")
  dateFacture       DateTime      @map("date_facture") @db.Timestamptz(6)
  dateEcheance      DateTime      @map("date_echeance") @db.Timestamptz(6)
  montantHt         Decimal       @map("montant_ht") @db.Decimal(10, 2)
  montantTtc        Decimal       @map("montant_ttc") @db.Decimal(10, 2)
  tvaTaux           Decimal?      @map("tva_taux") @db.Decimal(5, 2)
  description       String?       @map("description") @db.Text
  codeArticle       String?       @map("code_article")
  modePaiement      String?       @map("mode_paiement")
  statut            InvoiceStatus @default(brouillon)
  lienPdf           String?       @map("lien_pdf")
  idExternePaiement String?       @map("id_externe_paiement")

  // Champs spécifiques facture d'achat (fournisseur)
  fournisseurNom      String?     @map("fournisseur_nom")
  fournisseurSiret    String?     @map("fournisseur_siret")
  fournisseurTvaIntra String?     @map("fournisseur_tva_intra")
  fournisseurAdresse  String?     @map("fournisseur_adresse") @db.Text
  categorieFrais      String?     @map("categorie_frais")
  documentOriginalUrl String?     @map("document_original_url")
  ocrData             Json?       @map("ocr_data")

  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  deletedAt         DateTime?     @map("deleted_at") @db.Timestamptz(6)

  // Relations
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientFinal  ClientFinal? @relation(fields: [clientFinalId], references: [id], onDelete: SetNull)
  lines        InvoiceLine[]
  bonsCommande BonCommande[]
  devis        Devis[]
  avoirs       Avoir[]
  proformas    Proforma[]

  @@unique([tenantId, numeroFacture])
  @@index([tenantId])
  @@index([clientFinalId])
  @@index([statut])
  @@index([dateEcheance])
  @@index([numeroFacture])
  @@map("invoices")
}

// Ligne de facture (detail des articles)
model InvoiceLine {
  id            String   @id @default(uuid()) @db.Uuid
  invoiceId     String   @map("invoice_id") @db.Uuid
  codeArticle   String?  @map("code_article")
  designation   String   @map("designation")
  quantite      Int      @default(1)
  prixUnitaireHt Decimal @map("prix_unitaire_ht") @db.Decimal(10, 2)
  totalHt       Decimal  @map("total_ht") @db.Decimal(10, 2)
  ordre         Int      @default(0) @map("ordre")

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_lines")
}

// Code Article (catalogue réutilisable)
model ArticleCode {
  id            String   @id @default(uuid()) @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  code          String   @map("code")
  designation   String   @map("designation")
  prixUnitaireHt Decimal? @map("prix_unitaire_ht") @db.Decimal(10, 2)
  tvaTaux       Decimal? @map("tva_taux") @db.Decimal(5, 2)
  unite         String?  @map("unite")
  actif         Boolean  @default(true) @map("actif")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, code])
  @@index([tenantId])
  @@map("article_codes")
}

// Bon de commande
enum BonCommandeStatus {
  brouillon
  valide
  facture
  annule
}

model BonCommande {
  id              String            @id @default(uuid()) @db.Uuid
  tenantId        String            @map("tenant_id") @db.Uuid
  clientFinalId   String?           @map("client_final_id") @db.Uuid
  numeroBdc       String            @unique @map("numero_bdc")
  dateBdc         DateTime          @map("date_bdc") @db.Timestamptz(6)
  dateValidite    DateTime?         @map("date_validite") @db.Timestamptz(6)
  montantHt       Decimal           @map("montant_ht") @db.Decimal(10, 2)
  montantTtc      Decimal           @map("montant_ttc") @db.Decimal(10, 2)
  tvaTaux         Decimal?          @map("tva_taux") @db.Decimal(5, 2)
  description     String?           @map("description") @db.Text
  modePaiement    String?           @map("mode_paiement")
  statut          BonCommandeStatus @default(brouillon)
  invoiceId       String?           @map("invoice_id") @db.Uuid
  devisId         String?           @map("devis_id") @db.Uuid
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  deletedAt       DateTime?         @map("deleted_at") @db.Timestamptz(6)

  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientFinal ClientFinal? @relation(fields: [clientFinalId], references: [id], onDelete: SetNull)
  invoice     Invoice?     @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  devisSource Devis?       @relation("DevisToBdc", fields: [devisId], references: [id], onDelete: SetNull)
  lines       BonCommandeLine[]

  @@unique([tenantId, numeroBdc])
  @@index([tenantId])
  @@index([clientFinalId])
  @@index([devisId])
  @@index([statut])
  @@map("bons_commande")
}

model BonCommandeLine {
  id              String   @id @default(uuid()) @db.Uuid
  bonCommandeId   String   @map("bon_commande_id") @db.Uuid
  codeArticle     String?  @map("code_article")
  designation     String   @map("designation")
  quantite        Int      @default(1)
  prixUnitaireHt  Decimal  @map("prix_unitaire_ht") @db.Decimal(10, 2)
  totalHt         Decimal  @map("total_ht") @db.Decimal(10, 2)
  ordre           Int      @default(0) @map("ordre")

  bonCommande BonCommande @relation(fields: [bonCommandeId], references: [id], onDelete: Cascade)

  @@index([bonCommandeId])
  @@map("bon_commande_lines")
}

// Devis (quote / proposition commerciale)
enum DevisStatus {
  brouillon
  envoyee
  acceptee
  refusee
  expiree
  facturee
  commandee
}

model Devis {
  id              String       @id @default(uuid()) @db.Uuid
  tenantId        String       @map("tenant_id") @db.Uuid
  clientFinalId   String?      @map("client_final_id") @db.Uuid
  numeroDevis     String       @unique @map("numero_devis")
  dateDevis       DateTime     @map("date_devis") @db.Timestamptz(6)
  dateValidite    DateTime?    @map("date_validite") @db.Timestamptz(6)
  montantHt       Decimal      @map("montant_ht") @db.Decimal(10, 2)
  montantTtc      Decimal      @map("montant_ttc") @db.Decimal(10, 2)
  tvaTaux         Decimal?     @map("tva_taux") @db.Decimal(5, 2)
  description     String?      @map("description") @db.Text
  modePaiement    String?      @map("mode_paiement")
  statut          DevisStatus  @default(brouillon)
  invoiceId       String?      @map("invoice_id") @db.Uuid
  lienPdf         String?      @map("lien_pdf")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  deletedAt       DateTime?    @map("deleted_at") @db.Timestamptz(6)

  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientFinal ClientFinal? @relation(fields: [clientFinalId], references: [id], onDelete: SetNull)
  invoice     Invoice?     @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  bonsCommande BonCommande[] @relation("DevisToBdc")
  lines       DevisLine[]

  @@unique([tenantId, numeroDevis])
  @@index([tenantId])
  @@index([clientFinalId])
  @@index([statut])
  @@map("devis")
}

model DevisLine {
  id              String   @id @default(uuid()) @db.Uuid
  devisId         String   @map("devis_id") @db.Uuid
  codeArticle     String?  @map("code_article")
  designation     String   @map("designation")
  quantite        Int      @default(1)
  prixUnitaireHt  Decimal  @map("prix_unitaire_ht") @db.Decimal(10, 2)
  totalHt         Decimal  @map("total_ht") @db.Decimal(10, 2)
  ordre           Int      @default(0) @map("ordre")

  devis Devis @relation(fields: [devisId], references: [id], onDelete: Cascade)

  @@index([devisId])
  @@map("devis_lines")
}

// Avoir (credit note / note de crédit)
enum AvoirStatus {
  brouillon
  validee
  annulee
}

model Avoir {
  id              String       @id @default(uuid()) @db.Uuid
  tenantId        String       @map("tenant_id") @db.Uuid
  clientFinalId   String?      @map("client_final_id") @db.Uuid
  invoiceId       String?      @map("invoice_id") @db.Uuid
  numeroAvoir     String       @unique @map("numero_avoir")
  dateAvoir       DateTime     @map("date_avoir") @db.Timestamptz(6)
  montantHt       Decimal      @map("montant_ht") @db.Decimal(10, 2)
  montantTtc      Decimal      @map("montant_ttc") @db.Decimal(10, 2)
  tvaTaux         Decimal?     @map("tva_taux") @db.Decimal(5, 2)
  motif           String?      @map("motif") @db.Text
  description     String?      @map("description") @db.Text
  statut          AvoirStatus  @default(brouillon)
  lienPdf         String?      @map("lien_pdf")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  deletedAt       DateTime?    @map("deleted_at") @db.Timestamptz(6)

  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientFinal ClientFinal? @relation(fields: [clientFinalId], references: [id], onDelete: SetNull)
  invoice     Invoice?     @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  lines       AvoirLine[]

  @@unique([tenantId, numeroAvoir])
  @@index([tenantId])
  @@index([clientFinalId])
  @@index([statut])
  @@map("avoirs")
}

model AvoirLine {
  id              String   @id @default(uuid()) @db.Uuid
  avoirId         String   @map("avoir_id") @db.Uuid
  codeArticle     String?  @map("code_article")
  designation     String   @map("designation")
  quantite        Int      @default(1)
  prixUnitaireHt  Decimal  @map("prix_unitaire_ht") @db.Decimal(10, 2)
  totalHt         Decimal  @map("total_ht") @db.Decimal(10, 2)
  ordre           Int      @default(0) @map("ordre")

  avoir Avoir @relation(fields: [avoirId], references: [id], onDelete: Cascade)

  @@index([avoirId])
  @@map("avoir_lines")
}

// Proforma (facture proforma)
enum ProformaStatus {
  brouillon
  envoyee
  acceptee
  refusee
  expiree
  facturee
  commandee
}

model Proforma {
  id              String          @id @default(uuid()) @db.Uuid
  tenantId        String          @map("tenant_id") @db.Uuid
  clientFinalId   String?         @map("client_final_id") @db.Uuid
  numeroProforma  String          @unique @map("numero_proforma")
  dateProforma    DateTime        @map("date_proforma") @db.Timestamptz(6)
  dateValidite    DateTime?       @map("date_validite") @db.Timestamptz(6)
  montantHt       Decimal         @map("montant_ht") @db.Decimal(10, 2)
  montantTtc      Decimal         @map("montant_ttc") @db.Decimal(10, 2)
  tvaTaux         Decimal?        @map("tva_taux") @db.Decimal(5, 2)
  description     String?         @map("description") @db.Text
  modePaiement    String?         @map("mode_paiement")
  statut          ProformaStatus  @default(brouillon)
  invoiceId       String?         @map("invoice_id") @db.Uuid
  lienPdf         String?         @map("lien_pdf")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  deletedAt       DateTime?       @map("deleted_at") @db.Timestamptz(6)

  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientFinal ClientFinal? @relation(fields: [clientFinalId], references: [id], onDelete: SetNull)
  invoice     Invoice?     @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  lines       ProformaLine[]

  @@unique([tenantId, numeroProforma])
  @@index([tenantId])
  @@index([clientFinalId])
  @@index([statut])
  @@map("proformas")
}

model ProformaLine {
  id              String   @id @default(uuid()) @db.Uuid
  proformaId      String   @map("proforma_id") @db.Uuid
  codeArticle     String?  @map("code_article")
  designation     String   @map("designation")
  quantite        Int      @default(1)
  prixUnitaireHt  Decimal  @map("prix_unitaire_ht") @db.Decimal(10, 2)
  totalHt         Decimal  @map("total_ht") @db.Decimal(10, 2)
  ordre           Int      @default(0) @map("ordre")

  proforma Proforma @relation(fields: [proformaId], references: [id], onDelete: Cascade)

  @@index([proformaId])
  @@map("proforma_lines")
}

// Lien Workflow n8n
model WorkflowLink {
  id              String         @id @default(uuid()) @db.Uuid
  tenantId        String         @map("tenant_id") @db.Uuid
  moduleMetierId  String         @map("module_metier_id") @db.Uuid
  typeEvenement   String         @map("type_evenement")
  workflowN8nId   String         @map("workflow_n8n_id")
  workflowN8nNom  String         @map("workflow_n8n_nom")
  statut          WorkflowStatus @default(actif)
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  // Relations
  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  moduleMetier ModuleMetier @relation(fields: [moduleMetierId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([moduleMetierId])
  @@index([typeEvenement])
  @@unique([tenantId, typeEvenement])
  @@map("workflow_links")
}

// Event Log (journalisation des événements)
model EventLog {
  id                    String                @id @default(uuid()) @db.Uuid
  tenantId              String                @map("tenant_id") @db.Uuid
  typeEvenement         String                @map("type_evenement")
  entiteType            String                @map("entite_type")
  entiteId              String                @map("entite_id") @db.Uuid
  payload               Json                  @map("payload")
  workflowN8nDeclenche  Boolean               @default(false) @map("workflow_n8n_declenche")
  workflowN8nId         String?               @map("workflow_n8n_id")
  statutExecution       EventExecutionStatus  @default(en_attente) @map("statut_execution")
  messageErreur         String?               @map("message_erreur") @db.Text
  createdAt             DateTime              @default(now()) @map("created_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([typeEvenement])
  @@index([statutExecution])
  @@index([createdAt])
  @@map("event_logs")
}

// Lead (demande d'inscription)
model Lead {
  id          String     @id @default(uuid()) @db.Uuid
  tenantId    String?    @map("tenant_id") @db.Uuid
  nom         String
  prenom      String
  email       String
  telephone   String
  statut      LeadStatus @default(nouveau)
  source      String?    @default("formulaire_inscription")
  notes       String?    @db.Text
  dateContact DateTime?  @map("date_contact") @db.Timestamptz(6)
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  // Relations
  tenant         Tenant?         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  callLogs       CallLog[]
  questionnaires Questionnaire[]

  @@unique([email])
  @@index([tenantId])
  @@index([statut])
  @@index([createdAt])
  @@map("leads")
}

// Notification (notifications dans la plateforme)
model Notification {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  type        String   // ex: "lead_inscription", "lead_questionnaire", "lead_entretien", "lead_confirmation", "client_creation"
  titre       String   @map("titre")
  message     String   @map("message") @db.Text
  donnees     Json?    @map("donnees") // Données additionnelles (leadId, clientId, etc.)
  lu          Boolean  @default(false) @map("lu")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([type])
  @@index([lu])
  @@index([createdAt])
  @@map("notifications")
}

// Testimonial (avis clients pour la landing page)
model Testimonial {
  id          String   @id @default(uuid()) @db.Uuid
  nom         String
  prenom      String
  entreprise  String?
  poste       String?  // ex: "CEO", "Directeur Commercial"
  avatar      String?  // URL ou initiales
  note        Int      @default(5) // Note sur 5
  commentaire String   @db.Text
  affiche     Boolean  @default(true) // Afficher ou masquer
  ordre       Int      @default(0) // Ordre d'affichage
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([affiche])
  @@index([ordre])
  @@map("testimonials")
}

// LandingContent (contenu éditable de la landing page)
model LandingContent {
  id          String   @id @default(uuid()) @db.Uuid
  section     String   @unique // ex: "hero_title", "hero_subtitle", "feature_1_title"
  contenu     String   @db.Text
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([section])
  @@map("landing_content")
}

// CmsPage (pages dynamiques créées depuis l'admin)
model CmsPage {
  id        String   @id @default(uuid()) @db.Uuid
  slug      String   @unique // ex: "tarifs", "a-propos", "faq"
  titre     String
  contenu   String   @db.Text // Markdown ou HTML
  metaTitle String?  @map("meta_title")
  metaDesc  String?  @map("meta_description") @db.Text
  publie    Boolean  @default(false)
  ordre     Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([slug])
  @@index([publie])
  @@index([ordre])
  @@map("cms_pages")
}

// ContactMessage (messages de contact)
model ContactMessage {
  id          String   @id @default(uuid()) @db.Uuid
  nom         String
  prenom      String
  email       String
  telephone   String?
  entreprise  String?
  message     String   @db.Text
  traite      Boolean  @default(false) // Marqué comme traité
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([traite])
  @@index([createdAt])
  @@map("contact_messages")
}

// AgentCalendarEvent (agenda géré par l'agent IA, par tenant)
model AgentCalendarEvent {
  id          String    @id @default(uuid()) @db.Uuid
  tenantId    String    @map("tenant_id") @db.Uuid
  titre       String    @map("titre")
  description String?   @map("description") @db.Text
  debut       DateTime  @map("debut") @db.Timestamptz(6)
  fin         DateTime  @map("fin") @db.Timestamptz(6)
  rappelMin   Int?      @map("rappel_min") // Rappel X minutes avant (optionnel)
  lieu        String?   @map("lieu") @db.Text
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([debut])
  @@index([tenantId, debut])
  @@map("agent_calendar_events")
}

// Configuration de l'agent IA par tenant (emails, Qonto) - stockée en base pour réglage depuis Paramètres
model TenantAgentConfig {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @unique @map("tenant_id") @db.Uuid
  config    Json     @map("config") // { email?: { imapHost, imapPort, imapUser, imapPassword, smtpHost, ... }, qonto?: { apiSecret, bankAccountId } }
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_agent_configs")
}

// ============================================
// AGENT TÉLÉPHONIQUE IA (Twilio)
// ============================================

// Configuration Twilio par tenant (compte central, numéro attribué)
model TwilioConfig {
  id                String   @id @default(uuid()) @db.Uuid
  tenantId          String   @unique @map("tenant_id") @db.Uuid
  phoneNumber       String?  @map("phone_number") // Numéro Twilio attribué (+33...)
  accountSid        String?  @map("account_sid") // Twilio Account SID
  authToken         String?  @map("auth_token") // Twilio Auth Token
  agentName         String   @default("Sophie") @map("agent_name")
  companyName       String?  @map("company_name") // Nom affiché par l'agent
  niche             String   @default("plomberie") // Clé vers niches-config
  businessHours     String?  @map("business_hours") @db.Text
  systemPromptAddon String?  @map("system_prompt_addon") @db.Text
  knowledgeBase     String?  @map("knowledge_base") @db.Text
  dispatchDelay     Int      @default(30) @map("dispatch_delay") // Minutes
  basePrice         String?  @map("base_price") // Prix indicatif en toutes lettres
  humanContact      String?  @map("human_contact") // Contact humain backup
  active            Boolean  @default(false) // Agent activé ou non
  webhookUrl        String?  @map("webhook_url") // URL webhook N8N spécifique
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([active])
  @@map("twilio_configs")
}

// Journal des appels téléphoniques
model CallLog {
  id               String          @id @default(uuid()) @db.Uuid
  tenantId         String          @map("tenant_id") @db.Uuid
  callSid          String?         @unique @map("call_sid") // SID Twilio
  direction        CallDirection   @default(entrant)
  callerPhone      String?         @map("caller_phone")
  calledNumber     String?         @map("called_number")
  duration         Int             @default(0) // Durée en secondes
  status           String          @default("initiated") // initiated, ringing, in-progress, completed, failed, no-answer
  conversationLog  Json?           @default("[]") @map("conversation_log") // Historique conversation
  transcript       String?         @db.Text // Transcription complète
  callerName       String?         @map("caller_name")
  callerEmail      String?         @map("caller_email")
  callerAddress    String?         @map("caller_address") @db.Text
  urgencyLevel     UrgencyLevel    @default(STANDARD) @map("urgency_level")
  actionTaken      CallActionTaken? @map("action_taken")
  sentiment        CallSentiment   @default(NEUTRE)
  leadId           String?         @map("lead_id") @db.Uuid
  appointmentDate  DateTime?       @map("appointment_date") @db.Timestamptz(6)
  niche            String?
  notes            String?         @db.Text
  followUpRequired Boolean         @default(false) @map("follow_up_required")
  followUpDone     Boolean         @default(false) @map("follow_up_done")
  smsSent          Boolean         @default(false) @map("sms_sent")
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lead    Lead?   @relation(fields: [leadId], references: [id], onDelete: SetNull)
  smsLogs SmsLog[]

  @@index([tenantId])
  @@index([callerPhone])
  @@index([createdAt(sort: Desc)])
  @@index([status])
  @@index([urgencyLevel])
  @@index([tenantId, createdAt(sort: Desc)])
  @@index([followUpRequired])
  @@map("call_logs")
}

// Journal des SMS
model SmsLog {
  id          String        @id @default(uuid()) @db.Uuid
  tenantId    String        @map("tenant_id") @db.Uuid
  callLogId   String?       @map("call_log_id") @db.Uuid // Lié à un appel (optionnel)
  direction   CallDirection @default(sortant)
  fromNumber  String        @map("from_number")
  toNumber    String        @map("to_number")
  body        String        @db.Text
  status      String        @default("sent") // sent, delivered, failed
  twilioSid   String?       @unique @map("twilio_sid")
  createdAt   DateTime      @default(now()) @map("created_at")

  // Relations
  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  callLog CallLog? @relation(fields: [callLogId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([tenantId, createdAt(sort: Desc)])
  @@index([callLogId])
  @@map("sms_logs")
}

// Questionnaires leads (téléphone, SMS, ou web)
model Questionnaire {
  id          String               @id @default(uuid()) @db.Uuid
  tenantId    String               @map("tenant_id") @db.Uuid
  leadId      String               @map("lead_id") @db.Uuid
  questions   Json                 @default("[]") // [{question: string, answer: string|null, order: number}]
  status      QuestionnaireStatus  @default(en_cours)
  channel     QuestionnaireChannel @default(telephone)
  completedAt DateTime?            @map("completed_at") @db.Timestamptz(6)
  createdAt   DateTime             @default(now()) @map("created_at")
  updatedAt   DateTime             @updatedAt @map("updated_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([leadId])
  @@index([status])
  @@index([tenantId, createdAt(sort: Desc)])
  @@map("questionnaires")
}

// ============================================
// COMPTABILITE - MODELS
// ============================================

// Exercice Comptable (année fiscale)
model ExerciceComptable {
  id            String   @id @default(uuid()) @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  code          String   @map("code") // ex: "2025", "2024-2025"
  dateDebut     DateTime @map("date_debut") @db.Date
  dateFin       DateTime @map("date_fin") @db.Date
  cloture       Boolean  @default(false) @map("cloture")
  dateCloture   DateTime? @map("date_cloture") @db.Timestamptz(6)
  resultatNet   Decimal? @map("resultat_net") @db.Decimal(15, 2)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  tenant    Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  ecritures EcritureComptable[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([cloture])
  @@map("exercices_comptables")
}

// Plan Comptable (chart of accounts)
model PlanComptable {
  id             String       @id @default(uuid()) @db.Uuid
  tenantId       String       @map("tenant_id") @db.Uuid
  numeroCompte   String       @map("numero_compte") // ex: "411000"
  libelle        String       @map("libelle")
  classe         Int          @map("classe") // 1-7
  nature         CompteNature @map("nature")
  type           CompteType   @default(general) @map("type")
  compteParentId String?      @map("compte_parent_id")
  actif          Boolean      @default(true) @map("actif")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, numeroCompte])
  @@index([tenantId])
  @@index([classe])
  @@index([actif])
  @@map("plan_comptable")
}

// Journal Comptable (accounting journal)
model JournalComptable {
  id        String      @id @default(uuid()) @db.Uuid
  tenantId  String      @map("tenant_id") @db.Uuid
  code      String      @map("code") // ex: "VE", "AC", "BQ"
  libelle   String      @map("libelle")
  type      JournalType @map("type")
  actif     Boolean     @default(true) @map("actif")
  createdAt DateTime    @default(now()) @map("created_at")

  tenant    Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  ecritures EcritureComptable[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@map("journaux_comptables")
}

// Écriture Comptable (journal entry header)
model EcritureComptable {
  id              String          @id @default(uuid()) @db.Uuid
  tenantId        String          @map("tenant_id") @db.Uuid
  exerciceId      String          @map("exercice_id") @db.Uuid
  journalCode     String          @map("journal_code")
  numeroPiece     String          @map("numero_piece")
  dateEcriture    DateTime        @map("date_ecriture") @db.Date
  libelle         String          @map("libelle")
  referenceDoc    String?         @map("reference_doc") // ex: "FAC-2025-000012"
  statut          EcritureStatut  @default(brouillon) @map("statut")
  sourceAuto      String?         @map("source_auto") // ex: "facture", "avoir", "paiement"
  sourceId        String?         @map("source_id") @db.Uuid
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  tenant   Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  exercice ExerciceComptable  @relation(fields: [exerciceId], references: [id], onDelete: Cascade)
  journal  JournalComptable   @relation(fields: [tenantId, journalCode], references: [tenantId, code])
  lignes   LigneEcriture[]

  @@unique([tenantId, numeroPiece])
  @@index([tenantId])
  @@index([exerciceId])
  @@index([journalCode])
  @@index([dateEcriture])
  @@index([statut])
  @@index([sourceAuto, sourceId])
  @@map("ecritures_comptables")
}

// Ligne d'écriture (journal entry line)
model LigneEcriture {
  id            String    @id @default(uuid()) @db.Uuid
  ecritureId    String    @map("ecriture_id") @db.Uuid
  numeroCompte  String    @map("numero_compte") // ex: "411000"
  libelleLigne  String    @map("libelle_ligne")
  debit         Decimal   @default(0) @map("debit") @db.Decimal(15, 2)
  credit        Decimal   @default(0) @map("credit") @db.Decimal(15, 2)
  lettrage      String?   @map("lettrage") // Code de lettrage (ex: "AAA")
  dateLettrage  DateTime? @map("date_lettrage") @db.Date
  ordre         Int       @default(0) @map("ordre")

  ecriture EcritureComptable @relation(fields: [ecritureId], references: [id], onDelete: Cascade)

  @@index([ecritureId])
  @@index([numeroCompte])
  @@index([lettrage])
  @@map("lignes_ecritures")
}

// Lettrage (account reconciliation tracking)
model Lettrage {
  id             String   @id @default(uuid()) @db.Uuid
  tenantId       String   @map("tenant_id") @db.Uuid
  codeLettrage   String   @map("code_lettrage")
  numeroCompte   String   @map("numero_compte")
  dateLettrage   DateTime @map("date_lettrage") @db.Date
  montant        Decimal  @map("montant") @db.Decimal(15, 2)
  ecart          Decimal  @default(0) @map("ecart") @db.Decimal(15, 2)
  createdAt      DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, codeLettrage])
  @@index([tenantId])
  @@index([numeroCompte])
  @@map("lettrages")
}

// Rapprochement Bancaire (bank reconciliation)
model RapprochementBancaire {
  id              String              @id @default(uuid()) @db.Uuid
  tenantId        String              @map("tenant_id") @db.Uuid
  dateDebut       DateTime            @map("date_debut") @db.Date
  dateFin         DateTime            @map("date_fin") @db.Date
  soldeDebutBanque  Decimal           @map("solde_debut_banque") @db.Decimal(15, 2)
  soldeFinBanque    Decimal           @map("solde_fin_banque") @db.Decimal(15, 2)
  soldeDebutCompta  Decimal           @map("solde_debut_compta") @db.Decimal(15, 2)
  soldeFinCompta    Decimal           @map("solde_fin_compta") @db.Decimal(15, 2)
  ecart             Decimal           @default(0) @map("ecart") @db.Decimal(15, 2)
  statut            RapprochementStatut @default(en_cours) @map("statut")
  createdAt         DateTime          @default(now()) @map("created_at")

  tenant Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lignes LigneRapprochement[]

  @@index([tenantId])
  @@index([dateFin])
  @@map("rapprochements_bancaires")
}

// Ligne de rapprochement bancaire
model LigneRapprochement {
  id                  String   @id @default(uuid()) @db.Uuid
  rapprochementId     String   @map("rapprochement_id") @db.Uuid
  ecritureId          String?  @map("ecriture_id") @db.Uuid
  dateOperation       DateTime @map("date_operation") @db.Date
  libelle             String   @map("libelle")
  montant             Decimal  @map("montant") @db.Decimal(15, 2)
  rapproche           Boolean  @default(false) @map("rapproche")

  rapprochement RapprochementBancaire @relation(fields: [rapprochementId], references: [id], onDelete: Cascade)

  @@index([rapprochementId])
  @@index([rapproche])
  @@map("lignes_rapprochement")
}

// Déclaration TVA (VAT declaration)
model DeclarationTva {
  id               String                @id @default(uuid()) @db.Uuid
  tenantId         String                @map("tenant_id") @db.Uuid
  dateDebut        DateTime              @map("date_debut") @db.Date
  dateFin          DateTime              @map("date_fin") @db.Date
  typeDeclaration  String                @default("mensuelle") @map("type_declaration") // mensuelle, trimestrielle
  baseHtVentes     Decimal               @default(0) @map("base_ht_ventes") @db.Decimal(15, 2)
  baseHtAchats     Decimal               @default(0) @map("base_ht_achats") @db.Decimal(15, 2)
  tvaCollectee     Decimal               @default(0) @map("tva_collectee") @db.Decimal(15, 2)
  tvaDeductible    Decimal               @default(0) @map("tva_deductible") @db.Decimal(15, 2)
  tvaDue           Decimal               @default(0) @map("tva_due") @db.Decimal(15, 2)
  creditTva        Decimal               @default(0) @map("credit_tva") @db.Decimal(15, 2)
  statut           DeclarationTvaStatut  @default(brouillon) @map("statut")
  createdAt        DateTime              @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([dateFin])
  @@index([statut])
  @@map("declarations_tva")
}

// Immobilisations (fixed assets)
model Immobilisation {
  id                  String                @id @default(uuid()) @db.Uuid
  tenantId            String                @map("tenant_id") @db.Uuid
  designation         String                @map("designation")
  numeroCompte        String                @map("numero_compte") // ex: "2154"
  dateAcquisition     DateTime              @map("date_acquisition") @db.Date
  valeurAcquisition   Decimal               @map("valeur_acquisition") @db.Decimal(15, 2)
  dureeAmortissement  Int                   @map("duree_amortissement") // en mois
  methodeAmort        String                @default("lineaire") @map("methode_amort") // lineaire, degressif
  valeurResiduelle    Decimal               @default(0) @map("valeur_residuelle") @db.Decimal(15, 2)
  totalAmorti         Decimal               @default(0) @map("total_amorti") @db.Decimal(15, 2)
  vnc                 Decimal               @default(0) @map("vnc") @db.Decimal(15, 2) // Valeur Nette Comptable
  statut              ImmobilisationStatut  @default(actif) @map("statut")
  dateCession         DateTime?             @map("date_cession") @db.Date
  createdAt           DateTime              @default(now()) @map("created_at")
  updatedAt           DateTime              @updatedAt @map("updated_at")

  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  amortissements Amortissement[]

  @@index([tenantId])
  @@index([statut])
  @@map("immobilisations")
}

// Amortissements (depreciation schedule)
model Amortissement {
  id                String   @id @default(uuid()) @db.Uuid
  immobilisationId  String   @map("immobilisation_id") @db.Uuid
  dateAmortissement DateTime @map("date_amortissement") @db.Date
  montant           Decimal  @map("montant") @db.Decimal(15, 2)
  cumulAmorti       Decimal  @map("cumul_amorti") @db.Decimal(15, 2)
  vncApres          Decimal  @map("vnc_apres") @db.Decimal(15, 2)
  ecritureId        String?  @map("ecriture_id") @db.Uuid // Lien vers l'écriture générée
  createdAt         DateTime @default(now()) @map("created_at")

  immobilisation Immobilisation @relation(fields: [immobilisationId], references: [id], onDelete: Cascade)

  @@index([immobilisationId])
  @@index([dateAmortissement])
  @@map("amortissements")
}

// Balance des comptes (snapshot/cache)
model BalanceCompte {
  id            String   @id @default(uuid()) @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  exerciceId    String   @map("exercice_id") @db.Uuid
  numeroCompte  String   @map("numero_compte")
  libelle       String   @map("libelle")
  totalDebit    Decimal  @default(0) @map("total_debit") @db.Decimal(15, 2)
  totalCredit   Decimal  @default(0) @map("total_credit") @db.Decimal(15, 2)
  solde         Decimal  @default(0) @map("solde") @db.Decimal(15, 2)
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, exerciceId, numeroCompte])
  @@index([tenantId])
  @@index([exerciceId])
  @@map("balance_comptes")
}

// Logs IA Comptable (audit trail)
model ComptaIaLog {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  action    String   @map("action") // classifier, analyser, suggestion, rapport, question
  prompt    String   @map("prompt") @db.Text
  reponse   String   @map("reponse") @db.Text
  modele    String   @map("modele") // ex: "gpt-4o"
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([action])
  @@index([createdAt])
  @@map("compta_ia_logs")
}

// ═══════════════════════════════════════════════════════════════
// GESTION D'ÉQUIPE
// ═══════════════════════════════════════════════════════════════

enum EquipeContratType {
  cdi
  cdd
  interim
  stage
  alternance
  freelance
}

enum AbsenceType {
  conge_paye
  rtt
  maladie
  sans_solde
  maternite
  paternite
  formation
  autre
}

enum AbsenceStatut {
  en_attente
  approuvee
  refusee
}

model EquipeMember {
  id            String            @id @default(uuid()) @db.Uuid
  tenantId      String            @map("tenant_id") @db.Uuid
  userId        String?           @map("user_id") @db.Uuid
  nom           String
  prenom        String
  email         String
  telephone     String?
  poste         String?
  departement   String?
  contratType   EquipeContratType @default(cdi) @map("contrat_type")
  dateEmbauche  DateTime?         @map("date_embauche") @db.Date
  dateFinContrat DateTime?        @map("date_fin_contrat") @db.Date
  salaireBase   Decimal?          @map("salaire_base") @db.Decimal(10, 2)
  manager       String?           @map("manager") @db.Uuid
  actif         Boolean           @default(true)
  notes         String?           @db.Text
  createdAt     DateTime          @default(now()) @map("created_at")
  updatedAt     DateTime          @updatedAt @map("updated_at")

  tenant    Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  absences  EquipeAbsence[]
  pointages EquipePointage[]
  // Relations RH
  rhContrats      RhContrat[]
  rhBulletinsPaie RhBulletinPaie[]
  rhConges        RhConge[]
  rhDocuments     RhDocument[]
  rhEntretiens    RhEntretien[]
  rhInscriptions  RhInscriptionFormation[]
  rhEvaluations   RhEvaluation[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([departement])
  @@index([actif])
  @@map("equipe_members")
}

model EquipeAbsence {
  id          String        @id @default(uuid()) @db.Uuid
  tenantId    String        @map("tenant_id") @db.Uuid
  memberId    String        @map("member_id") @db.Uuid
  type        AbsenceType   @default(conge_paye)
  dateDebut   DateTime      @map("date_debut") @db.Date
  dateFin     DateTime      @map("date_fin") @db.Date
  motif       String?       @db.Text
  statut      AbsenceStatut @default(en_attente)
  validePar   String?       @map("valide_par") @db.Uuid
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  tenant  Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  member  EquipeMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([memberId])
  @@index([statut])
  @@index([dateDebut])
  @@map("equipe_absences")
}

model EquipePointage {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  memberId    String   @map("member_id") @db.Uuid
  date        DateTime @db.Date
  heureArrivee String? @map("heure_arrivee")
  heureDepart  String? @map("heure_depart")
  heuresPause  Decimal @default(0) @map("heures_pause") @db.Decimal(4, 2)
  heuresTravaillees Decimal? @map("heures_travaillees") @db.Decimal(5, 2)
  notes       String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  tenant  Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  member  EquipeMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([tenantId, memberId, date])
  @@index([tenantId])
  @@index([memberId])
  @@index([date])
  @@map("equipe_pointages")
}

// ═══════════════════════════════════════════════════════════════
// GESTION DE PROJET
// ═══════════════════════════════════════════════════════════════

enum ProjetStatut {
  brouillon
  en_cours
  en_pause
  termine
  annule
}

enum TachePriorite {
  basse
  normale
  haute
  urgente
}

enum TacheStatut {
  a_faire
  en_cours
  en_revue
  terminee
}

model Projet {
  id            String       @id @default(uuid()) @db.Uuid
  tenantId      String       @map("tenant_id") @db.Uuid
  nom           String
  description   String?      @db.Text
  clientId      String?      @map("client_id") @db.Uuid
  responsableId String?      @map("responsable_id") @db.Uuid
  statut        ProjetStatut @default(brouillon)
  dateDebut     DateTime?    @map("date_debut") @db.Date
  dateFin       DateTime?    @map("date_fin") @db.Date
  budgetPrevu   Decimal?     @map("budget_prevu") @db.Decimal(12, 2)
  budgetConsomme Decimal?    @map("budget_consomme") @db.Decimal(12, 2)
  progression   Int          @default(0)
  couleur       String?
  tags          String[]     @default([])
  notes         String?      @db.Text
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  tenant      Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client      ClientFinal?  @relation(fields: [clientId], references: [id], onDelete: SetNull)
  taches      ProjetTache[]

  @@index([tenantId])
  @@index([statut])
  @@index([clientId])
  @@map("projets")
}

model ProjetTache {
  id            String        @id @default(uuid()) @db.Uuid
  tenantId      String        @map("tenant_id") @db.Uuid
  projetId      String        @map("projet_id") @db.Uuid
  titre         String
  description   String?       @db.Text
  assigneA      String?       @map("assigne_a") @db.Uuid
  priorite      TachePriorite @default(normale)
  statut        TacheStatut   @default(a_faire)
  dateEcheance  DateTime?     @map("date_echeance") @db.Date
  heuresEstimees Decimal?     @map("heures_estimees") @db.Decimal(6, 2)
  heuresReelles  Decimal?     @map("heures_reelles") @db.Decimal(6, 2)
  ordre         Int           @default(0)
  parentId      String?       @map("parent_id") @db.Uuid
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  tenant  Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  projet  Projet      @relation(fields: [projetId], references: [id], onDelete: Cascade)
  parent  ProjetTache? @relation("SousTaches", fields: [parentId], references: [id])
  sousTaches ProjetTache[] @relation("SousTaches")

  @@index([tenantId])
  @@index([projetId])
  @@index([statut])
  @@index([assigneA])
  @@map("projet_taches")
}

// ═══════════════════════════════════════════════════════════════
// BTP (Bâtiment & Travaux Publics)
// ═══════════════════════════════════════════════════════════════

enum ChantierStatut {
  planifie
  en_preparation
  en_cours
  suspendu
  termine
  cloture
}

enum SituationType {
  situation_travaux
  dg_demarrage
  retenue_garantie
  avenant
}

model BtpChantier {
  id              String         @id @default(uuid()) @db.Uuid
  tenantId        String         @map("tenant_id") @db.Uuid
  reference       String
  nom             String
  description     String?        @db.Text
  clientId        String?        @map("client_id") @db.Uuid
  adresseChantier String?        @map("adresse_chantier") @db.Text
  codePostal      String?        @map("code_postal")
  ville           String?
  responsableId   String?        @map("responsable_id") @db.Uuid
  statut          ChantierStatut @default(planifie)
  dateDebut       DateTime?      @map("date_debut") @db.Date
  dateFinPrevue   DateTime?      @map("date_fin_prevue") @db.Date
  dateFinReelle   DateTime?      @map("date_fin_reelle") @db.Date
  montantMarche   Decimal?       @map("montant_marche") @db.Decimal(12, 2)
  montantFacture  Decimal?       @map("montant_facture") @db.Decimal(12, 2)
  tauxAvancement  Int            @default(0) @map("taux_avancement")
  lotPrincipal    String?        @map("lot_principal")
  notes           String?        @db.Text
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  tenant     Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client     ClientFinal?    @relation(fields: [clientId], references: [id], onDelete: SetNull)
  situations BtpSituation[]

  @@unique([tenantId, reference])
  @@index([tenantId])
  @@index([statut])
  @@index([clientId])
  @@map("btp_chantiers")
}

model BtpSituation {
  id            String        @id @default(uuid()) @db.Uuid
  tenantId      String        @map("tenant_id") @db.Uuid
  chantierId    String        @map("chantier_id") @db.Uuid
  numero        Int
  type          SituationType @default(situation_travaux)
  dateDebut     DateTime      @map("date_debut") @db.Date
  dateFin       DateTime      @map("date_fin") @db.Date
  montantHt     Decimal       @map("montant_ht") @db.Decimal(12, 2)
  montantTva    Decimal       @default(0) @map("montant_tva") @db.Decimal(12, 2)
  montantTtc    Decimal       @map("montant_ttc") @db.Decimal(12, 2)
  tauxAvancement Int          @default(0) @map("taux_avancement")
  cumulAnterieur Decimal      @default(0) @map("cumul_anterieur") @db.Decimal(12, 2)
  retenue       Decimal       @default(0) @map("retenue") @db.Decimal(12, 2)
  observations  String?       @db.Text
  valide        Boolean       @default(false)
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  tenant   Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  chantier BtpChantier @relation(fields: [chantierId], references: [id], onDelete: Cascade)

  @@unique([chantierId, numero])
  @@index([tenantId])
  @@index([chantierId])
  @@map("btp_situations")
}

// ═══════════════════════════════════════════════════════════════
// RESSOURCES HUMAINES (RH)
// ═══════════════════════════════════════════════════════════════

enum RhContratType {
  cdi
  cdd
  interim
  stage
  alternance
  freelance
}

enum RhContratStatut {
  actif
  termine
  suspendu
  rompu
}

enum RhCongeType {
  cp
  rtt
  maladie
  sans_solde
  maternite
  paternite
  formation
  autre
}

enum RhCongeStatut {
  en_attente
  approuve
  rejete
}

enum RhDocumentType {
  contrat
  avenant
  attestation
  certificat
  fiche_poste
  reglement_interieur
  autre
}

enum RhEntretienType {
  annuel
  professionnel
  recadrage
  fin_periode_essai
}

enum RhEntretienStatut {
  planifie
  realise
  annule
}

enum RhFormationStatut {
  planifiee
  en_cours
  terminee
  annulee
}

enum RhBulletinStatut {
  brouillon
  valide
  paye
}

enum RhEvaluationStatut {
  brouillon
  soumise
  validee
}

enum RhEvaluationPeriode {
  T1
  T2
  T3
  T4
  annuel
}

// --- Contrats de travail ---

model RhContrat {
  id            String          @id @default(uuid()) @db.Uuid
  tenantId      String          @map("tenant_id") @db.Uuid
  memberId      String          @map("member_id") @db.Uuid
  type          RhContratType   @default(cdi)
  statut        RhContratStatut @default(actif)
  dateDebut     DateTime        @map("date_debut") @db.Date
  dateFin       DateTime?       @map("date_fin") @db.Date
  salaireBase   Decimal         @map("salaire_base") @db.Decimal(10, 2)
  poste         String
  departement   String?
  avantages     String?         @db.Text
  clauseParticuliere String?    @map("clause_particuliere") @db.Text
  motifFin      String?         @map("motif_fin") @db.Text
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  tenant  Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  member  EquipeMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([memberId])
  @@index([statut])
  @@index([type])
  @@map("rh_contrats")
}

// --- Bulletins de paie ---

model RhBulletinPaie {
  id            String           @id @default(uuid()) @db.Uuid
  tenantId      String           @map("tenant_id") @db.Uuid
  memberId      String           @map("member_id") @db.Uuid
  mois          Int
  annee         Int              @map("annee")
  salaireBase   Decimal          @map("salaire_base") @db.Decimal(10, 2)
  primes        Decimal          @default(0) @db.Decimal(10, 2)
  deductions    Decimal          @default(0) @db.Decimal(10, 2)
  chargesPatronales Decimal      @default(0) @map("charges_patronales") @db.Decimal(10, 2)
  chargesSalariales Decimal      @default(0) @map("charges_salariales") @db.Decimal(10, 2)
  netAPayer     Decimal          @map("net_a_payer") @db.Decimal(10, 2)
  netImposable  Decimal?         @map("net_imposable") @db.Decimal(10, 2)
  statut        RhBulletinStatut @default(brouillon)
  commentaire   String?          @db.Text
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")

  tenant  Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  member  EquipeMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([tenantId, memberId, mois, annee])
  @@index([tenantId])
  @@index([memberId])
  @@index([annee, mois])
  @@map("rh_bulletins_paie")
}

// --- Congés ---

model RhConge {
  id          String        @id @default(uuid()) @db.Uuid
  tenantId    String        @map("tenant_id") @db.Uuid
  memberId    String        @map("member_id") @db.Uuid
  type        RhCongeType   @default(cp)
  dateDebut   DateTime      @map("date_debut") @db.Date
  dateFin     DateTime      @map("date_fin") @db.Date
  joursPris   Decimal?      @map("jours_pris") @db.Decimal(4, 1)
  motif       String?       @db.Text
  statut      RhCongeStatut @default(en_attente)
  approuvePar String?       @map("approuve_par") @db.Uuid
  dateReponse DateTime?     @map("date_reponse")
  commentaire String?       @db.Text
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  tenant  Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  member  EquipeMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([memberId])
  @@index([statut])
  @@index([dateDebut])
  @@map("rh_conges")
}

// --- Documents RH ---

model RhDocument {
  id          String         @id @default(uuid()) @db.Uuid
  tenantId    String         @map("tenant_id") @db.Uuid
  memberId    String         @map("member_id") @db.Uuid
  type        RhDocumentType @default(autre)
  titre       String
  description String?        @db.Text
  fichierUrl  String?        @map("fichier_url")
  tailleFichier Int?         @map("taille_fichier")
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  tenant  Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  member  EquipeMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([memberId])
  @@index([type])
  @@map("rh_documents")
}

// --- Entretiens ---

model RhEntretien {
  id            String             @id @default(uuid()) @db.Uuid
  tenantId      String             @map("tenant_id") @db.Uuid
  memberId      String             @map("member_id") @db.Uuid
  type          RhEntretienType    @default(annuel)
  dateEntretien DateTime           @map("date_entretien") @db.Date
  evaluateur    String
  compteRendu   String?            @map("compte_rendu") @db.Text
  objectifs     String?            @db.Text
  pointsForts   String?            @map("points_forts") @db.Text
  axesAmelioration String?         @map("axes_amelioration") @db.Text
  statut        RhEntretienStatut  @default(planifie)
  createdAt     DateTime           @default(now()) @map("created_at")
  updatedAt     DateTime           @updatedAt @map("updated_at")

  tenant  Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  member  EquipeMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([memberId])
  @@index([type])
  @@index([dateEntretien])
  @@map("rh_entretiens")
}

// --- Formations ---

model RhFormation {
  id              String             @id @default(uuid()) @db.Uuid
  tenantId        String             @map("tenant_id") @db.Uuid
  titre           String
  description     String?            @db.Text
  formateur       String
  organisme       String?
  dateDebut       DateTime           @map("date_debut") @db.Date
  dateFin         DateTime           @map("date_fin") @db.Date
  cout            Decimal            @default(0) @db.Decimal(10, 2)
  maxParticipants Int                @default(20) @map("max_participants")
  lieu            String?
  statut          RhFormationStatut  @default(planifiee)
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")

  tenant        Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  inscriptions  RhInscriptionFormation[]

  @@index([tenantId])
  @@index([statut])
  @@index([dateDebut])
  @@map("rh_formations")
}

model RhInscriptionFormation {
  id           String   @id @default(uuid()) @db.Uuid
  tenantId     String   @map("tenant_id") @db.Uuid
  formationId  String   @map("formation_id") @db.Uuid
  memberId     String   @map("member_id") @db.Uuid
  dateInscription DateTime @default(now()) @map("date_inscription")
  presence     Boolean  @default(false)
  noteFormation Decimal? @map("note_formation") @db.Decimal(4, 2)
  commentaire  String?  @db.Text

  tenant    Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  formation RhFormation   @relation(fields: [formationId], references: [id], onDelete: Cascade)
  member    EquipeMember  @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([formationId, memberId])
  @@index([tenantId])
  @@index([formationId])
  @@index([memberId])
  @@map("rh_inscriptions_formations")
}

// --- Évaluations ---

model RhEvaluation {
  id               String               @id @default(uuid()) @db.Uuid
  tenantId         String               @map("tenant_id") @db.Uuid
  memberId         String               @map("member_id") @db.Uuid
  evaluateurId     String               @map("evaluateur_id") @db.Uuid
  periode          RhEvaluationPeriode  @default(annuel)
  annee            Int
  noteGlobale      Decimal              @map("note_globale") @db.Decimal(4, 2)
  commentaires     String?              @db.Text
  objectifsAtteints String?             @map("objectifs_atteints") @db.Text
  objectifsFuturs  String?              @map("objectifs_futurs") @db.Text
  competences      String?              @db.Text
  statut           RhEvaluationStatut   @default(brouillon)
  createdAt        DateTime             @default(now()) @map("created_at")
  updatedAt        DateTime             @updatedAt @map("updated_at")

  tenant  Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  member  EquipeMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([tenantId, memberId, periode, annee])
  @@index([tenantId])
  @@index([memberId])
  @@index([evaluateurId])
  @@index([annee])
  @@map("rh_evaluations")
}

// --- Base de Connaissances Agent Téléphonique ---

enum AgentKnowledgeCategory {
  faq
  info_entreprise
  services
  tarifs
  politiques
  actions
  autre
}

model AgentKnowledgeEntry {
  id        String                 @id @default(uuid()) @db.Uuid
  tenantId  String                 @map("tenant_id") @db.Uuid
  categorie AgentKnowledgeCategory @default(faq)
  titre     String
  contenu   String                 @db.Text
  motsCles  String?                @map("mots_cles")
  actif     Boolean                @default(true)
  ordre     Int                    @default(0)
  createdAt DateTime               @default(now()) @map("created_at")
  updatedAt DateTime               @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, titre])
  @@index([tenantId])
  @@index([categorie])
  @@map("agent_knowledge_entries")
}

