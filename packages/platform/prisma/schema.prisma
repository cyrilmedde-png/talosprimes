// Prisma Schema pour TalosPrimes
// Base de données: Supabase PostgreSQL

generator client {
  provider = "prisma-client-js"
}

// Configuration du seed
// npm install -D tsx
// pnpm db:seed

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum TenantStatus {
  actif
  suspendu
  resilie
}

enum UserRole {
  super_admin
  admin
  collaborateur
  lecture_seule
}

enum UserStatus {
  actif
  inactif
}

enum ClientFinalType {
  b2b
  b2c
}

enum ClientFinalStatus {
  actif
  inactif
  suspendu
}

enum SubscriptionStatus {
  actif
  annule
  en_retard
  suspendu
}

enum PaymentStatus {
  ok
  en_retard
  suspendu
}

enum PaymentProvider {
  stripe
  autre
}

enum InvoiceType {
  facture_entreprise
  facture_client_final
}

enum InvoiceStatus {
  brouillon
  envoyee
  payee
  en_retard
  annulee
}

enum WorkflowStatus {
  actif
  inactif
}

enum EventExecutionStatus {
  succes
  erreur
  en_attente
}

enum LeadStatus {
  nouveau
  contacte
  converti
  abandonne
}

enum StatutJuridique {
  SA
  SARL
  SAS
  SASU
  SCI
  SNC
  SCS
  SCA
  EURL
  SCP
  SEL
  SELARL
  SELAS
  SELAFA
  AUTO_ENTREPRENEUR
  EIRL
  ENTREPRISE_INDIVIDUELLE
}

// ============================================
// MODELS
// ============================================

// Entreprise (Tenant) - Client direct de la plateforme
model Tenant {
  id              String          @id @default(uuid()) @db.Uuid
  nomEntreprise   String          @map("nom_entreprise")
  siret           String?         @map("siret")
  siren           String?         @map("siren")
  codeAPE         String?         @map("code_ape")
  codeNAF         String?         @map("code_naf")
  statutJuridique StatutJuridique? @map("statut_juridique")
  adressePostale  String?         @map("adresse_postale") @db.Text
  codePostal      String?         @map("code_postal")
  ville           String?         @map("ville")
  pays            String          @default("FR")
  telephone       String?         @map("telephone")
  emailContact    String          @map("email_contact")
  tvaIntracom     String?         @map("tva_intracom")
  rib             String?         @map("rib") @db.Text
  devise          String          @default("EUR")
  langue          String          @default("fr")
  metier          String          @map("metier")
  statut          TenantStatus    @default(actif)
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  // Relations
  users              User[]
  subscription       Subscription?
  clients            ClientFinal[]
  invoices           Invoice[]
  workflowLinks      WorkflowLink[]
  eventLogs          EventLog[]
  notifications      Notification[]
  agentCalendarEvents AgentCalendarEvent[]
  agentConfig        TenantAgentConfig?

  @@index([emailContact])
  @@index([statut])
  @@map("tenants")
}

// Utilisateur (attaché à une entreprise)
model User {
  id                String      @id @default(uuid()) @db.Uuid
  tenantId          String      @map("tenant_id") @db.Uuid
  email             String
  passwordHash      String      @map("password_hash")
  mustChangePassword Boolean    @default(false) @map("must_change_password")
  role              UserRole    @default(collaborateur)
  nom               String?     @map("nom")
  prenom            String?     @map("prenom")
  telephone         String?     @map("telephone")
  fonction          String?     @map("fonction")
  salaire           Decimal?    @map("salaire") @db.Decimal(10, 2)
  dateEmbauche      DateTime?   @map("date_embauche") @db.Timestamptz(6)
  lastLoginAt       DateTime?   @map("last_login_at") @db.Timestamptz(6)
  statut            UserStatus  @default(actif)
  createdAt         DateTime    @default(now()) @map("created_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, email])
  @@index([email])
  @@index([tenantId])
  @@index([fonction])
  @@map("users")
}

// Client Final (client de l'entreprise cliente)
model ClientFinal {
  id             String            @id @default(uuid()) @db.Uuid
  tenantId       String            @map("tenant_id") @db.Uuid
  type           ClientFinalType
  raisonSociale  String?           @map("raison_sociale")
  nom            String?           @map("nom")
  prenom         String?           @map("prenom")
  email          String
  telephone      String?           @map("telephone")
  adresse        String?           @map("adresse") @db.Text
  tags           String[]          @default([]) @db.Text
  statut         ClientFinalStatus @default(actif)
  createdAt      DateTime          @default(now()) @map("created_at")
  updatedAt      DateTime          @updatedAt @map("updated_at")

  // Relations
  tenant         Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  subscriptions  ClientSubscription[]
  invoices       Invoice[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
  @@map("client_finals")
}

// Module Métier (catalogue de modules)
model ModuleMetier {
  id                  String   @id @default(uuid()) @db.Uuid
  code                String   @unique
  nomAffiche          String   @map("nom_affiché")
  description         String?  @map("description") @db.Text
  metierCible         String?  @map("metier_cible")
  prixParMois         Decimal  @map("prix_par_mois") @db.Decimal(10, 2)
  prixParUtilisateur  Decimal? @map("prix_par_utilisateur") @db.Decimal(10, 2)
  categorie           String?  @map("categorie")
  icone               String?  @map("icone")
  workflowTemplates   String[] @default([]) @map("workflow_templates") @db.Text
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  workflowLinks WorkflowLink[]

  @@index([code])
  @@index([metierCible])
  @@map("module_metiers")
}

// Abonnement Entreprise (ce que l'entreprise paye)
model Subscription {
  id                       String          @id @default(uuid()) @db.Uuid
  tenantId                 String          @unique @map("tenant_id") @db.Uuid
  modulesActives           String[]        @default([]) @map("modules_actives") @db.Text
  montantMensuelActuel     Decimal         @map("montant_mensuel_actuel") @db.Decimal(10, 2)
  dateDebut                DateTime        @map("date_debut") @db.Timestamptz(6)
  dateProchainRenouvellement DateTime      @map("date_prochain_renouvellement") @db.Timestamptz(6)
  fournisseurPaiement      PaymentProvider @map("fournisseur_paiement")
  idAbonnementExterne      String?         @map("id_abonnement_externe")
  statusPaiement           PaymentStatus   @default(ok) @map("status_paiement")
  updatedAt                DateTime        @updatedAt @map("updated_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([statusPaiement])
  @@map("subscriptions")
}

// Abonnement Client Final (ce que les clients finaux payent)
model ClientSubscription {
  id                       String              @id @default(uuid()) @db.Uuid
  clientFinalId            String              @map("client_final_id") @db.Uuid
  planInterneId            String?             @map("plan_interne_id")
  nomPlan                  String              @map("nom_plan")
  dateDebut                DateTime            @map("date_debut") @db.Timestamptz(6)
  dateProchainRenouvellement DateTime          @map("date_prochain_renouvellement") @db.Timestamptz(6)
  montantMensuel           Decimal             @map("montant_mensuel") @db.Decimal(10, 2)
  modulesInclus            String[]            @default([]) @map("modules_inclus") @db.Text
  statut                   SubscriptionStatus  @default(actif)
  idAbonnementStripe       String?             @map("id_abonnement_stripe")
  idClientStripe            String?             @map("id_client_stripe")
  temporaryPassword        String?             @map("temporary_password") // Mot de passe temporaire en clair (supprimé après envoi email)
  updatedAt                DateTime            @updatedAt @map("updated_at")

  // Relations
  clientFinal ClientFinal @relation(fields: [clientFinalId], references: [id], onDelete: Cascade)

  @@index([clientFinalId])
  @@index([statut])
  @@index([dateProchainRenouvellement])
  @@map("client_subscriptions")
}

// Facture
model Invoice {
  id                String        @id @default(uuid()) @db.Uuid
  type              InvoiceType
  tenantId          String        @map("tenant_id") @db.Uuid
  clientFinalId     String?       @map("client_final_id") @db.Uuid
  numeroFacture     String        @unique @map("numero_facture")
  dateFacture       DateTime      @map("date_facture") @db.Timestamptz(6)
  dateEcheance      DateTime      @map("date_echeance") @db.Timestamptz(6)
  montantHt         Decimal       @map("montant_ht") @db.Decimal(10, 2)
  montantTtc        Decimal       @map("montant_ttc") @db.Decimal(10, 2)
  tvaTaux           Decimal?      @map("tva_taux") @db.Decimal(5, 2)
  description       String?       @map("description") @db.Text
  codeArticle       String?       @map("code_article")
  modePaiement      String?       @map("mode_paiement")
  statut            InvoiceStatus @default(brouillon)
  lienPdf           String?       @map("lien_pdf")
  idExternePaiement String?       @map("id_externe_paiement")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  // Relations
  tenant     Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientFinal ClientFinal? @relation(fields: [clientFinalId], references: [id], onDelete: SetNull)
  lines      InvoiceLine[]

  @@index([tenantId])
  @@index([clientFinalId])
  @@index([statut])
  @@index([dateEcheance])
  @@index([numeroFacture])
  @@map("invoices")
}

// Ligne de facture (detail des articles)
model InvoiceLine {
  id            String   @id @default(uuid()) @db.Uuid
  invoiceId     String   @map("invoice_id") @db.Uuid
  codeArticle   String?  @map("code_article")
  designation   String   @map("designation")
  quantite      Int      @default(1)
  prixUnitaireHt Decimal @map("prix_unitaire_ht") @db.Decimal(10, 2)
  totalHt       Decimal  @map("total_ht") @db.Decimal(10, 2)
  ordre         Int      @default(0) @map("ordre")

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_lines")
}

// Lien Workflow n8n
model WorkflowLink {
  id              String         @id @default(uuid()) @db.Uuid
  tenantId        String         @map("tenant_id") @db.Uuid
  moduleMetierId  String         @map("module_metier_id") @db.Uuid
  typeEvenement   String         @map("type_evenement")
  workflowN8nId   String         @map("workflow_n8n_id")
  workflowN8nNom  String         @map("workflow_n8n_nom")
  statut          WorkflowStatus @default(actif)
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  // Relations
  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  moduleMetier ModuleMetier @relation(fields: [moduleMetierId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([moduleMetierId])
  @@index([typeEvenement])
  @@unique([tenantId, typeEvenement])
  @@map("workflow_links")
}

// Event Log (journalisation des événements)
model EventLog {
  id                    String                @id @default(uuid()) @db.Uuid
  tenantId              String                @map("tenant_id") @db.Uuid
  typeEvenement         String                @map("type_evenement")
  entiteType            String                @map("entite_type")
  entiteId              String                @map("entite_id") @db.Uuid
  payload               Json                  @map("payload")
  workflowN8nDeclenche  Boolean               @default(false) @map("workflow_n8n_declenche")
  workflowN8nId         String?               @map("workflow_n8n_id")
  statutExecution       EventExecutionStatus  @default(en_attente) @map("statut_execution")
  messageErreur         String?               @map("message_erreur") @db.Text
  createdAt             DateTime              @default(now()) @map("created_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([typeEvenement])
  @@index([statutExecution])
  @@index([createdAt])
  @@map("event_logs")
}

// Lead (demande d'inscription)
model Lead {
  id          String     @id @default(uuid()) @db.Uuid
  nom         String
  prenom      String
  email       String
  telephone   String
  statut      LeadStatus @default(nouveau)
  source      String?    @default("formulaire_inscription")
  notes       String?    @db.Text
  dateContact DateTime?  @map("date_contact") @db.Timestamptz(6)
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  @@unique([email])
  @@index([statut])
  @@index([createdAt])
  @@map("leads")
}

// Notification (notifications dans la plateforme)
model Notification {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  type        String   // ex: "lead_inscription", "lead_questionnaire", "lead_entretien", "lead_confirmation", "client_creation"
  titre       String   @map("titre")
  message     String   @map("message") @db.Text
  donnees     Json?    @map("donnees") // Données additionnelles (leadId, clientId, etc.)
  lu          Boolean  @default(false) @map("lu")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([type])
  @@index([lu])
  @@index([createdAt])
  @@map("notifications")
}

// Testimonial (avis clients pour la landing page)
model Testimonial {
  id          String   @id @default(uuid()) @db.Uuid
  nom         String
  prenom      String
  entreprise  String?
  poste       String?  // ex: "CEO", "Directeur Commercial"
  avatar      String?  // URL ou initiales
  note        Int      @default(5) // Note sur 5
  commentaire String   @db.Text
  affiche     Boolean  @default(true) // Afficher ou masquer
  ordre       Int      @default(0) // Ordre d'affichage
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([affiche])
  @@index([ordre])
  @@map("testimonials")
}

// LandingContent (contenu éditable de la landing page)
model LandingContent {
  id          String   @id @default(uuid()) @db.Uuid
  section     String   @unique // ex: "hero_title", "hero_subtitle", "feature_1_title"
  contenu     String   @db.Text
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([section])
  @@map("landing_content")
}

// ContactMessage (messages de contact)
model ContactMessage {
  id          String   @id @default(uuid()) @db.Uuid
  nom         String
  prenom      String
  email       String
  telephone   String?
  entreprise  String?
  message     String   @db.Text
  traite      Boolean  @default(false) // Marqué comme traité
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([traite])
  @@index([createdAt])
  @@map("contact_messages")
}

// AgentCalendarEvent (agenda géré par l'agent IA, par tenant)
model AgentCalendarEvent {
  id          String    @id @default(uuid()) @db.Uuid
  tenantId    String    @map("tenant_id") @db.Uuid
  titre       String    @map("titre")
  description String?   @map("description") @db.Text
  debut       DateTime  @map("debut") @db.Timestamptz(6)
  fin         DateTime  @map("fin") @db.Timestamptz(6)
  rappelMin   Int?      @map("rappel_min") // Rappel X minutes avant (optionnel)
  lieu        String?   @map("lieu") @db.Text
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([debut])
  @@index([tenantId, debut])
  @@map("agent_calendar_events")
}

// Configuration de l'agent IA par tenant (emails, Qonto) - stockée en base pour réglage depuis Paramètres
model TenantAgentConfig {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @unique @map("tenant_id") @db.Uuid
  config    Json     @map("config") // { email?: { imapHost, imapPort, imapUser, imapPassword, smtpHost, ... }, qonto?: { apiSecret, bankAccountId } }
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_agent_configs")
}

