<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TalosPrimes ‚Äî Architecture Modules & Plans</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Segoe UI', system-ui, sans-serif; background: #0f172a; color: #e2e8f0; min-height: 100vh; padding: 40px 20px; }
  .container { max-width: 1300px; margin: 0 auto; }

  h1 { text-align: center; font-size: 2rem; margin-bottom: 6px; background: linear-gradient(135deg, #667eea, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .subtitle { text-align: center; color: #94a3b8; font-size: 0.9rem; margin-bottom: 50px; }

  /* Section */
  .section { margin-bottom: 60px; }
  .section-header { display: flex; align-items: center; gap: 14px; margin-bottom: 24px; }
  .section-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; flex-shrink: 0; }
  .section-title { font-size: 1.25rem; font-weight: 700; }
  .section-desc { color: #94a3b8; font-size: 0.82rem; margin-top: 2px; }

  /* DB Schema */
  .db-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
  .db-table { background: #1e293b; border: 1px solid #334155; border-radius: 12px; overflow: hidden; transition: all 0.2s; }
  .db-table:hover { border-color: #4ade80; box-shadow: 0 0 20px rgba(74,222,128,0.1); }
  .db-table-header { padding: 14px 18px; font-weight: 700; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
  .db-table-header .icon { font-size: 1.1rem; }
  .db-new { background: linear-gradient(135deg, #064e3b, #022c22); border-color: #059669; }
  .db-new .db-table-header { color: #4ade80; }
  .db-existing { background: #1e293b; }
  .db-existing .db-table-header { color: #60a5fa; }
  .db-modified { background: linear-gradient(135deg, #451a03, #2a1000); border-color: #d97706; }
  .db-modified .db-table-header { color: #fbbf24; }

  .db-col { padding: 8px 18px; font-size: 0.78rem; display: flex; align-items: center; gap: 8px; border-top: 1px solid #1a2332; }
  .db-col:hover { background: rgba(255,255,255,0.03); }
  .col-name { font-weight: 600; color: #e2e8f0; min-width: 140px; }
  .col-type { color: #64748b; font-family: monospace; font-size: 0.72rem; }
  .col-pk { color: #fbbf24; font-size: 0.65rem; font-weight: 700; margin-left: auto; }
  .col-fk { color: #60a5fa; font-size: 0.65rem; font-weight: 700; margin-left: auto; }
  .col-new { color: #4ade80; font-size: 0.65rem; font-weight: 700; margin-left: auto; }
  .col-nullable { color: #94a3b8; font-style: italic; }

  /* Relation arrows */
  .relations { background: #0f1729; border: 1px dashed #334155; border-radius: 12px; padding: 20px; margin-top: 20px; }
  .relations h3 { font-size: 0.85rem; color: #94a3b8; margin-bottom: 12px; }
  .relation { font-size: 0.8rem; color: #cbd5e1; padding: 6px 0; display: flex; align-items: center; gap: 8px; }
  .relation .arrow { color: #4ade80; font-weight: 700; }

  /* Plans cards */
  .plans-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
  .plan-card { background: #1e293b; border: 2px solid #334155; border-radius: 16px; padding: 28px; position: relative; overflow: hidden; transition: all 0.2s; }
  .plan-card:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
  .plan-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
  .plan-starter { border-color: #3b82f6; }
  .plan-starter::before { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
  .plan-pro { border-color: #a855f7; }
  .plan-pro::before { background: linear-gradient(90deg, #a855f7, #c084fc); }
  .plan-enterprise { border-color: #f97316; }
  .plan-enterprise::before { background: linear-gradient(90deg, #f97316, #fb923c); }

  .plan-name { font-size: 1.3rem; font-weight: 800; margin-bottom: 4px; }
  .plan-starter .plan-name { color: #60a5fa; }
  .plan-pro .plan-name { color: #c084fc; }
  .plan-enterprise .plan-name { color: #fb923c; }
  .plan-price { font-size: 2rem; font-weight: 800; color: #e2e8f0; }
  .plan-price span { font-size: 0.9rem; color: #64748b; font-weight: 400; }
  .plan-modules { margin-top: 16px; }
  .plan-module { display: flex; align-items: center; gap: 8px; padding: 6px 0; font-size: 0.82rem; }
  .plan-module .check { color: #4ade80; }
  .plan-module .cross { color: #475569; }
  .plan-limit { color: #94a3b8; font-size: 0.72rem; margin-left: auto; }

  /* Flow diagram */
  .flow-section { margin-top: 40px; }
  .flow-vertical { display: flex; flex-direction: column; align-items: center; gap: 0; }
  .flow-step { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 18px 24px; width: 100%; max-width: 800px; display: flex; align-items: flex-start; gap: 16px; position: relative; }
  .flow-step:hover { border-color: #667eea; }
  .step-num { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 0.85rem; flex-shrink: 0; }
  .step-content { flex: 1; }
  .step-title { font-weight: 700; font-size: 0.9rem; margin-bottom: 4px; }
  .step-detail { color: #94a3b8; font-size: 0.78rem; line-height: 1.5; }
  .step-code { background: #0f172a; border: 1px solid #1e293b; border-radius: 6px; padding: 10px 14px; margin-top: 8px; font-family: monospace; font-size: 0.72rem; color: #4ade80; white-space: pre-wrap; overflow-x: auto; }
  .step-tech { display: inline-block; margin-top: 8px; padding: 2px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: 600; text-transform: uppercase; }
  .tech-wf { background: #1e3a5f; color: #60a5fa; }
  .tech-db { background: #1a2e1a; color: #4ade80; }
  .tech-api { background: #3a1a2a; color: #fb7185; }
  .tech-stripe { background: #2d1b4e; color: #a78bfa; }

  .flow-arrow { width: 2px; height: 30px; background: #334155; position: relative; }
  .flow-arrow::after { content: '‚ñº'; position: absolute; bottom: -8px; left: -5px; color: #334155; font-size: 0.7rem; }

  /* Frontend check */
  .frontend-section { margin-top: 40px; }
  .code-block { background: #0f172a; border: 1px solid #1e293b; border-radius: 12px; padding: 20px; font-family: 'Fira Code', monospace; font-size: 0.78rem; line-height: 1.7; overflow-x: auto; }
  .code-comment { color: #475569; }
  .code-keyword { color: #c084fc; }
  .code-string { color: #4ade80; }
  .code-func { color: #60a5fa; }
  .code-var { color: #fbbf24; }
  .code-type { color: #fb7185; }

  /* Upgrade flow */
  .upgrade-grid { display: grid; grid-template-columns: 1fr 80px 1fr; align-items: center; gap: 0; margin-top: 20px; max-width: 700px; margin-left: auto; margin-right: auto; }
  .upgrade-box { background: #1e293b; border-radius: 12px; padding: 18px; text-align: center; }
  .upgrade-arrow { text-align: center; color: #4ade80; font-size: 1.5rem; }
  .upgrade-label { font-size: 0.75rem; color: #94a3b8; margin-top: 4px; }

  /* Divider */
  hr { border: none; border-top: 1px dashed #334155; margin: 50px 0; }

  /* Impact summary */
  .impact-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; }
  .impact-card { background: #1e293b; border-radius: 12px; padding: 20px; border-left: 4px solid; }
  .impact-card h3 { font-size: 0.9rem; margin-bottom: 8px; }
  .impact-card p { font-size: 0.78rem; color: #94a3b8; line-height: 1.5; }
  .impact-card ul { list-style: none; padding: 0; margin-top: 8px; }
  .impact-card li { font-size: 0.78rem; color: #cbd5e1; padding: 3px 0; padding-left: 16px; position: relative; }
  .impact-card li::before { content: '‚Üí'; position: absolute; left: 0; color: #64748b; }
  .impact-bdd { border-color: #4ade80; }
  .impact-bdd h3 { color: #4ade80; }
  .impact-n8n { border-color: #60a5fa; }
  .impact-n8n h3 { color: #60a5fa; }
  .impact-api { border-color: #fb7185; }
  .impact-api h3 { color: #fb7185; }
  .impact-front { border-color: #fbbf24; }
  .impact-front h3 { color: #fbbf24; }

  @media (max-width: 768px) {
    .db-grid { grid-template-columns: 1fr; }
    .plans-grid { grid-template-columns: 1fr; }
    .upgrade-grid { grid-template-columns: 1fr; }
    .upgrade-arrow { transform: rotate(90deg); }
  }
</style>
</head>
<body>
<div class="container">

<h1>üì¶ Architecture Modules & Plans</h1>
<p class="subtitle">Gestion des fonctionnalit√©s par plan d'abonnement ‚Äî Option 2 : Tables relationnelles</p>

<!-- ======================= SECTION 1: BDD ======================= -->
<div class="section">
  <div class="section-header">
    <div class="section-icon" style="background:#064e3b;">üóÑÔ∏è</div>
    <div>
      <div class="section-title">1. Structure Base de Donn√©es</div>
      <div class="section-desc">3 nouvelles tables + 2 tables modifi√©es</div>
    </div>
  </div>

  <div class="db-grid">
    <!-- Table: modules -->
    <div class="db-table db-new">
      <div class="db-table-header"><span class="icon">üÜï</span> modules</div>
      <div class="db-col"><span class="col-name">id</span><span class="col-type">UUID</span><span class="col-pk">PK</span></div>
      <div class="db-col"><span class="col-name">code</span><span class="col-type">VARCHAR UNIQUE</span></div>
      <div class="db-col"><span class="col-name">nom</span><span class="col-type">VARCHAR</span></div>
      <div class="db-col"><span class="col-name">description</span><span class="col-type">TEXT</span></div>
      <div class="db-col"><span class="col-name">icone</span><span class="col-type">VARCHAR</span></div>
      <div class="db-col"><span class="col-name">categorie</span><span class="col-type">VARCHAR</span></div>
      <div class="db-col"><span class="col-name">ordre_affichage</span><span class="col-type">INTEGER</span></div>
      <div class="db-col"><span class="col-name">actif</span><span class="col-type">BOOLEAN</span></div>
      <div class="db-col"><span class="col-name">created_at</span><span class="col-type">TIMESTAMPTZ</span></div>
    </div>

    <!-- Table: plans -->
    <div class="db-table db-new">
      <div class="db-table-header"><span class="icon">üÜï</span> plans</div>
      <div class="db-col"><span class="col-name">id</span><span class="col-type">UUID</span><span class="col-pk">PK</span></div>
      <div class="db-col"><span class="col-name">code</span><span class="col-type">VARCHAR UNIQUE</span></div>
      <div class="db-col"><span class="col-name">nom</span><span class="col-type">VARCHAR</span></div>
      <div class="db-col"><span class="col-name">description</span><span class="col-type">TEXT</span></div>
      <div class="db-col"><span class="col-name">prix_mensuel</span><span class="col-type">DECIMAL(10,2)</span></div>
      <div class="db-col"><span class="col-name">prix_annuel</span><span class="col-type">DECIMAL(10,2)</span><span class="col-nullable">nullable</span></div>
      <div class="db-col"><span class="col-name">stripe_product_id</span><span class="col-type">VARCHAR</span></div>
      <div class="db-col"><span class="col-name">stripe_price_id_mensuel</span><span class="col-type">VARCHAR</span></div>
      <div class="db-col"><span class="col-name">stripe_price_id_annuel</span><span class="col-type">VARCHAR</span><span class="col-nullable">nullable</span></div>
      <div class="db-col"><span class="col-name">essai_jours</span><span class="col-type">INTEGER</span></div>
      <div class="db-col"><span class="col-name">ordre_affichage</span><span class="col-type">INTEGER</span></div>
      <div class="db-col"><span class="col-name">actif</span><span class="col-type">BOOLEAN</span></div>
      <div class="db-col"><span class="col-name">created_at</span><span class="col-type">TIMESTAMPTZ</span></div>
    </div>

    <!-- Table: plan_modules -->
    <div class="db-table db-new">
      <div class="db-table-header"><span class="icon">üÜï</span> plan_modules</div>
      <div class="db-col"><span class="col-name">id</span><span class="col-type">UUID</span><span class="col-pk">PK</span></div>
      <div class="db-col"><span class="col-name">plan_id</span><span class="col-type">UUID</span><span class="col-fk">FK ‚Üí plans</span></div>
      <div class="db-col"><span class="col-name">module_id</span><span class="col-type">UUID</span><span class="col-fk">FK ‚Üí modules</span></div>
      <div class="db-col"><span class="col-name">limite_usage</span><span class="col-type">INTEGER</span><span class="col-nullable">null = illimit√©</span></div>
      <div class="db-col"><span class="col-name">config</span><span class="col-type">JSONB</span><span class="col-nullable">options sp√©cifiques</span></div>
    </div>

    <!-- Table: client_modules (NEW) -->
    <div class="db-table db-new">
      <div class="db-table-header"><span class="icon">üÜï</span> client_modules</div>
      <div class="db-col"><span class="col-name">id</span><span class="col-type">UUID</span><span class="col-pk">PK</span></div>
      <div class="db-col"><span class="col-name">client_final_id</span><span class="col-type">UUID</span><span class="col-fk">FK ‚Üí clients_finaux</span></div>
      <div class="db-col"><span class="col-name">module_id</span><span class="col-type">UUID</span><span class="col-fk">FK ‚Üí modules</span></div>
      <div class="db-col"><span class="col-name">actif</span><span class="col-type">BOOLEAN</span></div>
      <div class="db-col"><span class="col-name">limite_usage</span><span class="col-type">INTEGER</span><span class="col-nullable">h√©rit√© du plan</span></div>
      <div class="db-col"><span class="col-name">usage_actuel</span><span class="col-type">INTEGER DEFAULT 0</span></div>
      <div class="db-col"><span class="col-name">config</span><span class="col-type">JSONB</span><span class="col-nullable">surcharges client</span></div>
      <div class="db-col"><span class="col-name">activated_at</span><span class="col-type">TIMESTAMPTZ</span></div>
      <div class="db-col"><span class="col-name">expires_at</span><span class="col-type">TIMESTAMPTZ</span><span class="col-nullable">nullable</span></div>
    </div>

    <!-- Table: client_subscriptions (MODIFIED) -->
    <div class="db-table db-modified">
      <div class="db-table-header"><span class="icon">‚úèÔ∏è</span> client_subscriptions <small style="color:#fbbf24;margin-left:8px;">(modifi√©e)</small></div>
      <div class="db-col"><span class="col-name">...</span><span class="col-type">colonnes existantes</span></div>
      <div class="db-col" style="background:rgba(251,191,36,0.05);"><span class="col-name">plan_id</span><span class="col-type">UUID</span><span class="col-new">+ NOUVEAU FK ‚Üí plans</span></div>
    </div>
  </div>

  <!-- Relations -->
  <div class="relations">
    <h3>üîó Relations entre les tables</h3>
    <div class="relation">
      <strong>plans</strong> <span class="arrow">‚îÄ‚îÄ1:N‚îÄ‚îÄ‚ñ∂</span> <strong>plan_modules</strong> <span class="arrow">‚óÄ‚îÄ‚îÄN:1‚îÄ‚îÄ</span> <strong>modules</strong>
      <span style="color:#64748b;font-size:0.75rem;margin-left:12px;">Un plan contient N modules</span>
    </div>
    <div class="relation">
      <strong>clients_finaux</strong> <span class="arrow">‚îÄ‚îÄ1:N‚îÄ‚îÄ‚ñ∂</span> <strong>client_modules</strong> <span class="arrow">‚óÄ‚îÄ‚îÄN:1‚îÄ‚îÄ</span> <strong>modules</strong>
      <span style="color:#64748b;font-size:0.75rem;margin-left:12px;">Un client a N modules actifs</span>
    </div>
    <div class="relation">
      <strong>client_subscriptions</strong> <span class="arrow">‚îÄ‚îÄN:1‚îÄ‚îÄ‚ñ∂</span> <strong>plans</strong>
      <span style="color:#64748b;font-size:0.75rem;margin-left:12px;">Chaque abonnement r√©f√©rence un plan</span>
    </div>
  </div>
</div>

<!-- ======================= SECTION 2: PLANS ======================= -->
<div class="section">
  <div class="section-header">
    <div class="section-icon" style="background:#1e3a5f;">üíé</div>
    <div>
      <div class="section-title">2. Exemple de Plans & Modules</div>
      <div class="section-desc">Configuration type des 3 plans avec leurs modules</div>
    </div>
  </div>

  <div class="plans-grid">
    <!-- Starter -->
    <div class="plan-card plan-starter">
      <div class="plan-name">Starter</div>
      <div class="plan-price">29‚Ç¨ <span>/mois</span></div>
      <div class="plan-modules">
        <div class="plan-module"><span class="check">‚úÖ</span> Facturation (devis, factures, avoirs) <span class="plan-limit">illimit√©</span></div>
        <div class="plan-module"><span class="check">‚úÖ</span> Bons de commande <span class="plan-limit">illimit√©</span></div>
        <div class="plan-module"><span class="check">‚úÖ</span> Gestion des articles <span class="plan-limit">illimit√©</span></div>
        <div class="plan-module"><span class="check">‚úÖ</span> Tableau de bord basique <span class="plan-limit">illimit√©</span></div>
        <div class="plan-module"><span class="check">‚úÖ</span> Notifications <span class="plan-limit">illimit√©</span></div>
        <div class="plan-module"><span class="cross">‚ùå</span> <span style="color:#475569;">Comptabilit√©</span></div>
        <div class="plan-module"><span class="cross">‚ùå</span> <span style="color:#475569;">SMS / Appels Twilio</span></div>
        <div class="plan-module"><span class="cross">‚ùå</span> <span style="color:#475569;">Agent IA</span></div>
        <div class="plan-module"><span class="cross">‚ùå</span> <span style="color:#475569;">Gestion des leads</span></div>
      </div>
    </div>

    <!-- Pro -->
    <div class="plan-card plan-pro">
      <div class="plan-name">Pro</div>
      <div class="plan-price">59‚Ç¨ <span>/mois</span></div>
      <div class="plan-modules">
        <div class="plan-module"><span class="check">‚úÖ</span> Facturation (devis, factures, avoirs) <span class="plan-limit">illimit√©</span></div>
        <div class="plan-module"><span class="check">‚úÖ</span> Bons de commande <span class="plan-limit">illimit√©</span></div>
        <div class="plan-module"><span class="check">‚úÖ</span> Gestion des articles <span class="plan-limit">illimit√©</span></div>
        <div class="plan-module"><span class="check">‚úÖ</span> Tableau de bord avanc√© <span class="plan-limit">illimit√©</span></div>
        <div class="plan-module"><span class="check">‚úÖ</span> Notifications <span class="plan-limit">illimit√©</span></div>
        <div class="plan-module"><span class="check">‚úÖ</span> Comptabilit√© compl√®te <span class="plan-limit">illimit√©</span></div>
        <div class="plan-module"><span class="check">‚úÖ</span> SMS / Appels Twilio <span class="plan-limit">100 SMS/mois</span></div>
        <div class="plan-module"><span class="check">‚úÖ</span> Gestion des leads <span class="plan-limit">illimit√©</span></div>
        <div class="plan-module"><span class="cross">‚ùå</span> <span style="color:#475569;">Agent IA</span></div>
      </div>
    </div>

    <!-- Enterprise -->
    <div class="plan-card plan-enterprise">
      <div class="plan-name">Enterprise</div>
      <div class="plan-price">129‚Ç¨ <span>/mois</span></div>
      <div class="plan-modules">
        <div class="plan-module"><span class="check">‚úÖ</span> Facturation (devis, factures, avoirs) <span class="plan-limit">illimit√©</span></div>
        <div class="plan-module"><span class="check">‚úÖ</span> Bons de commande <span class="plan-limit">illimit√©</span></div>
        <div class="plan-module"><span class="check">‚úÖ</span> Gestion des articles <span class="plan-limit">illimit√©</span></div>
        <div class="plan-module"><span class="check">‚úÖ</span> Tableau de bord premium <span class="plan-limit">illimit√©</span></div>
        <div class="plan-module"><span class="check">‚úÖ</span> Notifications <span class="plan-limit">illimit√©</span></div>
        <div class="plan-module"><span class="check">‚úÖ</span> Comptabilit√© compl√®te <span class="plan-limit">illimit√©</span></div>
        <div class="plan-module"><span class="check">‚úÖ</span> SMS / Appels Twilio <span class="plan-limit">illimit√©</span></div>
        <div class="plan-module"><span class="check">‚úÖ</span> Gestion des leads <span class="plan-limit">illimit√©</span></div>
        <div class="plan-module"><span class="check">‚úÖ</span> Agent IA (vocal + chat) <span class="plan-limit">illimit√©</span></div>
      </div>
    </div>
  </div>
</div>

<hr>

<!-- ======================= SECTION 3: FLUX ONBOARDING ======================= -->
<div class="section">
  <div class="section-header">
    <div class="section-icon" style="background:#1a2e1a;">üîÑ</div>
    <div>
      <div class="section-title">3. Flux : Onboarding avec attribution des modules</div>
      <div class="section-desc">Ce qui change dans le workflow client-onboarding</div>
    </div>
  </div>

  <div class="flow-vertical">
    <div class="flow-step">
      <div class="step-num" style="background:#1e3a5f;color:#60a5fa;border:2px solid #3b82f6;">1</div>
      <div class="step-content">
        <div class="step-title">Commercial choisit le plan pour le client</div>
        <div class="step-detail">Le frontend envoie le <strong>plan_id</strong> dans la requ√™te d'onboarding (plus besoin d'envoyer le prix, tout est dans la table plans)</div>
        <div class="step-code">POST /webhook/client-onboarding
{
  "nom": "Dupont SARL",
  "email": "contact@dupont.fr",
  "plan_id": "uuid-du-plan-pro",   ‚Üê NOUVEAU
  "telephone": "+33612345678"
}</div>
        <span class="step-tech tech-api">API / Frontend</span>
      </div>
    </div>
    <div class="flow-arrow"></div>

    <div class="flow-step">
      <div class="step-num" style="background:#064e3b;color:#4ade80;border:2px solid #22c55e;">2</div>
      <div class="step-content">
        <div class="step-title">Workflow r√©cup√®re les infos du plan</div>
        <div class="step-detail">Au lieu de recevoir le prix en param√®tre, le workflow lit tout depuis la table <strong>plans</strong></div>
        <div class="step-code">SELECT p.*, p.stripe_product_id, p.stripe_price_id_mensuel,
       p.prix_mensuel, p.nom as plan_nom, p.essai_jours
FROM plans p WHERE p.id = '{{plan_id}}' AND p.actif = true;</div>
        <span class="step-tech tech-db">Postgres</span>
      </div>
    </div>
    <div class="flow-arrow"></div>

    <div class="flow-step">
      <div class="step-num" style="background:#064e3b;color:#4ade80;border:2px solid #22c55e;">3</div>
      <div class="step-content">
        <div class="step-title">Cr√©er client + subscription avec plan_id</div>
        <div class="step-detail">L'abonnement est li√© au plan. Le <strong>plan_id</strong> est stock√© dans client_subscriptions.</div>
        <div class="step-code">INSERT INTO client_subscriptions (
  ..., plan_id, nom_plan, montant_mensuel, statut
) VALUES (
  ..., '{{plan_id}}', '{{plan_nom}}', {{prix_mensuel}}, 'en_attente'
);</div>
        <span class="step-tech tech-db">Postgres</span>
      </div>
    </div>
    <div class="flow-arrow"></div>

    <div class="flow-step">
      <div class="step-num" style="background:#2d1b4e;color:#c084fc;border:2px solid #a855f7;">4</div>
      <div class="step-content">
        <div class="step-title">Stripe : utiliser les IDs produit/prix du plan</div>
        <div class="step-detail">Plus besoin de cr√©er un produit/prix √† chaque fois ! On utilise ceux d√©j√† configur√©s dans Stripe et r√©f√©renc√©s dans la table plans.</div>
        <div class="step-code">// N≈ìud Checkout Session ‚Äî Utilise les IDs Stripe du plan
{
  "customer": "{{stripe_customer_id}}",
  "line_items": [{
    "price": "{{plan.stripe_price_id_mensuel}}",  ‚Üê depuis BDD
    "quantity": 1
  }],
  "metadata": {
    "clientId": "{{client_id}}",
    "tenantId": "{{tenant_id}}",
    "planId": "{{plan_id}}"         ‚Üê NOUVEAU
  }
}</div>
        <span class="step-tech tech-stripe">Stripe Checkout</span>
      </div>
    </div>
    <div class="flow-arrow"></div>

    <div class="flow-step" style="border-color:#f97316;">
      <div class="step-num" style="background:#3f2a1a;color:#fb923c;border:2px solid #f97316;">5</div>
      <div class="step-content">
        <div class="step-title" style="color:#fb923c;">‚ö° Checkout Completed ‚Üí Attribution des modules</div>
        <div class="step-detail">C'est ici que la magie op√®re. Apr√®s le paiement confirm√©, le workflow lit les modules du plan et les attribue au client.</div>
        <div class="step-code">-- √âtape 5a : R√©cup√©rer les modules du plan
SELECT pm.module_id, pm.limite_usage, pm.config, m.code, m.nom
FROM plan_modules pm
JOIN modules m ON m.id = pm.module_id
WHERE pm.plan_id = '{{planId}}'
AND m.actif = true;

-- √âtape 5b : Ins√©rer les modules pour le client
INSERT INTO client_modules (id, client_final_id, module_id, actif, limite_usage, config, activated_at)
SELECT gen_random_uuid(), '{{clientId}}', pm.module_id, true, pm.limite_usage, pm.config, NOW()
FROM plan_modules pm
JOIN modules m ON m.id = pm.module_id
WHERE pm.plan_id = '{{planId}}'
AND m.actif = true
ON CONFLICT (client_final_id, module_id)
DO UPDATE SET actif = true, limite_usage = EXCLUDED.limite_usage,
              config = EXCLUDED.config, activated_at = NOW();</div>
        <span class="step-tech tech-db">Postgres</span>
      </div>
    </div>
    <div class="flow-arrow"></div>

    <div class="flow-step" style="border-color:#4ade80;">
      <div class="step-num" style="background:#064e3b;color:#4ade80;border:2px solid #22c55e;">6</div>
      <div class="step-content">
        <div class="step-title" style="color:#4ade80;">‚úÖ Client connect√© ‚Üí Frontend v√©rifie ses modules</div>
        <div class="step-detail">√Ä chaque requ√™te, l'API v√©rifie quels modules le client a le droit d'utiliser.</div>
        <div class="step-code">-- API: GET /api/client/:clientId/modules
SELECT m.code, m.nom, m.icone, m.categorie,
       cm.actif, cm.limite_usage, cm.usage_actuel
FROM client_modules cm
JOIN modules m ON m.id = cm.module_id
WHERE cm.client_final_id = '{{clientId}}'
AND cm.actif = true
ORDER BY m.ordre_affichage;

-- R√©sultat ‚Üí Le frontend affiche/masque les menus
‚Üí ["facturation", "bdc", "articles", "dashboard", "comptabilite", "sms", "leads"]</div>
        <span class="step-tech tech-api">API Fastify</span>
      </div>
    </div>
  </div>
</div>

<hr>

<!-- ======================= SECTION 4: UPGRADE/DOWNGRADE ======================= -->
<div class="section">
  <div class="section-header">
    <div class="section-icon" style="background:#451a03;">üîÑ</div>
    <div>
      <div class="section-title">4. Upgrade / Downgrade de plan</div>
      <div class="section-desc">Quand le client change de formule via Stripe</div>
    </div>
  </div>

  <div class="upgrade-grid">
    <div class="upgrade-box" style="border: 2px solid #3b82f6;">
      <div style="font-size:1.5rem;">üì¶</div>
      <div style="font-weight:700;color:#60a5fa;">Starter</div>
      <div style="font-size:0.8rem;color:#94a3b8;">5 modules</div>
    </div>
    <div>
      <div class="upgrade-arrow">‚Üí</div>
      <div class="upgrade-label">Upgrade</div>
    </div>
    <div class="upgrade-box" style="border: 2px solid #a855f7;">
      <div style="font-size:1.5rem;">üíé</div>
      <div style="font-weight:700;color:#c084fc;">Pro</div>
      <div style="font-size:0.8rem;color:#94a3b8;">8 modules</div>
    </div>
  </div>

  <div class="flow-vertical" style="margin-top:30px;">
    <div class="flow-step">
      <div class="step-num" style="background:#2d1b4e;color:#c084fc;border:2px solid #a855f7;">A</div>
      <div class="step-content">
        <div class="step-title">Stripe Event: customer.subscription.updated</div>
        <div class="step-detail">Le workflow <strong>stripe-subscription-updated</strong> d√©tecte un changement de plan via les <code>previous_attributes</code></div>
        <span class="step-tech tech-stripe">Stripe Trigger</span>
      </div>
    </div>
    <div class="flow-arrow"></div>

    <div class="flow-step">
      <div class="step-num" style="background:#064e3b;color:#4ade80;border:2px solid #22c55e;">B</div>
      <div class="step-content">
        <div class="step-title">Identifier le nouveau plan depuis le price_id Stripe</div>
        <div class="step-code">-- Trouver le nouveau plan via le price_id Stripe
SELECT id as new_plan_id, nom, prix_mensuel
FROM plans
WHERE stripe_price_id_mensuel = '{{new_stripe_price_id}}'
   OR stripe_price_id_annuel = '{{new_stripe_price_id}}';</div>
        <span class="step-tech tech-db">Postgres</span>
      </div>
    </div>
    <div class="flow-arrow"></div>

    <div class="flow-step">
      <div class="step-num" style="background:#064e3b;color:#4ade80;border:2px solid #22c55e;">C</div>
      <div class="step-content">
        <div class="step-title">Mettre √† jour le plan_id + recalculer les modules</div>
        <div class="step-code">-- 1. Mettre √† jour l'abonnement
UPDATE client_subscriptions
SET plan_id = '{{new_plan_id}}', nom_plan = '{{new_plan_nom}}',
    montant_mensuel = {{new_prix}}, updated_at = NOW()
WHERE client_final_id = '{{clientId}}';

-- 2. D√©sactiver tous les anciens modules
UPDATE client_modules SET actif = false
WHERE client_final_id = '{{clientId}}';

-- 3. Activer les modules du nouveau plan
INSERT INTO client_modules (id, client_final_id, module_id, actif, limite_usage, config, activated_at)
SELECT gen_random_uuid(), '{{clientId}}', pm.module_id, true, pm.limite_usage, pm.config, NOW()
FROM plan_modules pm
JOIN modules m ON m.id = pm.module_id
WHERE pm.plan_id = '{{new_plan_id}}' AND m.actif = true
ON CONFLICT (client_final_id, module_id)
DO UPDATE SET actif = true, limite_usage = EXCLUDED.limite_usage,
              config = EXCLUDED.config, activated_at = NOW();</div>
        <span class="step-tech tech-db">Postgres</span>
      </div>
    </div>
    <div class="flow-arrow"></div>

    <div class="flow-step" style="border-color:#4ade80;">
      <div class="step-num" style="background:#064e3b;color:#4ade80;border:2px solid #22c55e;">D</div>
      <div class="step-content">
        <div class="step-title" style="color:#4ade80;">‚úÖ Le client voit imm√©diatement ses nouveaux modules</div>
        <div class="step-detail">Au prochain appel API, le frontend r√©cup√®re la liste mise √† jour. Les menus apparaissent/disparaissent automatiquement.</div>
      </div>
    </div>
  </div>
</div>

<hr>

<!-- ======================= SECTION 5: FRONTEND ======================= -->
<div class="section">
  <div class="section-header">
    <div class="section-icon" style="background:#3a1a2a;">üíª</div>
    <div>
      <div class="section-title">5. C√¥t√© Frontend ‚Äî Comment √ßa marche</div>
      <div class="section-desc">V√©rification des modules dans le client Next.js</div>
    </div>
  </div>

  <div class="code-block">
<span class="code-comment">// hooks/useClientModules.ts</span>
<span class="code-keyword">export function</span> <span class="code-func">useClientModules</span>() {
  <span class="code-keyword">const</span> { <span class="code-var">data</span>, <span class="code-var">isLoading</span> } = <span class="code-func">useQuery</span>({
    <span class="code-var">queryKey</span>: [<span class="code-string">'client-modules'</span>],
    <span class="code-var">queryFn</span>: () => <span class="code-func">api.get</span>(<span class="code-string">'/api/client/modules'</span>)
  })

  <span class="code-keyword">const</span> <span class="code-func">hasModule</span> = (<span class="code-var">code</span>: <span class="code-type">string</span>) =>
    <span class="code-var">data</span>?.modules?.some(m => m.code === <span class="code-var">code</span> && m.actif)

  <span class="code-keyword">const</span> <span class="code-func">getModuleLimit</span> = (<span class="code-var">code</span>: <span class="code-type">string</span>) =>
    <span class="code-var">data</span>?.modules?.find(m => m.code === <span class="code-var">code</span>)?.limite_usage ?? <span class="code-keyword">null</span>

  <span class="code-keyword">return</span> { <span class="code-var">modules</span>: <span class="code-var">data</span>?.modules, <span class="code-var">hasModule</span>, <span class="code-var">getModuleLimit</span>, <span class="code-var">isLoading</span> }
}

<span class="code-comment">// Dans le Sidebar / Navigation</span>
<span class="code-keyword">const</span> { <span class="code-var">hasModule</span> } = <span class="code-func">useClientModules</span>()

{<span class="code-func">hasModule</span>(<span class="code-string">'comptabilite'</span>) && <span class="code-keyword">&lt;</span><span class="code-type">NavItem</span> href=<span class="code-string">"/comptabilite"</span><span class="code-keyword"> /&gt;</span>}
{<span class="code-func">hasModule</span>(<span class="code-string">'sms'</span>)           && <span class="code-keyword">&lt;</span><span class="code-type">NavItem</span> href=<span class="code-string">"/sms"</span><span class="code-keyword"> /&gt;</span>}
{<span class="code-func">hasModule</span>(<span class="code-string">'ia_agent'</span>)      && <span class="code-keyword">&lt;</span><span class="code-type">NavItem</span> href=<span class="code-string">"/agent-ia"</span><span class="code-keyword"> /&gt;</span>}
{<span class="code-func">hasModule</span>(<span class="code-string">'leads'</span>)         && <span class="code-keyword">&lt;</span><span class="code-type">NavItem</span> href=<span class="code-string">"/leads"</span><span class="code-keyword"> /&gt;</span>}

<span class="code-comment">// Protection c√¥t√© API aussi (middleware)</span>
<span class="code-keyword">const</span> <span class="code-func">requireModule</span> = (<span class="code-var">moduleCode</span>: <span class="code-type">string</span>) => {
  <span class="code-keyword">return async</span> (<span class="code-var">req</span>, <span class="code-var">reply</span>) => {
    <span class="code-keyword">const</span> <span class="code-var">modules</span> = <span class="code-keyword">await</span> <span class="code-func">getClientModules</span>(<span class="code-var">req</span>.tenantId)
    <span class="code-keyword">if</span> (!<span class="code-var">modules</span>.find(m => m.code === <span class="code-var">moduleCode</span> && m.actif)) {
      <span class="code-keyword">return</span> <span class="code-var">reply</span>.status(403).send({
        error: <span class="code-string">'Module non disponible dans votre plan'</span>
      })
    }
  }
}

<span class="code-comment">// Utilisation dans les routes</span>
<span class="code-var">app</span>.<span class="code-func">get</span>(<span class="code-string">'/api/comptabilite/*'</span>, { preHandler: <span class="code-func">requireModule</span>(<span class="code-string">'comptabilite'</span>) })
<span class="code-var">app</span>.<span class="code-func">get</span>(<span class="code-string">'/api/sms/*'</span>,          { preHandler: <span class="code-func">requireModule</span>(<span class="code-string">'sms'</span>) })
<span class="code-var">app</span>.<span class="code-func">get</span>(<span class="code-string">'/api/agent-ia/*'</span>,     { preHandler: <span class="code-func">requireModule</span>(<span class="code-string">'ia_agent'</span>) })
  </div>
</div>

<hr>

<!-- ======================= SECTION 6: R√âSUM√â IMPACT ======================= -->
<div class="section">
  <div class="section-header">
    <div class="section-icon" style="background:#1e293b;">üìã</div>
    <div>
      <div class="section-title">6. R√©sum√© des modifications √† faire</div>
      <div class="section-desc">Tout ce qu'il faut cr√©er / modifier pour impl√©menter cette architecture</div>
    </div>
  </div>

  <div class="impact-grid">
    <div class="impact-card impact-bdd">
      <h3>üóÑÔ∏è Base de donn√©es</h3>
      <ul>
        <li>Cr√©er table <strong>modules</strong></li>
        <li>Cr√©er table <strong>plans</strong></li>
        <li>Cr√©er table <strong>plan_modules</strong></li>
        <li>Cr√©er table <strong>client_modules</strong></li>
        <li>Ajouter <strong>plan_id</strong> √† client_subscriptions</li>
        <li>Seed : ins√©rer les modules et plans initiaux</li>
        <li>Prisma schema + db push</li>
      </ul>
    </div>

    <div class="impact-card impact-n8n">
      <h3>‚ö° Workflows n8n</h3>
      <ul>
        <li>Modifier <strong>client-onboarding</strong> : lire plan depuis BDD au lieu de params</li>
        <li>Modifier <strong>checkout-completed</strong> : ajouter INSERT client_modules</li>
        <li>Modifier <strong>subscription-updated</strong> : recalculer modules si changement de plan</li>
        <li>Modifier <strong>subscription-deleted</strong> : d√©sactiver tous les client_modules</li>
      </ul>
    </div>

    <div class="impact-card impact-api">
      <h3>üîå API Fastify</h3>
      <ul>
        <li>Nouveau endpoint <strong>GET /api/client/modules</strong></li>
        <li>Nouveau endpoint <strong>GET /api/plans</strong> (liste des plans)</li>
        <li>Nouveau middleware <strong>requireModule()</strong></li>
        <li>Prot√©ger les routes existantes par module</li>
      </ul>
    </div>

    <div class="impact-card impact-front">
      <h3>üñ•Ô∏è Frontend Next.js</h3>
      <ul>
        <li>Hook <strong>useClientModules()</strong></li>
        <li>Modifier le <strong>Sidebar</strong> : afficher/masquer les menus</li>
        <li>Page <strong>pricing/plans</strong> : afficher les plans disponibles</li>
        <li>Composant <strong>UpgradeBanner</strong> si module non disponible</li>
      </ul>
    </div>
  </div>
</div>

<p style="text-align:center; color:#475569; font-size:0.75rem; margin-top:40px;">TalosPrimes ‚Äî Architecture Modules & Plans (Option 2) ‚Äî F√©vrier 2026</p>

</div>
</body>
</html>
